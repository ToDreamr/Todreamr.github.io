<!DOCTYPE html>
<html lang="zh-CN" dir="ltr" class="scroll-smooth" data-default-appearance="dark"
  data-auto-appearance="true"><head>

  <meta charset="utf-8" />
  
  <meta http-equiv="content-language" content="zh-CN" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>SpringCloud 3 &middot; 春江花朝秋月夜</title>
  <meta name="title" content="SpringCloud 3 &middot; 春江花朝秋月夜" />
  
  <meta name="description" content="A powerful, lightweight theme for Hugo built with Tailwind CSS." />
  
  
  
  <link rel="canonical" href="/doc/cloud/%E4%BA%8C/" />
  
  
  
  
  
  
  
  
  
  
  <link type="text/css" rel="stylesheet" href="/css/main.bundle.min.ac59a1b8eaafef739c129d12787ac29f6a420bcb348c7aeec8949a8d0b7d6c2023766c169d14b9031b751504eb3c976efe786fec135b340a49868acd8caa4127.css"
    integrity="sha512-rFmhuOqv73OcEp0SeHrCn2pCC8s0jHruyJSajQt9bCAjdmwWnRS5Axt1FQTrPJdu/nhv7BNbNApJhorNjKpBJw==" />
  
  
  <script type="text/javascript" src="/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js"
    integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj&#43;e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script>
  
  
  
  
  
  
  
  
  
  
  
  
  <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.b08c533d390e8a0f23aec728c42c75cd20d5647891674e96b16374298da81849d9cc269102ec8558979f8bdae7563d3c83bce1fe3f5796d64edfb400aac4576f.js"
    integrity="sha512-sIxTPTkOig8jrscoxCx1zSDVZHiRZ06WsWN0KY2oGEnZzCaRAuyFWJefi9rnVj08g7zh/j9XltZO37QAqsRXbw==" data-copy="" data-copied=""></script>
  
  
  <script src="/js/zoom.min.js"></script>
  
  
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  <meta property="og:title" content="SpringCloud 3" />
<meta property="og:description" content="微服务应用 #前面我们已经完成了SpringCloudAlibaba的学习，我们对一个微服务项目的架构体系已经有了一定的了解，那么本章我们将在应用层面继续探讨微服务。
分布式权限校验 #虽然完成前面的部分，我们已经可以自己去编写一个比较中规中矩的微服务项目了，但是还有一个问题我们没有解决，登录问题。假如现在要求用户登录之后，才能进行图书的查询、借阅等操作，那么我们又该如何设计这个系统呢？
回顾我们之前进行权限校验的原理，服务器是如何判定一个请求是来自哪个用户的呢？
首先浏览器会向服务端发送请求，访问我们的网站。 服务端收到请求后，会创建一个SESSION ID，并暂时存储在服务端，然后会发送给浏览器作为Cookie保存。 之后浏览器会一直携带此Cookie访问服务器，这样在收到请求后，就能根据携带的Cookie中的SESSION ID判断是哪个用户了。 这样服务端和浏览器之间可以轻松地建立会话了。 但是我们想一下，我们现在采用的是分布式的系统，那么在用户服务进行登录之后，其他服务比如图书服务和借阅服务，它们会知道用户登录了吗？
实际上我们登录到用户服务之后，Session中的用户数据只会在用户服务的应用中保存，而在其他服务中，并没有对应的信息，但是我们现在希望的是，所有的服务都能够同步这些Session信息，这样我们才能实现在用户服务登录之后其他服务都能知道，那么我们该如何实现Session的同步呢？
我们可以在每台服务器上都复制一份Session，但是这样显然是很浪费时间的，并且用户验证数据占用的内存会成倍的增加。 将Session移出服务器，用统一存储来存放，比如我们可以直接在Redis或是MySQL中存放用户的Session信息，这样所有的服务器在需要获取Session信息时，统一访问Redis或是MySQL即可，这样就能保证所有服务都可以同步Session了（是不是越来越感觉只要有问题，没有什么是加一个中间件解决不了的） 那么，我们就着重来研究一下，然后实现2号方案，这里我们就使用Redis作为Session统一存储，我们把一开始的压缩包重新解压一次，又来从头开始编写吧。
这里我们就只使用Nacos就行了，和之前一样，我们把Nacos的包导入一下，然后进行一些配置：
现在我们需要为每个服务都添加验证机制，首先导入依赖：
&lt;!-- SpringSession Redis支持 --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.session&lt;/groupId&gt; &lt;artifactId&gt;spring-session-data-redis&lt;/artifactId&gt; &lt;/dependency&gt; &lt;!-- 添加Redis的Starter --&gt; &lt;dependency&gt; &lt;groupId&gt;org." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/doc/cloud/%E4%BA%8C/" /><meta property="og:image" content="/doc/cloud/%E4%BA%8C/featured.jpeg"/><meta property="article:section" content="doc" />


<meta property="og:see_also" content="/doc/cloud/%E4%B8%80/" /><meta property="og:see_also" content="/doc/cloud/%E4%B8%89/" />


  <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="/doc/cloud/%E4%BA%8C/featured.jpeg"/>
<meta name="twitter:title" content="SpringCloud 3"/>
<meta name="twitter:description" content="微服务应用 #前面我们已经完成了SpringCloudAlibaba的学习，我们对一个微服务项目的架构体系已经有了一定的了解，那么本章我们将在应用层面继续探讨微服务。
分布式权限校验 #虽然完成前面的部分，我们已经可以自己去编写一个比较中规中矩的微服务项目了，但是还有一个问题我们没有解决，登录问题。假如现在要求用户登录之后，才能进行图书的查询、借阅等操作，那么我们又该如何设计这个系统呢？
回顾我们之前进行权限校验的原理，服务器是如何判定一个请求是来自哪个用户的呢？
首先浏览器会向服务端发送请求，访问我们的网站。 服务端收到请求后，会创建一个SESSION ID，并暂时存储在服务端，然后会发送给浏览器作为Cookie保存。 之后浏览器会一直携带此Cookie访问服务器，这样在收到请求后，就能根据携带的Cookie中的SESSION ID判断是哪个用户了。 这样服务端和浏览器之间可以轻松地建立会话了。 但是我们想一下，我们现在采用的是分布式的系统，那么在用户服务进行登录之后，其他服务比如图书服务和借阅服务，它们会知道用户登录了吗？
实际上我们登录到用户服务之后，Session中的用户数据只会在用户服务的应用中保存，而在其他服务中，并没有对应的信息，但是我们现在希望的是，所有的服务都能够同步这些Session信息，这样我们才能实现在用户服务登录之后其他服务都能知道，那么我们该如何实现Session的同步呢？
我们可以在每台服务器上都复制一份Session，但是这样显然是很浪费时间的，并且用户验证数据占用的内存会成倍的增加。 将Session移出服务器，用统一存储来存放，比如我们可以直接在Redis或是MySQL中存放用户的Session信息，这样所有的服务器在需要获取Session信息时，统一访问Redis或是MySQL即可，这样就能保证所有服务都可以同步Session了（是不是越来越感觉只要有问题，没有什么是加一个中间件解决不了的） 那么，我们就着重来研究一下，然后实现2号方案，这里我们就使用Redis作为Session统一存储，我们把一开始的压缩包重新解压一次，又来从头开始编写吧。
这里我们就只使用Nacos就行了，和之前一样，我们把Nacos的包导入一下，然后进行一些配置：
现在我们需要为每个服务都添加验证机制，首先导入依赖：
&lt;!-- SpringSession Redis支持 --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.session&lt;/groupId&gt; &lt;artifactId&gt;spring-session-data-redis&lt;/artifactId&gt; &lt;/dependency&gt; &lt;!-- 添加Redis的Starter --&gt; &lt;dependency&gt; &lt;groupId&gt;org."/>

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Docs",
    "name": "SpringCloud 3",
    "headline": "SpringCloud 3",
    
    "abstract": "微服务应用 #\r前面我们已经完成了SpringCloudAlibaba的学习，我们对一个微服务项目的架构体系已经有了一定的了解，那么本章我们将在应用层面继续探讨微服务。\n分布式权限校验 #\r虽然完成前面的部分，我们已经可以自己去编写一个比较中规中矩的微服务项目了，但是还有一个问题我们没有解决，登录问题。假如现在要求用户登录之后，才能进行图书的查询、借阅等操作，那么我们又该如何设计这个系统呢？\n回顾我们之前进行权限校验的原理，服务器是如何判定一个请求是来自哪个用户的呢？\n首先浏览器会向服务端发送请求，访问我们的网站。 服务端收到请求后，会创建一个SESSION ID，并暂时存储在服务端，然后会发送给浏览器作为Cookie保存。 之后浏览器会一直携带此Cookie访问服务器，这样在收到请求后，就能根据携带的Cookie中的SESSION ID判断是哪个用户了。 这样服务端和浏览器之间可以轻松地建立会话了。 但是我们想一下，我们现在采用的是分布式的系统，那么在用户服务进行登录之后，其他服务比如图书服务和借阅服务，它们会知道用户登录了吗？\n实际上我们登录到用户服务之后，Session中的用户数据只会在用户服务的应用中保存，而在其他服务中，并没有对应的信息，但是我们现在希望的是，所有的服务都能够同步这些Session信息，这样我们才能实现在用户服务登录之后其他服务都能知道，那么我们该如何实现Session的同步呢？\n我们可以在每台服务器上都复制一份Session，但是这样显然是很浪费时间的，并且用户验证数据占用的内存会成倍的增加。 将Session移出服务器，用统一存储来存放，比如我们可以直接在Redis或是MySQL中存放用户的Session信息，这样所有的服务器在需要获取Session信息时，统一访问Redis或是MySQL即可，这样就能保证所有服务都可以同步Session了（是不是越来越感觉只要有问题，没有什么是加一个中间件解决不了的） 那么，我们就着重来研究一下，然后实现2号方案，这里我们就使用Redis作为Session统一存储，我们把一开始的压缩包重新解压一次，又来从头开始编写吧。\n这里我们就只使用Nacos就行了，和之前一样，我们把Nacos的包导入一下，然后进行一些配置：\n现在我们需要为每个服务都添加验证机制，首先导入依赖：\n\u0026lt;!-- SpringSession Redis支持 --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.session\u0026lt;\/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-session-data-redis\u0026lt;\/artifactId\u0026gt; \u0026lt;\/dependency\u0026gt; \u0026lt;!-- 添加Redis的Starter --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.",
    "inLanguage": "zh-CN",
    "url" : "\/doc\/cloud\/%E4%BA%8C\/",
    "author" : {
      "@type": "Person",
      "name": "春江花朝秋月夜"
    },
    
    
    
    
    
    
    
    
    "mainEntityOfPage": "true",
    "wordCount": "2108"
  }]
  </script>


  
  
  <meta name="author" content="春江花朝秋月夜" />
  
  
  
  <link href="https://space.bilibili.com/159283119?spm_id_from=333.1007.0.0" rel="me" />
  
  
  <link href="https://github.com/ToDreamr" rel="me" />
  
  
  <link href="https://music.163.com/#/user/home?id=568083850" rel="me" />
  
  
  <link href="https://gitee.com/rainyheights" rel="me" />
  
  
  <link href="https://www.zhihu.com/people/san-qiu-luo-yue" rel="me" />
  
  
  
  

<script src="/lib/jquery/jquery.slim.min.js" integrity=""></script>





















  
  

<script async src="https://www.googletagmanager.com/gtag/js?id=G-PEDMYR1V0K"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-PEDMYR1V0K');
</script>


  
  
  <meta name="theme-color"/>

  
  

  
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <meta name="referrer" content="no-referrer-when-downgrade"></head>


<body
  class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32">
  <div id="the-top" class="absolute flex self-center">
    <a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
      href="#main-content"><span
        class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>跳到文章开头</a>
  </div>
  
  
  <div class="min-h-[148px]"></div>
<div class="fixed inset-x-0 pl-[24px] pr-[24px]" style="z-index:100">
  <div id="menu-blur" class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl"></div>
  <div class="relative max-w-[64rem] ml-auto mr-auto">
    <div id="top-menu" style="padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px ;height: 70px;font-family: 华文中宋,serif;"
     class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3" >
  
  
  
  <div>
    <a href="/" class="flex">
    <span class="sr-only">春江花朝秋月夜</span>

    <img src="/img/author.png" width="16" height="16"
         class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt="春江花朝秋月夜" />

    </a>
  </div>
  

  <div class="flex flex-1 items-center justify-between">

    <nav class="flex space-x-3">

      
      <a id="title-href" href="/" class="text-base font-medium text-gray-500 hover:text-gray-900">春江花朝秋月夜</a>
      

    </nav>
    <nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12">

      
      
      
  <a href="/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        首页
    </p>
</a>


      
      
  <a href="/all/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="全部">
        全部✅
    </p>
</a>


      
      
  <a href="/algorithm/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="Algorithms">
        算法🐾
    </p>
</a>


      
      
  <a href="/tags/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="Tags">
        归类✈️
    </p>
</a>


      
      
  <a href="/friend/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="friend">
        友链🧑‍🤝‍🧑
    </p>
</a>


      
      
  <a href="/doc/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="Docs">
        文档😺
    </p>
</a>


      
      

      


      
      <button id="search-button" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400 h-12"
              title="">
      

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


      </button>

      


      
      
      <div
              class="ltr:mr-14 rtl:ml-14 cursor-pointer text-sm text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400">
        <button id="appearance-switcher" aria-label="Dark mode switcher" type="button">
          <div class="flex items-center justify-center h-12 dark:hidden">
            

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


          </div>
          <div class="items-center justify-center hidden h-12 dark:flex">
            

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


          </div>
        </button>

      </div>
      

    </nav>
    <div class="flex md:hidden items-center space-x-5 md:ml-12">

      <span></span>

      


      
      <button id="search-button-mobile" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
              title="">
      

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


      </button>
      

      
      
      <button id="appearance-switcher-mobile" aria-label="Dark mode switcher" type="button" style="margin-right:5px">
        <div class="flex items-center justify-center h-12 dark:hidden">
          

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


        </div>
        <div class="items-center justify-center hidden h-12 dark:flex">
          

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


        </div>
      </button>
      

    </div>

  </div>
  <div class="-my-2 -mr-2 md:hidden">

    <label id="menu-button" for="menu-controller" class="block">
      <input type="checkbox" id="menu-controller" class="hidden" />
      
      <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>

  </span>


      </div>
      <div id="menu-wrapper" style="padding-top:5px;"
           class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50">
        <ul
                class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl">

          <li>
                        <span
                                class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>

</span>
          </li>

          

          
  <li class="mt-1">
    <a href="/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            首页
        </p>
    </a>
</li>



          

          
  <li class="mt-1">
    <a href="/all/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="全部">
            全部✅
        </p>
    </a>
</li>



          

          
  <li class="mt-1">
    <a href="/algorithm/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="Algorithms">
            算法🐾
        </p>
    </a>
</li>



          

          
  <li class="mt-1">
    <a href="/tags/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="Tags">
            归类✈️
        </p>
    </a>
</li>



          

          
  <li class="mt-1">
    <a href="/friend/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="friend">
            友链🧑‍🤝‍🧑
        </p>
    </a>
</li>



          

          
  <li class="mt-1">
    <a href="/doc/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="Docs">
            文档😺
        </p>
    </a>
</li>



          

        </ul>
        
        

      </div>
    </label>
  </div>






  </div>
<style>
  .change-music{
    margin-top: 20px;
    width: 8%;
    height: 50%;
    font-family: 华文中宋,serif;
     
     
     
  }
</style>
<script>
  
  var MusicLists=[];
  var musicUrl="";
  function getMusicList()
  {
    
    MusicLists.push
    (29567192,1974443814,447926067,447925058,1974444808,
            1974444807,29567187
    );
    var musicIndex=Math.floor(Math.random()*MusicLists.length+1);
    console.log(musicIndex);
    
    musicUrl="https://music.163.com/outchain/player?type=2&id="+MusicLists[musicIndex]+"&auto=1&height=66";
    var frame=document.getElementById("music");
    var player=document.getElementsByName('player');
    console.log(player);
    frame.src=musicUrl;
  }
</script>






<script>
  (function () {
    var $mainmenu = $('.main-menu');
    var path = window.location.pathname;
    $mainmenu.find('a[href="' + path + '"]').each(function (i, e) {
      $(e).children('p').addClass('active');
    });
  })();
  
  (function (){
    var title=document.getElementById('title-href');
    var music=document.getElementById('music');
    var button=document.getElementById('music-button');
    var width=window.innerWidth;
    var height=window.innerHeight;
    if (width<420||height<820){
      title.innerText='Rainy-Heights'
      button.innerText='';
      music.style.width=0;
      music.style.height=0;
      button.style.height=0;
      button.style.height=0;
      var child = document.getElementById('music-div');
      var father = document.getElementById('top-menu');
      father.removeChild(child)
      father.removeChild(button)
    }
  })();
</script>


  </div>
</div>
<script>
  window.addEventListener('scroll', function (e) {
    var scroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
    var background_blur = document.getElementById('menu-blur');
    background_blur.style.opacity = (scroll / 300);
  });
</script>

  
  <div class="relative flex flex-col grow">
    <main id="main-content" class="grow">
      


<article>
  
  
  
  
  
  


<div id="hero" class="h-[150px] md:h-[200px]"></div>



    
    <div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom"
    style="background-image:url(/doc/cloud/%E4%BA%8C/featured_hu7abcaa5e0ae44b563635c1e97a6d7c3c_740393_1200x0_resize_q75_box.jpeg);">
    


    <div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal">
    </div>
    <div
        class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal">
    </div>
</div>

<div id="background-blur" class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div>
<script>
    window.addEventListener('scroll', function (e) {
        var scroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
        var background_blur = document.getElementById('background-blur');
        background_blur.style.opacity = (scroll / 300)
    });
</script>

  
  

  <header id="single_header" class="mt-5 max-w-prose">
    
    <ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden">
  
  
    
  
    
  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/"
      ></a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline ">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/doc/"
      >Docs</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/doc/cloud/%E4%BA%8C/"
      >SpringCloud 3</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

</ol>


    
    <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
      SpringCloud 3
    </h1>
    <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
      





  
  







  







  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="0001-01-01 00:00:00 &#43;0000 UTC">1 January 0001</time><span class="px-2 text-primary-500">&middot;</span><span title="预计阅读">10 分钟</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
  
  
</div>



    </div>

    
    
    
    
    

    

    
      
      
        
        
<div class="flex author">
  
    
    
      
    
    
      
        
      
      <img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width="96" height="96"
      alt="春江花朝秋月夜" src="/img/%E4%B8%89%E5%8F%B6_huefd8a5d2e6c0b8ff3aa6580d0e50af5a_1328716_192x192_fill_box_center_3.png" />
    
  
  <div class="place-self-center">
    
    <div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">
      作者
    </div>
    <div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">
      春江花朝秋月夜
    </div>
    
    
    <div class="text-sm text-neutral-700 dark:text-neutral-400">重湖叠𪩘清嘉。有三秋桂子，十里荷花。羌管弄晴，菱歌泛夜，嬉嬉钓叟莲娃。千骑拥高牙。乘醉听箫鼓，吟赏烟霞。异日图将好景，归去凤池夸。</div>
    
    <div class="text-2xl sm:text-lg">
  <div class="flex flex-wrap text-neutral-400 dark:text-neutral-500">
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://space.bilibili.com/159283119?spm_id_from=333.1007.0.0"
          target="_blank"
          aria-label="Bilibili"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1699377062375" class="icon" viewBox="0 0 1129 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4167" xmlns:xlink="http://www.w3.org/1999/xlink" width="220.5078125" height="200"><path d="M234.909 9.656a80.468 80.468 0 0 1 68.398 0 167.374 167.374 0 0 1 41.843 30.578l160.937 140.82h115.07l160.936-140.82a168.983 168.983 0 0 1 41.843-30.578A80.468 80.468 0 0 1 930.96 76.445a80.468 80.468 0 0 1-17.703 53.914 449.818 449.818 0 0 1-35.406 32.187 232.553 232.553 0 0 1-22.531 18.508h100.585a170.593 170.593 0 0 1 118.289 53.109 171.397 171.397 0 0 1 53.914 118.288v462.693a325.897 325.897 0 0 1-4.024 70.007 178.64 178.64 0 0 1-80.468 112.656 173.007 173.007 0 0 1-92.539 25.75h-738.7a341.186 341.186 0 0 1-72.421-4.024A177.835 177.835 0 0 1 28.91 939.065a172.202 172.202 0 0 1-27.36-92.539V388.662a360.498 360.498 0 0 1 0-66.789A177.03 177.03 0 0 1 162.487 178.64h105.414c-16.899-12.07-31.383-26.555-46.672-39.43a80.468 80.468 0 0 1-25.75-65.984 80.468 80.468 0 0 1 39.43-63.57M216.4 321.873a80.468 80.468 0 0 0-63.57 57.937 108.632 108.632 0 0 0 0 30.578v380.615a80.468 80.468 0 0 0 55.523 80.469 106.218 106.218 0 0 0 34.601 5.632h654.208a80.468 80.468 0 0 0 76.444-47.476 112.656 112.656 0 0 0 8.047-53.109v-354.06a135.187 135.187 0 0 0 0-38.625 80.468 80.468 0 0 0-52.304-54.719 129.554 129.554 0 0 0-49.89-7.242H254.22a268.764 268.764 0 0 0-37.82 0z m0 0" fill="#20B0E3" p-id="4168"></path><path d="M348.369 447.404a80.468 80.468 0 0 1 55.523 18.507 80.468 80.468 0 0 1 28.164 59.547v80.468a80.468 80.468 0 0 1-16.094 51.5 80.468 80.468 0 0 1-131.968-9.656 104.609 104.609 0 0 1-10.46-54.719v-80.468a80.468 80.468 0 0 1 70.007-67.593z m416.02 0a80.468 80.468 0 0 1 86.102 75.64v80.468a94.148 94.148 0 0 1-12.07 53.11 80.468 80.468 0 0 1-132.773 0 95.757 95.757 0 0 1-12.875-57.133V519.02a80.468 80.468 0 0 1 70.007-70.812z m0 0" fill="#20B0E3" p-id="4169"></path></svg>
  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://github.com/ToDreamr"
          target="_blank"
          aria-label="Github"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://music.163.com/#/user/home?id=568083850"
          target="_blank"
          aria-label="Wangyi"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1707154946293" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2586" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M0 0m184.32 0l655.36 0q184.32 0 184.32 184.32l0 655.36q0 184.32-184.32 184.32l-655.36 0q-184.32 0-184.32-184.32l0-655.36q0-184.32 184.32-184.32Z" fill="#EA3E3C" p-id="2587"></path><path d="M527.616 849.43872a373.6064 373.6064 0 0 1-162.54976-39.00416c-112.36352-55.16288-180.00896-176.29184-172.55424-308.67456 7.41376-130.34496 85.10464-237.4656 202.752-279.552a35.85024 35.85024 0 0 1 24.15616 67.51232c-107.66336 38.49216-150.81472 136.86784-155.29984 216.13568-5.86752 103.51616 46.08 197.79584 132.34176 240.13824 124.69248 60.30336 216.91392 22.35392 260.82304-5.64224 59.8016-38.16448 97.86368-100.01408 96.95232-157.55264-1.024-63.72352-24.064-120.99584-63.27296-157.14304a145.408 145.408 0 0 0-65.5872-35.28704q2.82624 9.76896 5.64224 19.32288c13.38368 45.63968 24.94464 85.05344 25.6 114.40128a134.26688 134.26688 0 0 1-37.69344 97.76128 139.1104 139.1104 0 0 1-100.6592 40.45824 140.10368 140.10368 0 0 1-100.47488-42.24 169.12384 169.12384 0 0 1-46.2848-122.76736c1.19808-85.12512 80.11776-153.28256 162.816-175.104a324.80256 324.80256 0 0 1-6.71744-67.05152 92.0576 92.0576 0 0 1 69.18144-91.81184c46.21312-12.53376 104.448 5.19168 124.66176 37.888a35.84 35.84 0 0 1-11.70432 49.31584 35.84 35.84 0 0 1-49.26464-11.65312 62.34112 62.34112 0 0 0-48.45568-5.21216c-4.32128 1.71008-12.35968 4.90496-12.76928 23.10144a270.87872 270.87872 0 0 0 6.73792 58.51136 217.4976 217.4976 0 0 1 133.56032 57.6512c53.57568 49.38752 85.0432 125.46048 86.35392 208.71168 1.29024 81.85856-49.7664 167.86432-130.048 219.136a310.14912 310.14912 0 0 1-168.2432 48.65024z m23.6544-457.55392c-56.77056 15.6672-107.4688 63.03744-108.07296 106.42432a98.304 98.304 0 0 0 25.6512 71.43424 68.0448 68.0448 0 0 0 49.36704 20.87936 67.24608 67.24608 0 0 0 49.44896-18.944 63.19104 63.19104 0 0 0 17.23392-46.08c-0.4096-19.79392-11.7248-58.368-22.67136-95.6928-3.61472-12.42112-7.35232-25.14944-10.9568-38.02112z" fill="#FFFFFF" p-id="2588"></path></svg>
  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://gitee.com/rainyheights"
          target="_blank"
          aria-label="Gitee"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1707288792446" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6333" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M512 1024C230.4 1024 0 793.6 0 512S230.4 0 512 0s512 230.4 512 512-230.4 512-512 512z m259.2-569.6H480c-12.8 0-25.6 12.8-25.6 25.6v64c0 12.8 12.8 25.6 25.6 25.6h176c12.8 0 25.6 12.8 25.6 25.6V608c0 41.6-35.2 76.8-76.8 76.8h-240c-12.8 0-25.6-12.8-25.6-25.6V416c0-41.6 35.2-76.8 76.8-76.8h355.2c12.8 0 25.6-12.8 25.6-25.6v-64c0-12.8-12.8-25.6-25.6-25.6H416c-105.6 0-188.8 86.4-188.8 188.8V768c0 12.8 12.8 25.6 25.6 25.6h374.4c92.8 0 169.6-76.8 169.6-169.6V480c0-12.8-12.8-25.6-25.6-25.6z" fill="#888888" p-id="6334"></path></svg>
  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://www.zhihu.com/people/san-qiu-luo-yue"
          target="_blank"
          aria-label="Zhihu"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1707288662942" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5244" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M564.7 230.1V803h60l25.2 71.4L756.3 803h131.5V230.1H564.7z m247.7 497h-59.9l-75.1 50.4-17.8-50.4h-18V308.3h170.7v418.8zM526.1 486.9H393.3c2.1-44.9 4.3-104.3 6.6-172.9h130.9l-0.1-8.1c0-0.6-0.2-14.7-2.3-29.1-2.1-15-6.6-34.9-21-34.9H287.8c4.4-20.6 15.7-69.7 29.4-93.8l6.4-11.2-12.9-0.7c-0.8 0-19.6-0.9-41.4 10.6-35.7 19-51.7 56.4-58.7 84.4-18.4 73.1-44.6 123.9-55.7 145.6-3.3 6.4-5.3 10.2-6.2 12.8-1.8 4.9-0.8 9.8 2.8 13 10.5 9.5 38.2-2.9 38.5-3 0.6-0.3 1.3-0.6 2.2-1 13.9-6.3 55.1-25 69.8-84.5h56.7c0.7 32.2 3.1 138.4 2.9 172.9h-141l-2.1 1.5c-23.1 16.9-30.5 63.2-30.8 65.2l-1.4 9.2h167c-12.3 78.3-26.5 113.4-34 127.4-3.7 7-7.3 14-10.7 20.8-21.3 42.2-43.4 85.8-126.3 153.6-3.6 2.8-7 8-4.8 13.7 2.4 6.3 9.3 9.1 24.6 9.1 5.4 0 11.8-0.3 19.4-1 49.9-4.4 100.8-18 135.1-87.6 17-35.1 31.7-71.7 43.9-108.9L497 850l5-12c0.8-1.9 19-46.3 5.1-95.9l-0.5-1.8-108.1-123-22 16.6c6.4-26.1 10.6-49.9 12.5-71.1h158.7v-8c0-40.1-18.5-63.9-19.2-64.9l-2.4-3z" fill="#1296DB" p-id="5245"></path></svg>
  </span>

</span></a
        >
      
    
  </div>

</div>
  </div>
</div>

      

      

      
      <div class="mb-5"></div>
      

    

  </header>
  
  <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
    
     <div
      class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8">
      <div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-[140px]">

         <details open class="toc-right mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    目录
  </summary>
  <div
    class="min-w-[220px] py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#微服务应用">微服务应用</a>
      <ul>
        <li><a href="#分布式权限校验">分布式权限校验</a></li>
        <li><a href="#oauth-20-实现单点登录">OAuth 2.0 实现单点登录</a>
          <ul>
            <li><a href="#四种授权模式">四种授权模式</a></li>
            <li><a href="#搭建验证服务器">搭建验证服务器</a></li>
            <li><a href="#基于enableoauth2sso实现">基于@EnableOAuth2Sso实现</a></li>
            <li><a href="#基于enableresourceserver实现">基于@EnableResourceServer实现</a></li>
            <li><a href="#使用jwt存储token">使用jwt存储Token</a></li>
          </ul>
        </li>
        <li><a href="#redis与分布式">Redis与分布式</a>
          <ul>
            <li><a href="#主从复制">主从复制</a></li>
            <li><a href="#哨兵模式">哨兵模式</a></li>
            <li><a href="#集群搭建">集群搭建</a></li>
            <li><a href="#分布式锁">分布式锁</a></li>
          </ul>
        </li>
        <li><a href="#mysql与分布式">MySQL与分布式</a>
          <ul>
            <li><a href="#主从复制-1">主从复制</a></li>
            <li><a href="#分库分表">分库分表</a></li>
            <li><a href="#sharding-jdbc">Sharding JDBC</a></li>
            <li><a href="#分布式序列算法">分布式序列算法</a></li>
            <li><a href="#读写分离">读写分离</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</details>
<details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden">
  <summary
    class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    目录
  </summary>
  <div
    class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#微服务应用">微服务应用</a>
      <ul>
        <li><a href="#分布式权限校验">分布式权限校验</a></li>
        <li><a href="#oauth-20-实现单点登录">OAuth 2.0 实现单点登录</a>
          <ul>
            <li><a href="#四种授权模式">四种授权模式</a></li>
            <li><a href="#搭建验证服务器">搭建验证服务器</a></li>
            <li><a href="#基于enableoauth2sso实现">基于@EnableOAuth2Sso实现</a></li>
            <li><a href="#基于enableresourceserver实现">基于@EnableResourceServer实现</a></li>
            <li><a href="#使用jwt存储token">使用jwt存储Token</a></li>
          </ul>
        </li>
        <li><a href="#redis与分布式">Redis与分布式</a>
          <ul>
            <li><a href="#主从复制">主从复制</a></li>
            <li><a href="#哨兵模式">哨兵模式</a></li>
            <li><a href="#集群搭建">集群搭建</a></li>
            <li><a href="#分布式锁">分布式锁</a></li>
          </ul>
        </li>
        <li><a href="#mysql与分布式">MySQL与分布式</a>
          <ul>
            <li><a href="#主从复制-1">主从复制</a></li>
            <li><a href="#分库分表">分库分表</a></li>
            <li><a href="#sharding-jdbc">Sharding JDBC</a></li>
            <li><a href="#分布式序列算法">分布式序列算法</a></li>
            <li><a href="#读写分离">读写分离</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</details>

 
<script>
  (function () {
    var $toc = $('#TableOfContents');
    if ($toc.length > 0) {
      var $window = $(window);

      function onScroll() {
        var currentScroll = $window.scrollTop();
        var h = $('.anchor');
        var id = "";
        h.each(function (i, e) {
          e = $(e);
          if (e.offset().top - $(window).height()/3 <= currentScroll) {
            id = e.attr('id');
          }
        });
        var active = $toc.find('a.active');      
        if (active.length == 1 && active.eq(0).attr('href') == '#' + id) return true;

        active.each(function (i, e) {
          
            $(e).removeClass('active');
          
        });
        $toc.find('a[href="#' + id + '"]').addClass('active')
        $toc.find('a[href="#' + id + '"]').parentsUntil('#TableOfContents').each(function (i, e) {
          $(e).children('a').parents('ul').show();          
        });
      }

      $window.on('scroll', onScroll);
      $(document).ready(function () {
        
        onScroll();
      });
    }
  })();
</script>
   </div>
      </div>
      

      <div class="min-w-0 min-h-0 max-w-fit">
        
        
<details style="margin-left:0px" class="mt-2 mb-5 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5"  open >
    
    <summary
        class="py-1 text-lg font-semibold cursor-pointer bg-primary-200 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-primary-800 dark:text-neutral-100">
        cloud - 这是系列文章之一.
    </summary>
    
    
    
    <div
        class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
        <a href="/doc/cloud/%E4%B8%80/">
            部分 1: SpringCloud 1
        </a>
    </div>
    
    
    
    <div
        class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
        <a href="/doc/cloud/%E4%B8%89/">
            部分 2: SpringCloud 2
        </a>
    </div>
    
    
    
    <div
        class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
        部分 3: 本文
    </div>
    
    


</details>



        <div class="article-content max-w-prose mb-20">
          

<h1 class="relative group">微服务应用 
    <div id="%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BA%94%E7%94%A8" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BA%94%E7%94%A8" aria-label="锚点">#</a>
    </span>        
    
</h1>
<p>前面我们已经完成了SpringCloudAlibaba的学习，我们对一个微服务项目的架构体系已经有了一定的了解，那么本章我们将在应用层面继续探讨微服务。</p>


<h2 class="relative group">分布式权限校验 
    <div id="%E5%88%86%E5%B8%83%E5%BC%8F%E6%9D%83%E9%99%90%E6%A0%A1%E9%AA%8C" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E6%9D%83%E9%99%90%E6%A0%A1%E9%AA%8C" aria-label="锚点">#</a>
    </span>        
    
</h2>
<p>虽然完成前面的部分，我们已经可以自己去编写一个比较中规中矩的微服务项目了，但是还有一个问题我们没有解决，登录问题。假如现在要求用户登录之后，才能进行图书的查询、借阅等操作，那么我们又该如何设计这个系统呢？</p>
<p>回顾我们之前进行权限校验的原理，服务器是如何判定一个请求是来自哪个用户的呢？</p>
<ul>
<li>首先浏览器会向服务端发送请求，访问我们的网站。</li>
<li>服务端收到请求后，会创建一个SESSION ID，并暂时存储在服务端，然后会发送给浏览器作为Cookie保存。</li>
<li>之后浏览器会一直携带此Cookie访问服务器，这样在收到请求后，就能根据携带的Cookie中的SESSION ID判断是哪个用户了。</li>
<li>这样服务端和浏览器之间可以轻松地建立会话了。</li>
</ul>
<p>但是我们想一下，我们现在采用的是分布式的系统，那么在用户服务进行登录之后，其他服务比如图书服务和借阅服务，它们会知道用户登录了吗？</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/hV2JkERda4qKtjB.png" alt="image-20230306234928969" />
    
  </figure>

</p>
<p>实际上我们登录到用户服务之后，Session中的用户数据只会在用户服务的应用中保存，而在其他服务中，并没有对应的信息，但是我们现在希望的是，所有的服务都能够同步这些Session信息，这样我们才能实现在用户服务登录之后其他服务都能知道，那么我们该如何实现Session的同步呢？</p>
<ol>
<li>我们可以在每台服务器上都复制一份Session，但是这样显然是很浪费时间的，并且用户验证数据占用的内存会成倍的增加。</li>
<li>将Session移出服务器，用统一存储来存放，比如我们可以直接在Redis或是MySQL中存放用户的Session信息，这样所有的服务器在需要获取Session信息时，统一访问Redis或是MySQL即可，这样就能保证所有服务都可以同步Session了（是不是越来越感觉只要有问题，没有什么是加一个中间件解决不了的）</li>
</ol>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/pqZolFN6eIPza52.png" alt="image-20230306234940672" />
    
  </figure>

</p>
<p>那么，我们就着重来研究一下，然后实现2号方案，这里我们就使用Redis作为Session统一存储，我们把一开始的压缩包重新解压一次，又来从头开始编写吧。</p>
<p>这里我们就只使用Nacos就行了，和之前一样，我们把Nacos的包导入一下，然后进行一些配置：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/FYcNvAuZ7z8rj2V.png" alt="image-20230306234948408" />
    
  </figure>

</p>
<p>现在我们需要为每个服务都添加验证机制，首先导入依赖：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!--  SpringSession Redis支持  --&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.springframework.session<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-session-data-redis<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c">&lt;!--  添加Redis的Starter  --&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>然后我们依然使用SpringSecurity框架作为权限校验框架：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-security<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>接着我们在每个服务都编写一下对应的配置文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">session</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c"># 存储类型修改为redis</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">store-type</span><span class="p">:</span><span class="w"> </span><span class="l">redis</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">redis</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c"># Redis服务器的信息，该咋写咋写</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="m">1.14.121.107</span><span class="w">
</span></span></span></code></pre></div><p>这样，默认情况下，每个服务的接口都会被SpringSecurity所保护，只有登录成功之后，才可以被访问。</p>
<p>我们来打开Nacos看看：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/SyCJXKgO3qGx8EL.png" alt="image-20230306234959085" />
    
  </figure>

</p>
<p>可以看到三个服务都正常注册了，接着我们去访问图书服务：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/gytqnZjTMvVEUm3.png" alt="image-20230306235007563" />
    
  </figure>

</p>
<p>可以看到，访问失败，直接把我们给重定向到登陆页面了，也就是说必须登陆之后才能访问，同样的方式去访问其他服务，也是一样的效果。</p>
<p>由于现在是统一Session存储，那么我们就可以在任意一个服务登录之后，其他服务都可以正常访问，现在我们在当前页面登录，登录之后可以看到图书服务能够正常访问了：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/xfV5oYGvc1jKqTM.png" alt="image-20230306235015909" />
    
  </figure>

</p>
<p>同时用户服务也能正常访问了：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/OH6wjLVreot4IiA.png" alt="image-20230306235021694" />
    
  </figure>

</p>
<p>我们可以查看一下Redis服务器中是不是存储了我们的Session信息：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/nNIkoXOAYuMH8aV.png" alt="image-20230306235046117" />
    
  </figure>

</p>
<p>虽然看起来好像确实没啥问题了，但是借阅服务炸了，我们来看看为什么：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/wls5vCajnuMBOkU.png" alt="image-20230306235053840" />
    
  </figure>

</p>
<p>在RestTemplate进行远程调用的时候，由于我们的请求没有携带对应SESSION的Cookie，所以导致验证失败，访问不成功，返回401，所以虽然这种方案看起来比较合理，但是在我们的实际使用中，还是存在一些不便的。</p>
<hr>


<h2 class="relative group">OAuth 2.0 实现单点登录 
    <div id="oauth-20-%E5%AE%9E%E7%8E%B0%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#oauth-20-%E5%AE%9E%E7%8E%B0%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95" aria-label="锚点">#</a>
    </span>        
    
</h2>
<p><strong>注意：</strong> 第一次接触可能会比较难，不太好理解，需要多实践和观察。</p>
<p>前面我们虽然使用了统一存储来解决Session共享问题，但是我们发现就算实现了Session共享，依然存在一些问题，由于我们每个服务都有自己的验证模块，实际上整个系统是存在冗余功能的、同时还有我们上面出现的问题，那么能否实现只在一个服务进行登录，就可以访问其他的服务呢？</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/46ukOAiDzMZBX15.png" alt="image-20230306235102514" />
    
  </figure>

</p>
<p>实际上之前的登录模式称为多点登录，而我们希望的是实现单点登陆，因此，我们得找一个更好的解决方案。</p>
<p>这里我们首先需要了解一种全新的登录方式：<strong>OAuth 2.0</strong>，我们经常看到一些网站支持第三方登录，比如淘宝、咸鱼我们就可以使用支付宝进行登录，腾讯游戏可以用QQ或是微信登陆，以及微信小程序都可以直接使用微信进行登录。我们知道它们并不是属于同一个系统，比如淘宝和咸鱼都不属于支付宝这个应用，但是由于需要获取支付宝的用户信息，这时我们就需要使用 OAuth2.0 来实现第三方授权，基于第三方应用访问用户信息的权限（本质上就是给别人调用自己服务接口的权限)，那么它是如何实现的呢？</p>


<h3 class="relative group">四种授权模式 
    <div id="%E5%9B%9B%E7%A7%8D%E6%8E%88%E6%9D%83%E6%A8%A1%E5%BC%8F" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%9B%9B%E7%A7%8D%E6%8E%88%E6%9D%83%E6%A8%A1%E5%BC%8F" aria-label="锚点">#</a>
    </span>        
    
</h3>
<p>我们还是从理论开始讲解，OAuth 2.0一共有四种授权模式：</p>
<ol>
<li>
<p><strong>客户端模式（Client Credentials）</strong></p>
<p>这是最简单的一种模式，我们可以直接向验证服务器请求一个Token（这里可能有些小伙伴对Token的概念不是很熟悉，Token相当于是一个令牌，我们需要在验证服务器**（User Account And Authentication）**服务拿到令牌之后，才能去访问资源，比如用户信息、借阅信息等，这样资源服务器才能知道我们是谁以及是否成功登录了）</p>
<p>当然，这里的前端页面只是一个例子，它还可以是其他任何类型的<strong>客户端</strong>，比如App、小程序甚至是第三方应用的服务。</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/4i16wzqOnYeaB2c.png" alt="image-20230306235141113" />
    
  </figure>

</p>
<p>虽然这种模式比较简便，但是已经失去了用户验证的意义，压根就不是给用户校验准备的，而是更适用于服务内部调用的场景。</p>
</li>
<li>
<p><strong>密码模式（Resource Owner Password Credentials）</strong></p>
<p>密码模式相比客户端模式，就多了用户名和密码的信息，用户需要提供对应账号的用户名和密码，才能获取到Token。</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/JEreS9nQD8ojMca.png" alt="image-20230306235151635" />
    
  </figure>

</p>
<p>虽然这样看起来比较合理，但是会直接将账号和密码泄露给客户端，需要后台完全信任客户端不会拿账号密码去干其他坏事，所以这也不是我们常见的。</p>
</li>
<li>
<p><strong>隐式授权模式（Implicit Grant）</strong></p>
<p>首先用户访问页面时，会重定向到认证服务器，接着认证服务器给用户一个认证页面，等待用户授权，用户填写信息完成授权后，认证服务器返回Token。</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/MRxnKyWT3br5Zj2.png" alt="image-20230306235200365" />
    
  </figure>

</p>
<p>它适用于没有服务端的第三方应用页面，并且相比前面一种形式，验证都是在验证服务器进行的，敏感信息不会轻易泄露，但是Token依然存在泄露的风险。</p>
</li>
<li>
<p><strong>授权码模式（Authrization Code）</strong></p>
<p>这种模式是最安全的一种模式，也是推荐使用的一种，比如我们手机上的很多App都是使用的这种模式。</p>
<p>相比隐式授权模式，它并不会直接返回Token，而是返回授权码，真正的Token是通过应用服务器访问验证服务器获得的。在一开始的时候，应用服务器（客户端通过访问自己的应用服务器来进而访问其他服务）和验证服务器之间会共享一个<code>secret</code>，这个东西没有其他人知道，而验证服务器在用户验证完成之后，会返回一个授权码，应用服务器最后将授权码和<code>secret</code>一起交给验证服务器进行验证，并且Token也是在服务端之间传递，不会直接给到客户端。</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/2EIPfirBOKbcndk.png" alt="image-20230306235211335" />
    
  </figure>

</p>
<p>这样就算有人中途窃取了授权码，也毫无意义，因为，Token的获取必须同时携带授权码和secret，但是<code>secret</code>第三方是无法得知的，并且Token不会直接丢给客户端，大大减少了泄露的风险。</p>
</li>
</ol>
<p>但是乍一看，OAuth 2.0不应该是那种第三方应用为了请求我们的服务而使用的吗，而我们这里需要的只是实现同一个应用内部服务之间的认证，其实我也可以利用 OAuth2.0 来实现单点登录，只是少了资源服务器这一角色，客户端就是我们的整个系统，接下来就让我们来实现一下。</p>


<h3 class="relative group">搭建验证服务器 
    <div id="%E6%90%AD%E5%BB%BA%E9%AA%8C%E8%AF%81%E6%9C%8D%E5%8A%A1%E5%99%A8" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E6%90%AD%E5%BB%BA%E9%AA%8C%E8%AF%81%E6%9C%8D%E5%8A%A1%E5%99%A8" aria-label="锚点">#</a>
    </span>        
    
</h3>
<p>第一步就是最重要的，我们需要搭建一个验证服务器，它是我们进行权限校验的核心，验证服务器有很多的第三方实现也有Spring官方提供的实现，这里我们使用Spring官方提供的验证服务器。</p>
<p>这里我们将最开始保存好的项目解压，就重新创建一个新的项目，首先我们在父项目中添加最新的SpringCloud依赖：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-dependencies<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>2021.0.1<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>接着创建一个新的模块<code>auth-service</code>，添加依赖：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-security<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--  OAuth2.0依赖，不再内置了，所以得我们自己指定一下版本  --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-oauth2<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>2.2.5.RELEASE<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><p>接着我们修改一下配置文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8500</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">servlet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c">#为了防止一会在服务之间跳转导致Cookie打架（因为所有服务地址都是localhost，都会存JSESSIONID）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c">#这里修改一下context-path，这样保存的Cookie会使用指定的路径，就不会和其他服务打架了</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c">#但是注意之后的请求都得在最前面加上这个路径</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">context-path</span><span class="p">:</span><span class="w"> </span><span class="l">/sso</span><span class="w">
</span></span></span></code></pre></div><p>接着我们需要编写一下配置类，这里需要两个配置类，一个是OAuth2的配置类，还有一个是SpringSecurity的配置类：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfiguration</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">http</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>  <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">and</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">formLogin</span><span class="o">().</span><span class="na">permitAll</span><span class="o">();</span>    <span class="c1">//使用表单登录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">BCryptPasswordEncoder</span> <span class="n">encoder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BCryptPasswordEncoder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">auth</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">inMemoryAuthentication</span><span class="o">()</span>   <span class="c1">//直接创建一个用户，懒得搞数据库了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">passwordEncoder</span><span class="o">(</span><span class="n">encoder</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">withUser</span><span class="o">(</span><span class="s">&#34;test&#34;</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="n">encoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="s">&#34;123456&#34;</span><span class="o">)).</span><span class="na">roles</span><span class="o">(</span><span class="s">&#34;USER&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  	<span class="nd">@Bean</span>   <span class="c1">//这里需要将AuthenticationManager注册为Bean，在OAuth配置中使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AuthenticationManager</span> <span class="nf">authenticationManagerBean</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">authenticationManagerBean</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@EnableAuthorizationServer</span>   <span class="c1">//开启验证服务器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2Configuration</span> <span class="kd">extends</span> <span class="n">AuthorizationServerConfigurerAdapter</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">AuthenticationManager</span> <span class="n">manager</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">BCryptPasswordEncoder</span> <span class="n">encoder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BCryptPasswordEncoder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 这个方法是对客户端进行配置，一个验证服务器可以预设很多个客户端，
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 之后这些指定的客户端就可以按照下面指定的方式进行验证
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param clients 客户端配置工具
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">ClientDetailsServiceConfigurer</span> <span class="n">clients</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">clients</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">inMemory</span><span class="o">()</span>   <span class="c1">//这里我们直接硬编码创建，当然也可以像Security那样自定义或是使用JDBC从数据库读取
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">withClient</span><span class="o">(</span><span class="s">&#34;web&#34;</span><span class="o">)</span>   <span class="c1">//客户端名称，随便起就行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">secret</span><span class="o">(</span><span class="n">encoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="s">&#34;654321&#34;</span><span class="o">))</span>      <span class="c1">//只与客户端分享的secret，随便写，但是注意要加密
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">autoApprove</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>    <span class="c1">//自动审批，这里关闭，要的就是一会体验那种感觉
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">scopes</span><span class="o">(</span><span class="s">&#34;book&#34;</span><span class="o">,</span> <span class="s">&#34;user&#34;</span><span class="o">,</span> <span class="s">&#34;borrow&#34;</span><span class="o">)</span>     <span class="c1">//授权范围，这里我们使用全部all
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">authorizedGrantTypes</span><span class="o">(</span><span class="s">&#34;client_credentials&#34;</span><span class="o">,</span> <span class="s">&#34;password&#34;</span><span class="o">,</span> <span class="s">&#34;implicit&#34;</span><span class="o">,</span> <span class="s">&#34;authorization_code&#34;</span><span class="o">,</span> <span class="s">&#34;refresh_token&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//授权模式，一共支持5种，除了之前我们介绍的四种之外，还有一个刷新Token的模式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">//这里我们直接把五种都写上，方便一会实验，当然各位也可以单独只写一种一个一个进行测试
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">//现在我们指定的客户端就支持这五种类型的授权方式了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">AuthorizationServerSecurityConfigurer</span> <span class="n">security</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">security</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">passwordEncoder</span><span class="o">(</span><span class="n">encoder</span><span class="o">)</span>    <span class="c1">//编码器设定为BCryptPasswordEncoder
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">allowFormAuthenticationForClients</span><span class="o">()</span>  <span class="c1">//允许客户端使用表单验证，一会我们POST请求中会携带表单信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">checkTokenAccess</span><span class="o">(</span><span class="s">&#34;permitAll()&#34;</span><span class="o">);</span>     <span class="c1">//允许所有的Token查询请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">AuthorizationServerEndpointsConfigurer</span> <span class="n">endpoints</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">endpoints</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">authenticationManager</span><span class="o">(</span><span class="n">manager</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//由于SpringSecurity新版本的一些底层改动，这里需要配置一下authenticationManager，才能正常使用password模式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>接着我们就可以启动服务器了：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/2FhnOKe1BorP5NE.png" alt="image-20230306235226961" />
    
  </figure>

</p>
<p>然后我们使用Postman进行接口测试，首先我们从最简单的客户端模式进行测试，客户端模式只需要提供id和secret即可直接拿到Token，注意需要再添加一个grant_type来表明我们的授权方式，默认请求路径为http://localhost:8500/sso/oauth/token：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/X81T7mz5gQK3iBk.png" alt="image-20230306235236376" />
    
  </figure>

</p>
<p>发起请求后，可以看到我们得到了Token，它是以JSON格式给到我们的：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/84IKgq2xdvBeLTm.png" alt="image-20230306235248456" />
    
  </figure>

</p>
<p>我们还可以访问 http://localhost:8500/sso/oauth/check_token 来验证我们的Token是否有效：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/SXD8FjzZn7ev2B3.png" alt="image-20230306235257995" />
    
  </figure>

</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/B9TzojnUq4KvVPr.png" alt="image-20230306235309409" />
    
  </figure>

</p>
<p>可以看到active为true，表示我们刚刚申请到的Token是有效的。</p>
<p>接着我们来测试一下第二种password模式，我们还需要提供具体的用户名和密码，授权模式定义为password即可：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/jt5XPZKvRFqr73x.png" alt="image-20230306235318785" />
    
  </figure>

</p>
<p>接着我们需要在请求头中添加Basic验证信息，这里我们直接填写id和secret即可：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/K9ZpIv8SzcfsHd4.png" alt="image-20230306235327745" />
    
  </figure>

</p>
<p>可以看到在请求头中自动生成了Basic验证相关内容：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/JHxPKgFU5wY7SB8.png" alt="image-20230306235335919" />
    
  </figure>

</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/F3WU7XhqridywVn.png" alt="image-20230306235345388" />
    
  </figure>

</p>
<p>响应成功，得到Token信息，并且这里还多出了一个refresh_token，这是用于刷新Token的，我们之后会进行讲解。</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/zjuc2qxQmBas5r1.png" alt="image-20230306235355181" />
    
  </figure>

</p>
<p>查询Token信息之后还可以看到登录的具体用户以及角色权限等。</p>
<p>接着我们来看隐式授权模式，这种模式我们需要在验证服务器上进行登录操作，而不是直接请求Token，验证登录请求地址：http://localhost:8500/sso/oauth/authorize?client_id=web&amp;response_type=token</p>
<p>注意response_type一定要是token类型，这样才会直接返回Token，浏览器发起请求后，可以看到熟悉而又陌生的界面，没错，实际上这里就是使用我们之前讲解的SpringSecurity进行登陆，当然也可以配置一下记住我之类的功能，这里就不演示了：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/OYeRQpEXFSoZMhc.png" alt="image-20230306235441824" />
    
  </figure>

</p>
<p>但是登录之后我们发现出现了一个错误：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/qLUkJFZau8eQ6WO.png" alt="image-20230306235501474" />
    
  </figure>

</p>
<p>这是因为登录成功之后，验证服务器需要将结果给回客户端，所以需要提供客户端的回调地址，这样浏览器就会被重定向到指定的回调地址并且请求中会携带Token信息，这里我们随便配置一个回调地址：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">ClientDetailsServiceConfigurer</span> <span class="n">clients</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">clients</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">inMemory</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">withClient</span><span class="o">(</span><span class="s">&#34;web&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">secret</span><span class="o">(</span><span class="n">encoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="s">&#34;654321&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">autoApprove</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">scopes</span><span class="o">(</span><span class="s">&#34;book&#34;</span><span class="o">,</span> <span class="s">&#34;user&#34;</span><span class="o">,</span> <span class="s">&#34;borrow&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">redirectUris</span><span class="o">(</span><span class="s">&#34;http://localhost:8201/login&#34;</span><span class="o">)</span>   <span class="c1">//可以写多个，当有多个时需要在验证请求中指定使用哪个地址进行回调
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">.</span><span class="na">authorizedGrantTypes</span><span class="o">(</span><span class="s">&#34;client_credentials&#34;</span><span class="o">,</span> <span class="s">&#34;password&#34;</span><span class="o">,</span> <span class="s">&#34;implicit&#34;</span><span class="o">,</span> <span class="s">&#34;authorization_code&#34;</span><span class="o">,</span> <span class="s">&#34;refresh_token&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>接着重启验证服务器，再次访问：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/PnTwQhlYXDgBvry.png" alt="image-20230306235513330" />
    
  </figure>

</p>
<p>可以看到这里会让我们选择哪些范围进行授权，就像我们在微信小程序中登陆一样，会让我们授予用户信息权限、支付权限、信用查询权限等，我们可以自由决定要不要给客户端授予访问这些资源的权限，这里我们全部选择授予：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/p7nMEVZIKjXWAl5.png" alt="image-20230306235521432" />
    
  </figure>

</p>
<p>授予之后，可以看到浏览器被重定向到我们刚刚指定的回调地址中，并且携带了Token信息，现在我们来校验一下看看：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/g1JhS9WDfcz6QEK.png" alt="image-20230306235530288" />
    
  </figure>

</p>
<p>可以看到，Token也是有效的。</p>
<p>最后我们来看看第四种最安全的授权码模式，这种模式其实流程和上面是一样的，但是请求的是code类型：http://localhost:8500/sso/oauth/authorize?client_id=web&amp;response_type=code</p>
<p>可以看到访问之后，依然会进入到回调地址，但是这时给的就是授权码了，而不是直接给Token，那么这个Token该怎么获取呢？</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/da4WseDt172hbLV.png" alt="image-20230306235536317" />
    
  </figure>

</p>
<p>按照我们之前讲解的原理，我们需要携带授权码和secret一起请求，才能拿到Token，正常情况下是由回调的服务器进行处理，这里我们就在Postman中进行，我们复制刚刚得到的授权码，接口依然是<code>localhost:8500/sso/oauth/token</code>：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/e1Zdt9IP7vp2zMO.png" alt="image-20230306235545717" />
    
  </figure>

</p>
<p>可以看到结果也是正常返回了Token信息：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/qY5kxgBWSzMJXco.png" alt="image-20230306235554061" />
    
  </figure>

</p>
<p>这样我们四种最基本的Token请求方式就实现了。</p>
<p>最后还有一个是刷新令牌使用的，当我们的Token过期时，我们就可以使用这个refresh_token来申请一个新的Token：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/d2ojclCLB3mQu7D.png" alt="image-20230306235603731" />
    
  </figure>

</p>
<p>但是执行之后我们发现会直接出现一个内部错误：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/BcFMIg4NqCx8kdh.png" alt="image-20230306235611413" />
    
  </figure>

</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/cA9WF1KxyUDZ8Bi.png" alt="image-20230306235618838" />
    
  </figure>

</p>
<p>查看日志发现，这里还需要我们单独配置一个UserDetailsService，我们直接把Security中的实例注册为Bean：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">UserDetailsService</span> <span class="nf">userDetailsServiceBean</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">userDetailsServiceBean</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>然后在Endpoint中设置：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl"><span class="n">UserDetailsService</span> <span class="n">service</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">AuthorizationServerEndpointsConfigurer</span> <span class="n">endpoints</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">endpoints</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">userDetailsService</span><span class="o">(</span><span class="n">service</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">authenticationManager</span><span class="o">(</span><span class="n">manager</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>最后再次尝试刷新Token：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/QWEwzpiq7FXnv3f.png" alt="image-20230306235638503" />
    
  </figure>

</p>
<p>OK，成功刷新Token，返回了一个新的。</p>


<h3 class="relative group">基于@EnableOAuth2Sso实现 
    <div id="%E5%9F%BA%E4%BA%8Eenableoauth2sso%E5%AE%9E%E7%8E%B0" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%9F%BA%E4%BA%8Eenableoauth2sso%E5%AE%9E%E7%8E%B0" aria-label="锚点">#</a>
    </span>        
    
</h3>
<p>前面我们将验证服务器已经搭建完成了，现在我们就来实现一下单点登陆吧，SpringCloud为我们提供了客户端的直接实现，我们只需要添加一个注解和少量配置即可将我们的服务作为一个单点登陆应用，使用的是第四种授权码模式。</p>
<p>一句话来说就是，这种模式只是将验证方式由原本的默认登录形式改变为了统一在授权服务器登陆的形式。</p>
<p>首先还是依赖：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-security<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-oauth2<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>2.2.5.RELEASE<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>我们只需要直接在启动类上添加即可：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@EnableOAuth2Sso</span>
</span></span><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BookApplication</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">BookApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>我们不需要进行额外的配置类，因为这个注解已经帮我们做了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Target</span><span class="o">({</span><span class="n">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">})</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Documented</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableOAuth2Client</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableConfigurationProperties</span><span class="o">({</span><span class="n">OAuth2SsoProperties</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Import</span><span class="o">({</span><span class="n">OAuth2SsoDefaultConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">OAuth2SsoCustomConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">ResourceServerTokenServicesConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">EnableOAuth2Sso</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>可以看到它直接注册了OAuth2SsoDefaultConfiguration，而这个类就是帮助我们对Security进行配置的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Conditional</span><span class="o">({</span><span class="n">NeedsWebSecurityCondition</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuth2SsoDefaultConfiguration</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  	<span class="c1">//直接继承的WebSecurityConfigurerAdapter，帮我们把验证设置都写好了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">OAuth2SsoDefaultConfiguration</span><span class="o">(</span><span class="n">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">applicationContext</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>接着我们需要在配置文件中配置我们的验证服务器相关信息：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">security</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">oauth2</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c">#不多说了</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">client-id</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">client-secret</span><span class="p">:</span><span class="w"> </span><span class="m">654321</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c">#Token获取地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">access-token-uri</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:8500/sso/oauth/token</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c">#验证页面地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">user-authorization-uri</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:8500/sso/oauth/authorize</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resource</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c">#Token信息获取和校验地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">token-info-uri</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:8500/sso/oauth/check_token</span><span class="w">
</span></span></span></code></pre></div><p>现在我们就开启图书服务，调用图书接口：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/DrVSZtdKNCoMucx.png" alt="image-20230306235651433" />
    
  </figure>

</p>
<p>可以看到在发现没有登录验证时，会直接跳转到授权页面，进行授权登录，之后才可以继续访问图书服务：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/nsJGmxcOVYXDUqd.png" alt="image-20230306235701725" />
    
  </figure>

</p>
<p>那么用户信息呢？是否也一并保存过来了？我们这里直接获取一下SpringSecurity的Context查看用户信息，获取方式跟我们之前的视频中讲解的是一样的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/book/{bid}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Book</span> <span class="nf">findBookById</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;bid&#34;</span><span class="o">)</span> <span class="kt">int</span> <span class="n">bid</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">  	<span class="c1">//通过SecurityContextHolder将用户信息取出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">SecurityContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">service</span><span class="o">.</span><span class="na">getBookById</span><span class="o">(</span><span class="n">bid</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>再次访问图书管理接口，可以看到：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/y1VYRC9tmOv854u.png" alt="image-20230306235733777" />
    
  </figure>

</p>
<p>这里使用的不是之前的UsernamePasswordAuthenticationToken也不是RememberMeAuthenticationToken，而是新的OAuth2Authentication，它保存了验证服务器的一些信息，以及经过我们之前的登陆流程之后，验证服务器发放给客户端的Token信息，并通过Token信息在验证服务器进行验证获取用户信息，最后保存到Session中，表示用户已验证，所以本质上还是要依赖浏览器存Cookie的。</p>
<p>接下来我们将所有的服务都使用这种方式进行验证，别忘了把重定向地址给所有服务都加上：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">ClientDetailsServiceConfigurer</span> <span class="n">clients</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">clients</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">inMemory</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">withClient</span><span class="o">(</span><span class="s">&#34;web&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">secret</span><span class="o">(</span><span class="n">encoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="s">&#34;654321&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">autoApprove</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>   <span class="c1">//这里把自动审批开了，就不用再去手动选同意了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">.</span><span class="na">scopes</span><span class="o">(</span><span class="s">&#34;book&#34;</span><span class="o">,</span> <span class="s">&#34;user&#34;</span><span class="o">,</span> <span class="s">&#34;borrow&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">redirectUris</span><span class="o">(</span><span class="s">&#34;http://localhost:8101/login&#34;</span><span class="o">,</span> <span class="s">&#34;http://localhost:8201/login&#34;</span><span class="o">,</span> <span class="s">&#34;http://localhost:8301/login&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">authorizedGrantTypes</span><span class="o">(</span><span class="s">&#34;client_credentials&#34;</span><span class="o">,</span> <span class="s">&#34;password&#34;</span><span class="o">,</span> <span class="s">&#34;implicit&#34;</span><span class="o">,</span> <span class="s">&#34;authorization_code&#34;</span><span class="o">,</span> <span class="s">&#34;refresh_token&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>这样我们就可以实现只在验证服务器登陆，如果登陆过其他的服务都可以访问了。</p>
<p>但是我们发现一个问题，就是由于SESSION不同步，每次切换不同的服务进行访问都会重新导验证服务器去验证一次：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/7zbqlOrSCVRdQ4y.png" alt="image-20230306235744660" />
    
  </figure>

</p>
<p>这里有两个方案：</p>
<ul>
<li>像之前一样做SESSION统一存储</li>
<li>设置context-path路径，每个服务单独设置，就不会打架了</li>
</ul>
<p>但是这样依然没法解决服务间调用的问题，所以仅仅依靠单点登陆的模式不太行。</p>


<h3 class="relative group">基于@EnableResourceServer实现 
    <div id="%E5%9F%BA%E4%BA%8Eenableresourceserver%E5%AE%9E%E7%8E%B0" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%9F%BA%E4%BA%8Eenableresourceserver%E5%AE%9E%E7%8E%B0" aria-label="锚点">#</a>
    </span>        
    
</h3>
<p>前面我们讲解了将我们的服务作为单点登陆应用直接实现单点登陆，那么现在我们如果是以第三方应用进行访问呢？这时我们就需要将我们的服务作为资源服务了，作为资源服务就不会再提供验证的过程，而是直接要求请求时携带Token，而验证过程我们这里就继续用Postman来完成，这才是我们常见的模式。</p>
<p>一句话来说，跟上面相比，我们只需要携带Token就能访问这些资源服务器了，客户端被独立了出来，用于携带Token去访问这些服务。</p>
<p>我们也只需要添加一个注解和少量配置即可：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@EnableResourceServer</span>
</span></span><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BookApplication</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">BookApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>配置中只需要：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">security</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">oauth2</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    	</span><span class="c">#基操</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">client-id</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">client-secret</span><span class="p">:</span><span class="w"> </span><span class="m">654321</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resource</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    	</span><span class="c">#因为资源服务器得验证你的Token是否有访问此资源的权限以及用户信息，所以只需要一个验证地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">token-info-uri</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:8500/sso/oauth/check_token</span><span class="w">
</span></span></span></code></pre></div><p>配置完成后，我们启动服务器，直接访问会发现：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/QiZmqznyMxNpETk.png" alt="image-20230306235756676" />
    
  </figure>

</p>
<p>这是由于我们的请求头中没有携带Token信息，现在有两种方式可以访问此资源：</p>
<ul>
<li>在URL后面添加<code>access_token</code>请求参数，值为Token值</li>
<li>在请求头中添加<code>Authorization</code>，值为<code>Bearer +Token值</code></li>
</ul>
<p>我们先来试试看最简的一种：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/Np6PKCZD2kAdmtf.png" alt="image-20230306235804196" />
    
  </figure>

</p>
<p>另一种我们需要使用Postman来完成：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/ypR3G7DxsYicMQI.png" alt="image-20230306235814228" />
    
  </figure>

</p>
<p>添加验证信息后，会帮助我们转换成请求头信息：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/qPHDU1dXgC7srn3.png" alt="image-20230306235826416" />
    
  </figure>

</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/6IeMvTcCKdfbUlV.png" alt="image-20230306235833330" />
    
  </figure>

</p>
<p>这样我们就将资源服务器搭建完成了。</p>
<p>我们接着来看如何对资源服务器进行深度自定义，我们可以为其编写一个配置类，比如我们现在希望用户授权了某个Scope才可以访问此服务：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ResourceConfiguration</span> <span class="kd">extends</span> <span class="n">ResourceServerConfigurerAdapter</span> <span class="o">{</span> <span class="c1">//继承此类进行高度自定义
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>  <span class="c1">//这里也有HttpSecurity对象，方便我们配置SpringSecurity
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">http</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">access</span><span class="o">(</span><span class="s">&#34;#oauth2.hasScope(&#39;lbwnb&#39;)&#34;</span><span class="o">);</span>  <span class="c1">//添加自定义规则
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      					<span class="c1">//Token必须要有我们自定义scope授权才可以访问此资源
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>可以看到当没有对应的scope授权时，那么会直接返回<code>insufficient_scope</code>错误：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/5T4d39YkcZIomvD.png" alt="image-20230306235844783" />
    
  </figure>

</p>
<p>不知道各位是否有发现，实际上资源服务器完全没有必要将Security的信息保存在Session中了，因为现在只需要将Token告诉资源服务器，那么资源服务器就可以联系验证服务器，得到用户信息，就不需要使用之前的Session存储机制了，所以你会发现HttpSession中没有<strong>SPRING_SECURITY_CONTEXT</strong>，现在Security信息都是通过连接资源服务器获取。</p>
<p>接着我们将所有的服务都</p>
<p>但是还有一个问题没有解决，我们在使用RestTemplate进行服务间的远程调用时，会得到以下错误：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/k3LmR9E7UBtVA5x.png" alt="image-20230306235853397" />
    
  </figure>

</p>
<p>实际上这是因为在服务调用时没有携带Token信息，我们得想个办法把用户传来的Token信息在进行远程调用时也携带上，因此，我们可以直接使用OAuth2RestTemplate，它会在请求其他服务时携带当前请求的Token信息。它继承自RestTemplate，这里我们直接定义一个Bean：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebConfiguration</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl">    <span class="n">OAuth2ClientContext</span> <span class="n">context</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">OAuth2RestTemplate</span> <span class="nf">restTemplate</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">OAuth2RestTemplate</span><span class="o">(</span><span class="k">new</span> <span class="n">ClientCredentialsResourceDetails</span><span class="o">(),</span> <span class="n">context</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>接着我们直接替换掉之前的RestTemplate即可：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Service</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BorrowServiceImpl</span> <span class="kd">implements</span> <span class="n">BorrowService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl">    <span class="n">BorrowMapper</span> <span class="n">mapper</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl">    <span class="n">OAuth2RestTemplate</span> <span class="n">template</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">UserBorrowDetail</span> <span class="nf">getUserBorrowDetailByUid</span><span class="o">(</span><span class="kt">int</span> <span class="n">uid</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">Borrow</span><span class="o">&gt;</span> <span class="n">borrow</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="na">getBorrowsByUid</span><span class="o">(</span><span class="n">uid</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="na">getForObject</span><span class="o">(</span><span class="s">&#34;http://localhost:8101/user/&#34;</span><span class="o">+</span><span class="n">uid</span><span class="o">,</span> <span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//获取每一本书的详细信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">Book</span><span class="o">&gt;</span> <span class="n">bookList</span> <span class="o">=</span> <span class="n">borrow</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="n">template</span><span class="o">.</span><span class="na">getForObject</span><span class="o">(</span><span class="s">&#34;http://localhost:8201/book/&#34;</span><span class="o">+</span><span class="n">b</span><span class="o">.</span><span class="na">getBid</span><span class="o">(),</span> <span class="n">Book</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">UserBorrowDetail</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">bookList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>可以看到服务成功调用了：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/mvKqyJk7P1FCQSl.png" alt="image-20230306235903496" />
    
  </figure>

</p>
<p>现在我们来将Nacos加入，并通过Feign实现远程调用。</p>
<p>依赖还是贴一下，不然找不到：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>com.alibaba.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-alibaba-dependencies<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>2021.0.1.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>com.alibaba.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-loadbalancer<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>所有服务都已经注册成功了：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/BqkomFVGK7wv64X.png" alt="image-20230306235926214" />
    
  </figure>

</p>
<p>接着我们配置一下借阅服务的负载均衡：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebConfiguration</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl">    <span class="n">OAuth2ClientContext</span> <span class="n">context</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@LoadBalanced</span>   <span class="c1">//和RestTemplate一样直接添加注解就行了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">OAuth2RestTemplate</span> <span class="nf">restTemplate</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">OAuth2RestTemplate</span><span class="o">(</span><span class="k">new</span> <span class="n">ClientCredentialsResourceDetails</span><span class="o">(),</span> <span class="n">context</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/PZkS8GyU1jhpIrz.png" alt="image-20230306235934751" />
    
  </figure>

</p>
<p>现在我们来把它替换为Feign，老样子，两个客户端：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@FeignClient</span><span class="o">(</span><span class="s">&#34;user-service&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserClient</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/user/{uid}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">User</span> <span class="nf">getUserById</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;uid&#34;</span><span class="o">)</span> <span class="kt">int</span> <span class="n">uid</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@FeignClient</span><span class="o">(</span><span class="s">&#34;book-service&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BookClient</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/book/{bid}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Book</span> <span class="nf">getBookById</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;bid&#34;</span><span class="o">)</span> <span class="kt">int</span> <span class="n">bid</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>但是配置完成之后，又出现刚刚的问题了，OpenFeign也没有携带Token进行访问：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/EzWuaAJgNLi3sdF.png" alt="image-20230306235944272" />
    
  </figure>

</p>
<p>那么怎么配置Feign携带Token访问呢？遇到这种问题直接去官方查：https://docs.spring.io/spring-cloud-openfeign/docs/current/reference/html/#oauth2-support，非常简单，两个配置就搞定：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">feign</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">oauth2</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c">#开启Oauth支持，这样就会在请求头中携带Token了</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">#同时开启负载均衡支持</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">load-balanced</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><p>重启服务器，可以看到结果OK了：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/zgEJF7AeHw8iGIZ.png" alt="image-20230306235953555" />
    
  </figure>

</p>
<p>这样我们就成功将之前的三个服务作为资源服务器了，注意和我们上面的作为客户端是不同的，将服务直接作为客户端相当于只需要验证通过即可，并且还是要保存Session信息，相当于只是将登录流程换到统一的验证服务器上进行罢了。而将其作为资源服务器，那么就需要另外找客户端（可以是浏览器、小程序、App、第三方服务等）来访问，并且也是需要先进行验证然后再通过携带Token进行访问，这种模式是我们比较常见的模式。</p>


<h3 class="relative group">使用jwt存储Token 
    <div id="%E4%BD%BF%E7%94%A8jwt%E5%AD%98%E5%82%A8token" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E4%BD%BF%E7%94%A8jwt%E5%AD%98%E5%82%A8token" aria-label="锚点">#</a>
    </span>        
    
</h3>
<p>官网：https://jwt.io</p>
<p>JSON Web Token令牌（JWT）是一个开放标准（<a href="https://tools.ietf.org/html/rfc7519"   target="_blank">
    RFC 7519</a>），它定义了一种紧凑和自成一体的方式，用于在各方之间作为JSON对象安全地传输信息。这些信息可以被验证和信任，因为它是数字签名的。JWT可以使用密钥（使用<strong>HMAC</strong>算法）或使用<strong>RSA</strong>或<strong>ECDSA</strong>进行公钥/私钥对进行签名。</p>
<p>实际上，我们之前都是携带Token向资源服务器发起请求后，资源服务器由于不知道我们Token的用户信息，所以需要向验证服务器询问此Token的认证信息，这样才能得到Token代表的用户信息，但是各位是否考虑过，如果每次用户请求都去查询用户信息，那么在大量请求下，验证服务器的压力可能会非常的大。而使用JWT之后，Token中会直接保存用户信息，这样资源服务器就不再需要询问验证服务器，自行就可以完成解析，我们的目标是不联系验证服务器就能直接完成验证。</p>
<p>JWT令牌的格式如下：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/Xu8lxYhKoJNr6it.png" alt="image-20230307000004710" />
    
  </figure>

</p>
<p>一个JWT令牌由3部分组成：标头(Header)、有效载荷(Payload)和签名(Signature)。在传输的时候，会将JWT的3部分分别进行Base64编码后用<code>.</code>进行连接形成最终需要传输的字符串。</p>
<ul>
<li>标头：包含一些元数据信息，比如JWT签名所使用的加密算法，还有类型，这里统一都是JWT。</li>
<li>有效载荷：包括用户名称、令牌发布时间、过期时间、JWT ID等，当然我们也可以自定义添加字段，我们的用户信息一般都在这里存放。</li>
<li>签名：首先需要指定一个密钥，该密钥仅仅保存在服务器中，保证不能让其他用户知道。然后使用Header中指定的算法对Header和Payload进行base64加密之后的结果通过密钥计算哈希值，然后就得出一个签名哈希。这个会用于之后验证内容是否被篡改。</li>
</ul>
<p>这里还是补充一下一些概念，因为很多东西都是我们之前没有接触过的：</p>
<ul>
<li>
<p><strong>Base64：</strong> 就是包括小写字母a-z、大写字母A-Z、数字0-9、符号&quot;+&quot;、&quot;/&ldquo;一共64个字符的字符集（末尾还有1个或多个<code>=</code>用来凑够字节数），任何的符号都可以转换成这个字符集中的字符，这个转换过程就叫做Base64编码，编码之后会生成只包含上述64个字符的字符串。相反，如果需要原本的内容，我们也可以进行Base64解码，回到原有的样子。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="s">&#34;你们可能不知道只用20万赢到578万是什么概念&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  	<span class="c1">//Base64不只是可以对字符串进行编码，任何byte[]数据都可以，编码结果可以是byte[]，也可以是字符串
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">String</span> <span class="n">encodeStr</span> <span class="o">=</span> <span class="n">Base64</span><span class="o">.</span><span class="na">getEncoder</span><span class="o">().</span><span class="na">encodeToString</span><span class="o">(</span><span class="n">str</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Base64编码后的字符串：&#34;</span><span class="o">+</span><span class="n">encodeStr</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;解码后的字符串：&#34;</span><span class="o">+</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">Base64</span><span class="o">.</span><span class="na">getDecoder</span><span class="o">().</span><span class="na">decode</span><span class="o">(</span><span class="n">encodeStr</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>注意Base64不是加密算法，只是一种信息的编码方式而已。</p>
</li>
<li>
<p><strong>加密算法：</strong> 加密算法分为对称加密和非对称加密，其中**对称加密（Symmetric Cryptography）**比较好理解，就像一把锁配了两把钥匙一样，这两把钥匙你和别人都有一把，然后你们直接传递数据，都会把数据用锁给锁上，就算传递的途中有人把数据窃取了，也没办法解密，因为钥匙只有你和对方有，没有钥匙无法进行解密，但是这样有个问题，既然解密的关键在于钥匙本身，那么如果有人不仅窃取了数据，而且对方那边的治安也不好，于是顺手就偷走了钥匙，那你们之间发的数据不就凉凉了吗。</p>
<p>因此，**非对称加密（Asymmetric Cryptography）**算法出现了，它并不是直接生成一把钥匙，而是生成一个公钥和一个私钥，私钥只能由你保管，而公钥交给对方或是你要发送的任何人都行，现在你需要把数据传给对方，那么就需要使用私钥进行加密，但是，这个数据只能使用对应的公钥进行解密，相反，如果对方需要给你发送数据，那么就需要用公钥进行加密，而数据只能使用私钥进行解密，这样的话就算对方的公钥被窃取，那么别人发给你的数据也没办法解密出来，因为需要私钥才能解密，而只有你才有私钥。</p>
<p>因此，非对称加密的安全性会更高一些，包括HTTPS的隐私信息正是使用非对称加密来保障传输数据的安全（当然HTTPS并不是单纯地使用非对称加密完成的，感兴趣的可以去了解一下）</p>
<p>对称加密和非对称加密都有很多的算法，比如对称加密，就有：DES、IDEA、RC2，非对称加密有：RSA、DAS、ECC</p>
</li>
<li>
<p><strong>不可逆加密算法：</strong> 常见的不可逆加密算法有MD5, HMAC, SHA-1, SHA-224, SHA-256, SHA-384, 和SHA-512, 其中SHA-224、SHA-256、SHA-384，和SHA-512我们可以统称为SHA2加密算法，SHA加密算法的安全性要比MD5更高，而SHA2加密算法比SHA1的要高，其中SHA后面的数字表示的是加密后的字符串长度，SHA1默认会产生一个160位的信息摘要。经过不可逆加密算法得到的加密结果，是无法解密回去的，也就是说加密出来是什么就是什么了。本质上，其就是一种哈希函数，用于对一段信息产生摘要，以<strong>防止被篡改</strong>。</p>
<p>实际上这种算法就常常被用作信息摘要计算，同样的数据通过同样的算法计算得到的结果肯定也一样，而如果数据被修改，那么计算的结果肯定就不一样了。</p>
</li>
</ul>
<p>这里我们就可以利用jwt，将我们的Token采用新的方式进行存储：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/W95CFKAmd1wfgSJ.png" alt="image-20230307000016944" />
    
  </figure>

</p>
<p>这里我们使用最简单的一种方式，对称密钥，我们需要对验证服务器进行一些修改：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">JwtAccessTokenConverter</span> <span class="nf">tokenConverter</span><span class="o">(){</span>  <span class="c1">//Token转换器，将其转换为JWT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">JwtAccessTokenConverter</span> <span class="n">converter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JwtAccessTokenConverter</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">converter</span><span class="o">.</span><span class="na">setSigningKey</span><span class="o">(</span><span class="s">&#34;lbwnb&#34;</span><span class="o">);</span>   <span class="c1">//这个是对称密钥，一会资源服务器那边也要指定为这个
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">converter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">TokenStore</span> <span class="nf">tokenStore</span><span class="o">(</span><span class="n">JwtAccessTokenConverter</span> <span class="n">converter</span><span class="o">){</span>  <span class="c1">//Token存储方式现在改为JWT存储
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="k">new</span> <span class="n">JwtTokenStore</span><span class="o">(</span><span class="n">converter</span><span class="o">);</span>  <span class="c1">//传入刚刚定义好的转换器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl"><span class="n">TokenStore</span> <span class="n">store</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl"><span class="n">JwtAccessTokenConverter</span> <span class="n">converter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">AuthorizationServerTokenServices</span> <span class="nf">serverTokenServices</span><span class="o">(){</span>  <span class="c1">//这里对AuthorizationServerTokenServices进行一下配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DefaultTokenServices</span> <span class="n">services</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultTokenServices</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">services</span><span class="o">.</span><span class="na">setSupportRefreshToken</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>   <span class="c1">//允许Token刷新
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">services</span><span class="o">.</span><span class="na">setTokenStore</span><span class="o">(</span><span class="n">store</span><span class="o">);</span>   <span class="c1">//添加刚刚的TokenStore
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">services</span><span class="o">.</span><span class="na">setTokenEnhancer</span><span class="o">(</span><span class="n">converter</span><span class="o">);</span>   <span class="c1">//添加Token增强，其实就是JwtAccessTokenConverter，增强是添加一些自定义的数据到JWT中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">services</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">AuthorizationServerEndpointsConfigurer</span> <span class="n">endpoints</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">endpoints</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">tokenServices</span><span class="o">(</span><span class="n">serverTokenServices</span><span class="o">())</span>   <span class="c1">//设定为刚刚配置好的AuthorizationServerTokenServices
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">.</span><span class="na">userDetailsService</span><span class="o">(</span><span class="n">service</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">authenticationManager</span><span class="o">(</span><span class="n">manager</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>然后我们就可以重启验证服务器了：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/C6OteoFghrxpYjQ.png" alt="image-20230307000026772" />
    
  </figure>

</p>
<p>可以看到成功获取了AccessToken，但是这里的格式跟我们之前的格式就大不相同了，因为现在它是JWT令牌，我们可以对其进行一下Base64解码：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/CUMkrRfgOthZKVz.png" alt="image-20230307000035581" />
    
  </figure>

</p>
<p>可以看到所有的验证信息包含在内，现在我们对资源服务器进行配置：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">security</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">oauth2</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resource</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">jwt</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">key-value</span><span class="p">:</span><span class="w"> </span><span class="l">lbwnb</span><span class="w"> </span><span class="c">#注意这里要跟验证服务器的密钥一致，这样算出来的签名才会一致</span><span class="w">
</span></span></span></code></pre></div><p>然后启动资源服务器，请求一下接口试试看：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/kOpRlTB7SPtQa4y.png" alt="image-20230307000043443" />
    
  </figure>

</p>
<p>请求成功，得到数据：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/aicW89KezTSZ7f5.png" alt="image-20230307000053404" />
    
  </figure>

</p>
<p>注意如果Token有误，那么会得到：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/4wFZx8kNY5WHnvy.png" alt="image-20230307000101304" />
    
  </figure>

</p>
<hr>


<h2 class="relative group">Redis与分布式 
    <div id="redis%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#redis%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F" aria-label="锚点">#</a>
    </span>        
    
</h2>
<p>在SpringBoot阶段，我们学习了Redis，它是一个基于内存的高性能数据库，我们当时已经学习了包括基本操作、常用数据类型、持久化、事务和锁机制以及使用Java与Redis进行交互等，利用它的高性能，我们还使用它来做Mybatis的二级缓存、以及Token的持久化存储。而这一部分，我们将继续深入，探讨Redis在分布式开发场景下的应用。</p>


<h3 class="relative group">主从复制 
    <div id="%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6" aria-label="锚点">#</a>
    </span>        
    
</h3>
<p>在分布式场景下，我们可以考虑让Redis实现主从模式：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/bzwPflgBD5O1saN.png" alt="image-20230307000109568" />
    
  </figure>

</p>
<p>主从复制，是指将一台Redis服务器的数据，复制到其他的Redis服务器。前者称为主节点(Master)，后者称为从节点(Slave)，数据的复制是单向的，只能由主节点到从节点。Master以写为主，Slave 以读为主。</p>
<p>这样的好处肯定是显而易见的：</p>
<ul>
<li>实现了读写分离，提高了性能。</li>
<li>在写少读多的场景下，我们甚至可以安排很多个从节点，这样就能够大幅度的分担压力，并且就算挂掉一个，其他的也能使用。</li>
</ul>
<p>那么我们现在就来尝试实现一下，这里我们还是在Windows下进行测试，打开Redis文件夹，我们要开启两个Redis服务器，修改配置文件<code>redis.windows.conf</code>：</p>
<pre tabindex="0"><code class="language-conf" data-lang="conf"># Accept connections on the specified port, default is 6379 (IANA #815344).
# If port 0 is specified Redis will not listen on a TCP socket.
port 6001
</code></pre><p>一个服务器的端口设定为6001，复制一份，另一个的端口为6002，接着我们指定配置文件进行启动，打开cmd：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/Si54lok9eqtKPf1.png" alt="image-20230307000143566" />
    
  </figure>

</p>
<p>现在我们的两个服务器就启动成功了，接着我们可以使用命令查看当前服务器的主从状态，我们打开客户端：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/2TbMQeZknSOzFpy.png" alt="image-20230307000151282" />
    
  </figure>

</p>
<p>输入<code>info replication</code>命令来查看当前的主从状态，可以看到默认的角色为：master，也就是说所有的服务器在启动之后都是主节点的状态。那么现在我们希望让6002作为从节点，通过一个命令即可：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/XqpNcihJ5jsZRoI.png" alt="image-20230307000200296" />
    
  </figure>

</p>
<p>可以看到，在输入<code>replicaof 127.0.0.1 6001</code>命令后，就会将6001服务器作为主节点，而当前节点作为6001的从节点，并且角色也会变成：slave，接着我们来看看6001的情况：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/YABKJDsbQkE1UM5.png" alt="image-20230307000208687" />
    
  </figure>

</p>
<p>可以看到从节点信息中已经出现了6002服务器，也就是说现在我们的6001和6002就形成了主从关系（还包含一个偏移量，这个偏移量反应的是从节点的同步情况）</p>
<blockquote>
<p>主服务器和从服务器都会维护一个复制偏移量，主服务器每次向从服务器中传递 N 个字节的时候，会将自己的复制偏移量加上 N。从服务器中收到主服务器的 N 个字节的数据，就会将自己额复制偏移量加上 N，通过主从服务器的偏移量对比可以很清楚的知道主从服务器的数据是否处于一致，如果不一致就需要进行增量同步了。</p>
</blockquote>
<p>那么我们现在可以来测试一下，在主节点新增数据，看看是否会同步到从节点：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/taxoisA8Tpg2DWM.png" alt="image-20230307000216155" />
    
  </figure>

</p>
<p>可以看到，我们在6001服务器插入的<code>a</code>，可以在从节点6002读取到，那么，从节点新增的数据在主节点能得到吗？我们来测试一下：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/dS2V8xafPj6lKND.png" alt="image-20230307000224291" />
    
  </figure>

</p>
<p>可以看到，从节点压根就没办法进行数据插入，节点的模式为只读模式。那么如果我们现在不想让6002作为6001的从节点了呢？</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/dV7Rxov6pblW2g5.png" alt="image-20230307000234718" />
    
  </figure>

</p>
<p>可以看到，通过输入<code>replicaof no one</code>，即可变回Master角色。接着我们再来启动一台6003服务器，流程是一样的：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/TC7z2mt3EGMPWfq.png" alt="image-20230307000406674" />
    
  </figure>

</p>
<p>可以看到，在连接之后，也会直接同步主节点的数据，因此无论是已经处于从节点状态还是刚刚启动完成的服务器，都会从主节点同步数据，实际上整个同步流程为：</p>
<ol>
<li>从节点执行replicaof ip port命令后，从节点会保存主节点相关的地址信息。</li>
<li>从节点通过每秒运行的定时任务发现配置了新的主节点后，会尝试与该节点建立网络连接，专门用于接收主节点发送的复制命令。</li>
<li>连接成功后，第一次会将主节点的数据进行全量复制，之后采用增量复制，持续将新来的写命令同步给从节点。</li>
</ol>
<p>当我们的主节点关闭后，从节点依然可以读取数据：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/MmNshyQxa2ijSRT.png" alt="image-20230307000415001" />
    
  </figure>

</p>
<p>但是从节点会疯狂报错：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/pEIo93MQXShrsZD.png" alt="image-20230307000424822" />
    
  </figure>

</p>
<p>当然每次都去敲个命令配置主从太麻烦了，我们可以直接在配置文件中配置，添加这样行即可：</p>
<pre tabindex="0"><code>replicaof 127.0.0.1 6001
</code></pre><p>这里我们给6002和6003服务器都配置一下，现在我们重启三个服务器。</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/GpAa5kfyC3zVRZK.png" alt="image-20230307000432434" />
    
  </figure>

</p>
<p>当然，除了作为Master节点的从节点外，我们还可以将其作为从节点的从节点，比如现在我们让6003作为6002的从节点：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/OdAs1weYgkDrQvf.png" alt="image-20230307000444990" />
    
  </figure>

</p>
<p>也就是说，现在差不多是这样的的一个情况：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/2ADSR8LtpMhCFfK.png" alt="image-20230307000459161" />
    
  </figure>

</p>
<p>采用这种方式，优点肯定是显而易见的，但是缺点也很明显，整个传播链路一旦中途出现问题，那么就会导致后面的从节点无法及时同步。</p>


<h3 class="relative group">哨兵模式 
    <div id="%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F" aria-label="锚点">#</a>
    </span>        
    
</h3>
<p>前面我们讲解了Redis实现主从复制的一些基本操作，那么我们接着来看哨兵模式。</p>
<p>经过之前的学习，我们发现，实际上最关键的还是主节点，因为一旦主节点出现问题，那么整个主从系统将无法写入，因此，我们得想一个办法，处理一下主节点故障的情况。实际上我们可以参考之前的服务治理模式，比如Nacos和Eureka，所有的服务都会被实时监控，那么只要出现问题，肯定是可以及时发现的，并且能够采取响应的补救措施，这就是我们即将介绍的哨兵：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/YGq8MDZbRK6E7Po.png" alt="image-20230307000508084" />
    
  </figure>

</p>
<p>注意这里的哨兵不是我们之前学习SpringCloud Alibaba的那个，是专用于Redis的。哨兵会对所有的节点进行监控，如果发现主节点出现问题，那么会立即让从节点进行投票，选举一个新的主节点出来，这样就不会由于主节点的故障导致整个系统不可写（注意要实现这样的功能最小的系统必须是一主一从，再小的话就没有意义了）</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/WhkUqfxcHn4CApP.png" alt="image-20230307000516875" />
    
  </figure>

</p>
<p>那么怎么启动一个哨兵呢？我们只需要稍微修改一下配置文件即可，这里直接删除全部内容，添加：</p>
<pre tabindex="0"><code>sentinel monitor lbwnb 127.0.0.1 6001 1
</code></pre><p>其中第一个和第二个是固定，第三个是为监控对象名称，随意，后面就是主节点的相关信息，包括IP地址和端口，最后一个1我们暂时先不说，然后我们使用此配置文件启动服务器，可以看到启动后：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/xB78t53RgykXvo9.png" alt="image-20230307000534399" />
    
  </figure>

</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/STh2RgjW7ycPCNB.png" alt="image-20230307000542878" />
    
  </figure>

</p>
<p>可以看到以哨兵模式启动后，会自动监控主节点，然后还会显示那些节点是作为从节点存在的。</p>
<p>现在我们直接把主节点关闭，看看会发生什么事情：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/97HnwfuNjUK5qx4.png" alt="image-20230307000627807" />
    
  </figure>

</p>
<p>可以看到从节点还是正常的在报错，一开始的时候不会直接重新进行选举而是继续尝试重连（因为有可能只是网络小卡一下，没必要这么敏感），但是我们发现，经过一段时间之后，依然无法连接，哨兵输出了以下内容：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/GWt8Q6mfSv7TgCb.png" alt="image-20230307000646050" />
    
  </figure>

</p>
<p>可以看到哨兵发现主节点已经有一段时间不可用了，那么就会开始进行重新选举，6003节点被选为了新的主节点，并且之前的主节点6001变成了新的主节点的从节点：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/4WzTVZ15dMiQ3f8.png" alt="image-20230307000653822" />
    
  </figure>

</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/gGHVvOhBKe9wSEz.png" alt="image-20230307000703587" />
    
  </figure>

</p>
<p>当我们再次启动6001时，会发现，它自动变成了6003的从节点，并且会将数据同步过来：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/eqLycu8s1rSRtFa.png" alt="image-20230307000717002" />
    
  </figure>

</p>
<p>那么，这个选举规则是怎样的呢？是在所有的从节点中随机选取还是遵循某种规则呢？</p>
<ol>
<li>首先会根据优先级进行选择，可以在配置文件中进行配置，添加<code>replica-priority</code>配置项（默认是100），越小表示优先级越高。</li>
<li>如果优先级一样，那就选择偏移量最大的</li>
<li>要是还选不出来，那就选择runid（启动时随机生成的）最小的。</li>
</ol>
<p>要是哨兵也挂了咋办？没事，咱们可以多安排几个哨兵，只需要把哨兵的配置复制一下，然后修改端口，这样就可以同时启动多个哨兵了，我们启动3个哨兵（一主二从三哨兵），这里我们吧最后一个值改为<code>2</code>：</p>
<pre tabindex="0"><code>sentinel monitor lbwnb 192.168.0.8 6001 2
</code></pre><p>这个值实际上代表的是当有几个哨兵认为主节点挂掉时，就判断主节点真的挂掉了</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/48MNiLJXqmUtvWc.png" alt="image-20230307000731297" />
    
  </figure>

</p>
<p>现在我们把6001节点挂掉，看看这三个哨兵会怎么样：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/ajSAhqb5L9Yuorg.png" alt="image-20230307000741214" />
    
  </figure>

</p>
<p>可以看到都显示将master切换为6002节点了。</p>
<p>那么，在哨兵重新选举新的主节点之后，我们Java中的Redis的客户端怎么感知到呢？我们来看看，首先还是导入依赖：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>redis.clients<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>jedis<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>4.2.1<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//这里我们直接使用JedisSentinelPool来获取Master节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//需要把三个哨兵的地址都填入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">(</span><span class="n">JedisSentinelPool</span> <span class="n">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JedisSentinelPool</span><span class="o">(</span><span class="s">&#34;lbwnb&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">&#34;192.168.0.8:26741&#34;</span><span class="o">,</span> <span class="s">&#34;192.168.0.8:26740&#34;</span><span class="o">,</span> <span class="s">&#34;192.168.0.8:26739&#34;</span><span class="o">))))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="na">getResource</span><span class="o">();</span>   <span class="c1">//直接询问并得到Jedis对象，这就是连接的Master节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">jedis</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&#34;test&#34;</span><span class="o">,</span> <span class="s">&#34;114514&#34;</span><span class="o">);</span>    <span class="c1">//直接写入即可，实际上就是向Master节点写入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">            <span class="n">Jedis</span> <span class="n">jedis2</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="na">getResource</span><span class="o">();</span>   <span class="c1">//再次获取
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jedis2</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;test&#34;</span><span class="o">));</span>   <span class="c1">//读取操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>这样，Jedis对象就可以通过哨兵来获取，当Master节点更新后，也能得到最新的。</p>


<h3 class="relative group">集群搭建 
    <div id="%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA" aria-label="锚点">#</a>
    </span>        
    
</h3>
<p>如果我们服务器的内存不够用了，但是现在我们的Redis又需要继续存储内容，那么这个时候就可以利用集群来实现扩容。</p>
<p>因为单机的内存容量最大就那么多，已经没办法再继续扩展了，但是现在又需要存储更多的内容，这时我们就可以让N台机器上的Redis来分别存储各个部分的数据（每个Redis可以存储1/N的数据量），这样就实现了容量的横向扩展。同时每台Redis还可以配一个从节点，这样就可以更好地保证数据的安全性。</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/TjCw8DLi1VqYvpZ.png" alt="image-20230307000754039" />
    
  </figure>

</p>
<p>那么问题来，现在用户来了一个写入的请求，数据该写到哪个节点上呢？我们来研究一下集群的机制：</p>
<p>首先，一个Redis集群包含16384个插槽，集群中的每个Redis 实例负责维护一部分插槽以及插槽所映射的键值数据，那么这个插槽是什么意思呢？</p>
<p>实际上，插槽就是键的Hash计算后的一个结果，注意这里出现了<code>计算机网络</code>中的CRC循环冗余校验，这里采用CRC16，能得到16个bit位的数据，也就是说算出来之后结果是0-65535之间，再进行取模，得到最终结果：</p>
<p><strong>Redis key的路由计算公式：slot = CRC16（key） % 16384</strong></p>
<p>结果的值是多少，就应该存放到对应维护的Redis下，比如Redis节点1负责0-25565的插槽，而这时客户端插入了一个新的数据<code>a=10</code>，a在Hash计算后结果为666，那么a就应该存放到1号Redis节点中。简而言之，本质上就是通过哈希算法将插入的数据分摊到各个节点的，所以说哈希算法真的是处处都有用啊。</p>
<p>那么现在我们就来搭建一个简单的Redis集群，这里创建6个配置，注意开启集群模式：</p>
<pre tabindex="0"><code># Normal Redis instances can&#39;t be part of a Redis Cluster; only nodes that are
# started as cluster nodes can. In order to start a Redis instance as a
# cluster node enable the cluster support uncommenting the following:
#
cluster-enabled yes
</code></pre><p>接着记得把所有的持久化文件全部删除，所有的节点内容必须是空的。</p>
<p>然后输入<code>redis-cli.exe --cluster create --cluster-replicas 1 127.0.0.1:6001 127.0.0.1:6002 127.0.0.1:6003 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003</code>，这里的<code>--cluster-replicas 1</code>指的是每个节点配一个从节点：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/7DikHoxKJPve9qa.png" alt="image-20230307000805968" />
    
  </figure>

</p>
<p>输入之后，会为你展示客户端默认分配的方案，并且会询问你当前的方案是否合理。可以看到6001/6002/6003都被选为主节点，其他的为从节点，我们直接输入yes即可：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/yxZhjouXB79qfDd.png" alt="image-20230307000814076" />
    
  </figure>

</p>
<p>最后分配成功，可以看到插槽的分配情况：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/8kg9TbadF2qyHJW.png" alt="image-20230307000830886" />
    
  </figure>

</p>
<p>现在我们随便连接一个节点，尝试插入一个值：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/YMf8DtlkCsqBpO1.png" alt="image-20230307000840119" />
    
  </figure>

</p>
<p>在插入时，出现了一个错误，实际上这就是因为a计算出来的哈希值（插槽），不归当前节点管，我们得去管这个插槽的节点执行，通过上面的分配情况，我们可以得到15495属于节点6003管理：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/EZmR2bLFudSskIf.png" alt="image-20230307000849127" />
    
  </figure>

</p>
<p>在6003节点插入成功，当然我们也可以使用集群方式连接，这样我们无论在哪个节点都可以插入，只需要添加<code>-c</code>表示以集群模式访问：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/mVw7EXFJQOcinIb.png" alt="image-20230307000907196" />
    
  </figure>

</p>
<p>可以看到，在6001节点成功对a的值进行了更新，只不过还是被重定向到了6003节点进行插入。</p>
<p>我们可以输入<code>cluster nodes</code>命令来查看当前所有节点的信息：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/pEJdI2UWTcNZFqu.png" alt="image-20230307000914746" />
    
  </figure>

</p>
<p>那么现在如果我们让某一个主节点挂掉会怎么样？现在我们把6001挂掉：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/zd6L3WosVE8JUqf.png" alt="image-20230307000922277" />
    
  </figure>

</p>
<p>可以看到原本的6001从节点7001，晋升为了新的主节点，而之前的6001已经挂了，现在我们将6001重启试试看：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/eUfYJS8yhVijvaw.png" alt="image-20230307000933812" />
    
  </figure>

</p>
<p>可以看到6001变成了7001的从节点，那么要是6001和7001都挂了呢？</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/9W2BQtMXrUCnySV.png" alt="image-20230307000944827" />
    
  </figure>

</p>
<p>这时我们尝试插入新的数据：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/S8r5TE7gJ3M6iDW.png" alt="image-20230307000953377" />
    
  </figure>

</p>
<p>可以看到，当存在节点不可用时，会无法插入新的数据，现在我们将6001和7001恢复：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/2RL4GNqSWJXFuME.png" alt="image-20230307001001435" />
    
  </figure>

</p>
<p>可以看到恢复之后又可以继续正常使用了。</p>
<p>最后我们来看一下如何使用Java连接到集群模式下的Redis，我们需要用到JedisCluster对象：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//和客户端一样，随便连一个就行，也可以多写几个，构造方法有很多种可以选择
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span><span class="o">(</span><span class="n">JedisCluster</span> <span class="n">cluster</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JedisCluster</span><span class="o">(</span><span class="k">new</span> <span class="n">HostAndPort</span><span class="o">(</span><span class="s">&#34;192.168.0.8&#34;</span><span class="o">,</span> <span class="mi">6003</span><span class="o">))){</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;集群实例数量：&#34;</span><span class="o">+</span><span class="n">cluster</span><span class="o">.</span><span class="na">getClusterNodes</span><span class="o">().</span><span class="na">size</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">cluster</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&#34;a&#34;</span><span class="o">,</span> <span class="s">&#34;yyds&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">cluster</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;a&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>操作基本和Jedis对象一样，这里就不多做赘述了。</p>


<h3 class="relative group">分布式锁 
    <div id="%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81" aria-label="锚点">#</a>
    </span>        
    
</h3>
<p>在我们的传统单体应用中，经常会用到锁机制，目的是为了防止多线程竞争导致的并发问题，但是现在我们在分布式环境下，又该如何实现锁机制呢？可能一条链路上有很多的应用，它们都是独立运行的，这时我们就可以借助Redis来实现分布式锁。</p>
<p>还记得我们上一章最后提出的问题吗？</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">doBorrow</span><span class="o">(</span><span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">bid</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  	<span class="c1">//1. 判断图书和用户是否都支持借阅，如果此时来了10个线程，都进来了，那么都能够判断为可以借阅
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="o">(</span><span class="n">bookClient</span><span class="o">.</span><span class="na">bookRemain</span><span class="o">(</span><span class="n">bid</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;图书数量不足&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="o">(</span><span class="n">userClient</span><span class="o">.</span><span class="na">userRemain</span><span class="o">(</span><span class="n">uid</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;用户借阅量不足&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  	<span class="c1">//2. 首先将图书的数量-1，由于上面10个线程同时进来，同时判断可以借阅，那么这个10个线程就同时将图书数量-1，那库存岂不是直接变成负数了？？？
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="o">(!</span><span class="n">bookClient</span><span class="o">.</span><span class="na">bookBorrow</span><span class="o">(</span><span class="n">bid</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;在借阅图书时出现错误！&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  	<span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>实际上在高并发下，我们看似正常的借阅流程，会出现问题，比如现在同时来了10个同学要借同一本书，但是现在只有3本，而我们的判断规则是，首先看书够不够，如果此时这10个请求都已经走到这里，并且都判定为可以进行借阅，那么问题就出现了，接下来这10个请求都开始进行借阅操作，导致库存直接爆表，形成超借问题（在电商系统中也存在同样的超卖问题）</p>
<p>因此，为了解决这种问题，我们就可以利用分布式锁来实现。那么Redis如何去实现分布式锁呢？</p>
<p>在Redis存在这样一个命令：</p>
<pre tabindex="0"><code>setnx key value
</code></pre><p>这个命令看起来和<code>set</code>命令差不多，但是它有一个机制，就是只有当指定的key不存在的时候，才能进行插入，实际上就是<code>set if not exists</code>的缩写。</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/fNCxEJRX61cPsuk.png" alt="image-20230307001013418" />
    
  </figure>

</p>
<p>可以看到，当客户端1设定a之后，客户端2使用<code>setnx</code>会直接失败。</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/wpGutcmxEsWFJVn.png" alt="image-20230307001022446" />
    
  </figure>

</p>
<p>当客户端1将a删除之后，客户端2就可以使用<code>setnx</code>成功插入了。</p>
<p>利用这种特性，我们就可以在不同的服务中实现分布式锁，那么问题来了，要是某个服务加了锁但是卡顿了呢，或是直接崩溃了，那这把锁岂不是永远无法释放了？因此我们还可以考虑加个过期时间：</p>
<pre tabindex="0"><code>set a 666 EX 5 NX
</code></pre><p>这里使用<code>set</code>命令，最后加一个NX表示是使用<code>setnx</code>的模式，和上面是一样的，但是可以通过EX设定过期时间，这里设置为5秒，也就是说如果5秒还没释放，那么就自动删除。</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/eQEIGKONmkB2u6y.png" alt="image-20230307001031311" />
    
  </figure>

</p>
<p>当然，添加了过期时间，带了的好处是显而易见的，但是同时也带来了很多的麻烦，我们来设想一下这种情况：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/nStuP75RLOmQWUM.png" alt="image-20230307001038169" />
    
  </figure>

</p>
<p>因此，单纯只是添加过期时间，会出现这种把别人加的锁谁卸了的情况，要解决这种问题也很简单，我们现在的目标就是保证任务只能删除自己加的锁，如果是别人加的锁是没有资格删的，所以我们可以吧a的值指定为我们任务专属的值，比如可以使用UUID之类的，如果在主动删除锁的时候发现值不是我们当前任务指定的，那么说明可能是因为超时，其他任务已经加锁了。</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/4DW1K38UqQJdwkf.jpg" alt="image-20220414113041835" />
    
  </figure>

</p>
<p>如果你在学习本篇之前完成了JUC并发编程篇的学习，那么一定会有一个疑惑，如果在超时之前那一刹那进入到释放锁的阶段，获取到值肯定还是自己，但是在即将执行删除之前，由于超时机制导致被删除并且其他任务也加锁了，那么这时再进行删除，仍然会导致删除其他任务加的锁。</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/8I1Atm7BOZC5ifS.jpg" alt="image-20220414113709773" />
    
  </figure>

</p>
<p>实际上本质还是因为锁的超时时间不太好衡量，如果超时时间能够设定地比较恰当，那么就可以避免这种问题了。</p>
<p>要解决这个问题，我们可以借助一下Redisson框架，它是Redis官方推荐的Java版的Redis客户端。它提供的功能非常多，也非常强大，Redisson内部提供了一个监控锁的看门狗，它的作用是在Redisson实例被关闭前，不断的延长锁的有效期，它为我们提供了很多种分布式锁的实现，使用起来也类似我们在JUC中学习的锁，这里我们尝试使用一下它的分布式锁功能。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.redisson<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>redisson<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>3.17.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>io.netty<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>netty-all<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>4.1.75.Final<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>首先我们来看看不加锁的情况下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="o">(</span><span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Jedis</span><span class="o">(</span><span class="s">&#34;192.168.0.10&#34;</span><span class="o">,</span> <span class="mi">6379</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>   <span class="c1">//每个客户端获取a然后增加a的值再写回去，如果不加锁那么肯定会出问题
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">jedis</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;a&#34;</span><span class="o">))</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">jedis</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&#34;a&#34;</span><span class="o">,</span> <span class="n">a</span><span class="o">+</span><span class="s">&#34;&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>这里没有直接用<code>incr</code>而是我们自己进行计算，方便模拟，可以看到运行结束之后a的值并不是我们想要的：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/y2Nvi816ut4jpGC.jpg" alt="image-20220414133258227" />
    
  </figure>

</p>
<p>现在我们来给它加一把锁，注意这个锁是基于Redis的，不仅仅只可以用于当前应用，是能够垮系统的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Config</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Config</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">config</span><span class="o">.</span><span class="na">useSingleServer</span><span class="o">().</span><span class="na">setAddress</span><span class="o">(</span><span class="s">&#34;redis://192.168.0.10:6379&#34;</span><span class="o">);</span>   <span class="c1">//配置连接的Redis服务器，也可以指定集群
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">RedissonClient</span> <span class="n">client</span> <span class="o">=</span>  <span class="n">Redisson</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>   <span class="c1">//创建RedissonClient客户端
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="o">(</span><span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Jedis</span><span class="o">(</span><span class="s">&#34;192.168.0.10&#34;</span><span class="o">,</span> <span class="mi">6379</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">                <span class="n">RLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">getLock</span><span class="o">(</span><span class="s">&#34;testLock&#34;</span><span class="o">);</span>    <span class="c1">//指定锁的名称，拿到锁对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>    <span class="c1">//加锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">jedis</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;a&#34;</span><span class="o">))</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">jedis</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&#34;a&#34;</span><span class="o">,</span> <span class="n">a</span><span class="o">+</span><span class="s">&#34;&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>   <span class="c1">//解锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;结束！&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>可以看到结果没有问题：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/Gyz1Rc7OWhT5NJK.jpg" alt="image-20220414133403403" />
    
  </figure>

</p>
<p>注意，如果用于存放锁的Redis服务器挂了，那么肯定是会出问题的，这个时候我们就可以使用RedLock，它的思路是，在多个Redis服务器上保存锁，只需要超过半数的Redis服务器获取到锁，那么就真的获取到锁了，这样就算挂掉一部分节点，也能保证正常运行，这里就不做演示了。</p>
<hr>


<h2 class="relative group">MySQL与分布式 
    <div id="mysql%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#mysql%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F" aria-label="锚点">#</a>
    </span>        
    
</h2>
<p>前面我讲解了Redis在分布式场景的下的相关应用，接着我们来看看MySQL数据库在分布式场景下的应用。</p>


<h3 class="relative group">主从复制 
    <div id="%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6-1" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6-1" aria-label="锚点">#</a>
    </span>        
    
</h3>
<p>当我们使用MySQL的时候，也可以采取主从复制的策略，它的实现思路基本和Redis相似，也是采用增量复制的方式，MySQL会在运行的过程中，会记录二进制日志，所有的DML和DDL操作都会被记录进日志中，主库只需要将记录的操作复制给从库，让从库也运行一次，那么就可以实现主从复制。但是注意它不会在一开始进行全量复制，所以最好再开始主从之前将数据库的内容保持一致。</p>
<p>和之前一样，一旦我们实现了主从复制，那么就算主库出现故障，从库也能正常提供服务，并且还可以实现读写分离等操作。这里我们就使用两台主机来搭建一主一从的环境，首先确保两台服务器都安装了MySQL数据库并且都已经正常运行了：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/95wL8vICYNp61T2.jpg" alt="image-20220414162319865" />
    
  </figure>

</p>
<p>接着我们需要创建对应的账号，一会方便从库进行访问的用户：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">identified</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">mysql_native_password</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="s1">&#39;123456&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>接着我们开启一下外网访问：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo vim /etc/mysql/mysql.conf.d/mysqld.cnf
</span></span></code></pre></div><p>修改配置文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="c1"># If MySQL is running as a replication slave, this should be</span>
</span></span><span class="line"><span class="cl"><span class="c1"># changed. Ref https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_tmpdir</span>
</span></span><span class="line"><span class="cl"><span class="c1"># tmpdir                = /tmp</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Instead of skip-networking the default is now to listen only on</span>
</span></span><span class="line"><span class="cl"><span class="c1"># localhost which is more compatible and is not less secure.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># bind-address          = 127.0.0.1    这里注释掉就行</span>
</span></span></code></pre></div><p>现在我们重启一下MySQL服务：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo systemctl restart mysql.service 
</span></span></code></pre></div><p>现在我们首先来配置主库，主库只需要为我们刚刚创建好的用户分配一个主从复制的权限即可：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">grant</span><span class="w"> </span><span class="n">replication</span><span class="w"> </span><span class="n">slave</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="o">*</span><span class="p">.</span><span class="o">*</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">test</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">FLUSH</span><span class="w"> </span><span class="k">PRIVILEGES</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>然后我们可以输入命令来查看主库的相关情况：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/kqHZoc8xAbNOd3K.jpg" alt="image-20220414164943974" />
    
  </figure>

</p>
<p>这样主库就搭建完成了，接着我们需要将从库进行配置，首先是配置文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="c1"># The following can be used as easy to replay backup logs or for replication.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># note: if you are setting up a replication slave, see README.Debian about</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       other settings you may need to change.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 这里需要将server-id配置为其他的值（默认是1）所有Mysql主从实例的id必须唯一，不能打架，不然一会开启会失败</span>
</span></span><span class="line"><span class="cl"><span class="na">server-id</span>               <span class="o">=</span> <span class="s">2</span>
</span></span></code></pre></div><p>进入数据库，输入：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">change</span><span class="w"> </span><span class="n">replication</span><span class="w"> </span><span class="k">source</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">SOURCE_HOST</span><span class="o">=</span><span class="s1">&#39;192.168.0.8&#39;</span><span class="p">,</span><span class="n">SOURCE_USER</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span><span class="n">SOURCE_PASSWORD</span><span class="o">=</span><span class="s1">&#39;123456&#39;</span><span class="p">,</span><span class="n">SOURCE_LOG_FILE</span><span class="o">=</span><span class="s1">&#39;binlog.000004&#39;</span><span class="p">,</span><span class="n">SOURCE_LOG_POS</span><span class="o">=</span><span class="mi">591</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>注意后面的logfile和pos就是我们上面从主库中显示的信息。</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/H7BIl9s3kPu2Mnw.jpg" alt="image-20220414170022303" />
    
  </figure>

</p>
<p>执行完成后，显示OK表示没有问题，接着输入：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">start</span><span class="w"> </span><span class="n">replica</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>现在我们的从机就正式启动了，现在我们输入：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">show</span><span class="w"> </span><span class="n">replica</span><span class="w"> </span><span class="n">status</span><span class="err">\</span><span class="k">G</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>来查看当前从机状态，可以看到：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/KiCoVP1cGaf94uX.jpg" alt="image-20220414192045320" />
    
  </figure>

</p>
<p>最关键的是下面的Replica_IO_Running和Replica_SQL_Running必须同时为Yes才可以，实际上从库会创建两个线程，一个线程负责与主库进行通信，获取二进制日志，暂时存放到一个中间表（Relay_Log）中，而另一个线程则是将中间表保存的二进制日志的信息进行执行，然后插入到从库中。</p>
<p>最后配置完成，我们来看看在主库进行操作会不会同步到从库：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/RxNB3QmUYESX5ad.jpg" alt="image-20220414192508849" />
    
  </figure>

</p>
<p>可以看到在主库中创建的数据库，被同步到从库中了，我们再来试试看创建表和插入数据：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">use</span><span class="w"> </span><span class="n">yyds</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">test</span><span class="w">  </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">passwd</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/qKBwz31P6ySxlZt.jpg" alt="image-20220414192829536" />
    
  </figure>

</p>
<p>现在我们随便插入一点数据：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/9pqBFXiLhTPc2xO.jpg" alt="image-20220414192920277" />
    
  </figure>

</p>
<p>这样，我们的MySQL主从就搭建完成了，那么如果主机此时挂了会怎么样？</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/s1Q5xt32r6dv9UJ.jpg" alt="image-20220414200140191" />
    
  </figure>

</p>
<p>可以看到IO线程是处于重连状态，会等待主库重新恢复运行。</p>


<h3 class="relative group">分库分表 
    <div id="%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8" aria-label="锚点">#</a>
    </span>        
    
</h3>
<p>在大型的互联网系统中，可能单台MySQL的存储容量无法满足业务的需求，这时候就需要进行扩容了。</p>
<p>和之前的问题一样，单台主机的硬件资源是存在瓶颈的，不可能无限制地纵向扩展，这时我们就得通过多台实例来进行容量的横向扩容，我们可以将数据分散存储，让多台主机共同来保存数据。</p>
<p>那么问题来了，怎么个分散法？</p>
<ul>
<li>
<p><strong>垂直拆分：</strong> 我们的表和数据库都可以进行垂直拆分，所谓垂直拆分，就是将数据库中所有的表，按照业务功能拆分到各个数据库中（是不是感觉跟前面两章的学习的架构对应起来了）而对于一张表，也可以通过外键之类的机制，将其拆分为多个表。</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/mnJO4hBwDAkRcMi.jpg" alt="image-20220414204703883" />
    
  </figure>

</p>
</li>
<li>
<p><strong>水平拆分：</strong> 水平拆分针对的不是表，而是数据，我们可以让很多个具有相同表的数据库存放一部分数据，相当于是将数据分散存储在各个节点上。</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/AdS5hrH2O1l8iqv.jpg" alt="image-20220414205222383" />
    
  </figure>

</p>
</li>
</ul>
<p>那么要实现这样的拆分操作，我们自行去编写代码工作量肯定是比较大的，因此目前实际上已经有一些解决方案了，比如我们可以使用MyCat（也是一个数据库中间件，相当于挂了一层代理，再通过MyCat进行分库分表操作数据库，只需要连接就能使用，类似的还有ShardingSphere-Proxy）或是Sharding JDBC（应用程序中直接对SQL语句进行分析，然后转换成分库分表操作，需要我们自己编写一些逻辑代码），这里我们就讲解一下Sharding JDBC。</p>


<h3 class="relative group">Sharding JDBC 
    <div id="sharding-jdbc" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#sharding-jdbc" aria-label="锚点">#</a>
    </span>        
    
</h3>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/HTlcExgCfZvG9MP.jpg" alt="image-20220414214856875" />
    
  </figure>

</p>
<p><strong>官方文档（中文）：</strong> <a href="https://shardingsphere.apache.org/document/5.1.0/cn/overview/#shardingsphere-jdbc"   target="_blank">
    https://shardingsphere.apache.org/document/5.1.0/cn/overview/#shardingsphere-jdbc</a></p>
<p>定位为轻量级 Java 框架，在 Java 的 JDBC 层提供的额外服务，它使用客户端直连数据库，以 jar 包形式提供服务，无需额外部署和依赖，可理解为增强版的 JDBC 驱动，完全兼容 JDBC 和各种 ORM 框架。</p>
<ul>
<li>适用于任何基于 JDBC 的 ORM 框架，如：JPA, Hibernate, Mybatis, Spring JDBC Template 或直接使用 JDBC；</li>
<li>支持任何第三方的数据库连接池，如：DBCP, C3P0, BoneCP, HikariCP 等；</li>
<li>支持任意实现 JDBC 规范的数据库，目前支持 MySQL，PostgreSQL，Oracle，SQLServer 以及任何可使用 JDBC 访问的数据库。</li>
</ul>
<p>这里我们主要演示一下水平分表方式，我们直接创建一个新的SpringBoot项目即可，依赖如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">  	<span class="c">&lt;!--  ShardingJDBC依赖，那必须安排最新版啊，希望你们看视频的时候还是5.X版本  --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.apache.shardingsphere<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>shardingsphere-jdbc-core-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>5.1.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.mybatis.spring.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>mybatis-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>2.2.2<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><p>数据库我们这里直接用上节课的即可，因为只需要两个表结构一样的数据库即可，正好上节课进行了同步，所以我们直接把从库变回正常状态就可以了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">stop</span><span class="w"> </span><span class="n">replica</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>接着我们把两个表的root用户密码改一下，一会用这个用户连接数据库：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">update</span><span class="w"> </span><span class="k">user</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">authentication_string</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="k">user</span><span class="o">=</span><span class="s1">&#39;root&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">update</span><span class="w"> </span><span class="k">user</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="k">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;%&#39;</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="k">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">alter</span><span class="w"> </span><span class="k">user</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="n">identified</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">mysql_native_password</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="s1">&#39;123456&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">FLUSH</span><span class="w"> </span><span class="k">PRIVILEGES</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>接着我们来看，如果直接尝试开启服务器，那肯定是开不了的，因为我们要配置数据源：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/GEfPLSIZyobhtTe.jpg" alt="image-20220414212443482" />
    
  </figure>

</p>
<p>那么数据源该怎么配置呢？现在我们是一个分库分表的状态，需要配置两个数据源：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">shardingsphere</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">datasource</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># 有几个数据就配几个，这里是名称，按照下面的格式，名称+数字的形式</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">names</span><span class="p">:</span><span class="w"> </span><span class="l">db0,db1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># 为每个数据源单独进行配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">db0</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c"># 数据源实现类，这里使用默认的HikariDataSource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">com.zaxxer.hikari.HikariDataSource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># 数据库驱动</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">driver-class-name</span><span class="p">:</span><span class="w"> </span><span class="l">com.mysql.cj.jdbc.Driver</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># 不用我多说了吧</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">jdbc-url</span><span class="p">:</span><span class="w"> </span><span class="l">jdbc:mysql://192.168.0.8:3306/yyds</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="m">123456</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">db1</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">com.zaxxer.hikari.HikariDataSource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">driver-class-name</span><span class="p">:</span><span class="w"> </span><span class="l">com.mysql.cj.jdbc.Driver</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">jdbc-url</span><span class="p">:</span><span class="w"> </span><span class="l">jdbc:mysql://192.168.0.13:3306/yyds</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="m">123456</span><span class="w">
</span></span></span></code></pre></div><p>如果启动没有问题，那么就是配置成功了：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/Hvm82dfbEtwBqrA.jpg" alt="image-20220414222958901" />
    
  </figure>

</p>
<p>接着我们需要对项目进行一些编写，添加我们的用户实体类和Mapper：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Data</span>
</span></span><span class="line"><span class="cl"><span class="nd">@AllArgsConstructor</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">passwd</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Mapper</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserMapper</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Select</span><span class="o">(</span><span class="s">&#34;select * from test where id = #{id}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">User</span> <span class="nf">getUserById</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Insert</span><span class="o">(</span><span class="s">&#34;insert into test(id, name, passwd) values(#{id}, #{name}, #{passwd})&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">addUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>实际上这些操作都是常规操作，在编写代码时关注点依然放在业务本身上，现在我们就来编写配置文件，我们需要告诉ShardingJDBC要如何进行分片，首先明确：现在是两个数据库都有test表存放用户数据，我们目标是将用户信息分别存放到这两个数据库的表中。</p>
<p>不废话了，直接上配置：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">shardingsphere</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">sharding</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tables</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        	</span><span class="c">#这里填写表名称，程序中对这张表的所有操作，都会采用下面的路由方案</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        	</span><span class="c">#比如我们上面Mybatis就是对test表进行操作，所以会走下面的路由方案</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">test</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          	</span><span class="c">#这里填写实际的路由节点，比如现在我们要分两个库，那么就可以把两个库都写上，以及对应的表</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          	</span><span class="c">#也可以使用表达式，比如下面的可以简写为 db$-&gt;{0..1}.test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">actual-data-nodes</span><span class="p">:</span><span class="w"> </span><span class="l">db0.test,db1.test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c">#这里是分库策略配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">database-strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            	</span><span class="c">#这里选择标准策略，也可以配置复杂策略，基于多个键进行分片</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">standard</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              	</span><span class="c">#参与分片运算的字段，下面的算法会根据这里提供的字段进行运算</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">sharding-column</span><span class="p">:</span><span class="w"> </span><span class="l">id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c">#这里填写我们下面自定义的算法名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">sharding-algorithm-name</span><span class="p">:</span><span class="w"> </span><span class="l">my-alg</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">sharding-algorithms</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        	</span><span class="c">#自定义一个新的算法，名称随意</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">my-alg</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          	</span><span class="c">#算法类型，官方内置了很多种，这里演示最简单的一种</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">MOD</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">props</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">sharding-count</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">props</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    	</span><span class="c">#开启日志，一会方便我们观察</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">sql-show</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><p>其中，分片算法有很多内置的，可以在这里查询：https://shardingsphere.apache.org/document/5.1.0/cn/user-manual/shardingsphere-jdbc/builtin-algorithm/sharding/，这里我们使用的是MOD，也就是取模分片算法，它会根据主键的值进行取模运算，比如我们这里填写的是2，那么就表示对主键进行模2运算，根据数据源的名称，比如db0就是取模后为0，db1就是取模后为1（官方文档描述的并不是很清楚），也就是说，最终实现的效果就是单数放在<code>db1</code>，双数放在<code>db0</code>，当然它还支持一些其他的算法，这里就不多介绍了。</p>
<p>那么现在我们编写一个测试用例来看看，是否能够按照我们上面的规则进行路由：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootTest</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ShardingJdbcTestApplicationTests</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl">    <span class="n">UserMapper</span> <span class="n">mapper</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">contextLoads</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//这里ID自动生成1-10，然后插入数据库
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">mapper</span><span class="o">.</span><span class="na">addUser</span><span class="o">(</span><span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="s">&#34;xxx&#34;</span><span class="o">,</span> <span class="s">&#34;ccc&#34;</span><span class="o">));</span>   
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>现在我们可以开始运行了：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/7oBrFRwiXQxcumz.jpg" alt="image-20220415104401263" />
    
  </figure>

</p>
<p>测试通过，我们来看看数据库里面是不是按照我们的规则进行数据插入的：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/kZINi9wmnte3J7g.jpg" alt="image-20220415104449502" />
    
  </figure>

</p>
<p>可以看到这两张表，都成功按照我们指定的路由规则进行插入了，我们来看看详细的路由情况，通过控制台输出的SQL就可以看到：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/2e9cd91031d3fc7d2f11a2f59d8841ae.png" alt="image-20220415105325917" />
    
  </figure>

</p>
<p>可以看到所有的SQL语句都有一个Logic SQL（这个就是我们在Mybatis里面写的，是什么就是什么）紧接着下面就是Actual SQL，也就是说每个逻辑SQL最终会根据我们的策略转换为实际SQL，比如第一条数据，它的id是0，那么实际转换出来的SQL会在db0这个数据源进行插入。</p>
<p>这样我们就很轻松地实现了分库策略。</p>
<p>分库完成之后，接着我们来看分表，比如现在我们的数据库中有<code>test_0</code>和<code>test_1</code>两张表，表结构一样，但是我们也是希望能够根据id取模运算的结果分别放到这两个不同的表中，实现思路其实是差不多的，这里首先需要介绍一下两种表概念：</p>
<ul>
<li><strong>逻辑表：</strong> 相同结构的水平拆分数据库（表）的逻辑名称，是 SQL 中表的逻辑标识。 例：订单数据根据主键尾数拆分为 10 张表，分别是 <code>t_order_0</code> 到 <code>t_order_9</code>，他们的逻辑表名为 <code>t_order</code></li>
<li><strong>真实表：</strong> 在水平拆分的数据库中真实存在的物理表。 即上个示例中的 <code>t_order_0</code> 到 <code>t_order_9</code></li>
</ul>
<p>现在我们就以一号数据库为例，那么我们在里面创建上面提到的两张表，之前的那个<code>test</code>表删不删都可以，就当做不存在就行了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">test_0</span><span class="w">  </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">passwd</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">test_1</span><span class="w">  </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">passwd</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/InHsNXA3E8dQBPa.jpg" alt="image-20220415110322981" />
    
  </figure>

</p>
<p>接着我们不要去修改任何的业务代码，Mybatis里面写的是什么依然保持原样，即使我们的表名已经变了，我们需要做的是通过路由来修改原有的SQL，配置如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">shardingsphere</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">sharding</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tables</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">test</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">actual-data-nodes</span><span class="p">:</span><span class="w"> </span><span class="l">db0.test_$-&gt;{0..1}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c">#现在我们来配置一下分表策略，注意这里是table-strategy上面是database-strategy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">table-strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            	</span><span class="c">#基本都跟之前是一样的</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">standard</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">sharding-column</span><span class="p">:</span><span class="w"> </span><span class="l">id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">sharding-algorithm-name</span><span class="p">:</span><span class="w"> </span><span class="l">my-alg</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">sharding-algorithms</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">my-alg</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          	</span><span class="c">#这里我们演示一下INLINE方式，我们可以自行编写表达式来决定</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">INLINE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">props</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            	</span><span class="c">#比如我们还是希望进行模2计算得到数据该去的表</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            	</span><span class="c">#只需要给一个最终的表名称就行了test_，后面的数字是表达式取模算出的</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            	</span><span class="c">#实际上这样写和MOD模式一模一样</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">algorithm-expression</span><span class="p">:</span><span class="w"> </span><span class="l">test_$-&gt;{id % 2}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="c">#没错，查询也会根据分片策略来进行，但是如果我们使用的是范围查询，那么依然会进行全量查询</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="c">#这个我们后面紧接着会讲，这里先写上吧</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">allow-range-query-with-inline-sharding</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span></code></pre></div><p>现在我们来测试一下，看看会不会按照我们的策略进行分表插入：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/OaRCMTJ1lnIicSd.jpg" alt="image-20220415112809843" />
    
  </figure>

</p>
<p>可以看到，根据我们的算法，原本的逻辑表被修改为了最终进行分表计算后的结果，我们来查看一下数据库：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/lfvgOjanPZHMNdr.jpg" alt="image-20220415112908760" />
    
  </figure>

</p>
<p>插入我们了解完毕了，我们来看看查询呢：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootTest</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ShardingJdbcTestApplicationTests</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl">    <span class="n">UserMapper</span> <span class="n">mapper</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">contextLoads</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">mapper</span><span class="o">.</span><span class="na">getUserById</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">mapper</span><span class="o">.</span><span class="na">getUserById</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/7K1WBk3s8HuMeOI.jpg" alt="image-20220415113139917" />
    
  </figure>

</p>
<p>可以看到，根据我们配置的策略，查询也会自动选择对应的表进行，是不是感觉有内味了。</p>
<p>那么如果是范围查询呢？</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Select</span><span class="o">(</span><span class="s">&#34;select * from test where id between #{start} and #{end}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">getUsersByIdRange</span><span class="o">(</span><span class="kt">int</span> <span class="n">start</span><span class="o">,</span> <span class="kt">int</span> <span class="n">end</span><span class="o">);</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootTest</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ShardingJdbcTestApplicationTests</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl">    <span class="n">UserMapper</span> <span class="n">mapper</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">contextLoads</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">mapper</span><span class="o">.</span><span class="na">getUsersByIdRange</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">5</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>我们来看看执行结果会怎么样：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/3Hj7s4xqEwiFXJB.jpg" alt="image-20220415113530971" />
    
  </figure>

</p>
<p>可以看到INLINE算法默认是不支持进行全量查询的，我们得将上面的配置项改成true：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">allow-range-query-with-inline-sharding</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><p>再次进行测试：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/WoQqNLCXJslBT3D.jpg" alt="image-20220415113652038" />
    
  </figure>

</p>
<p>可以看到，最终出来的SQL语句是直接对两个表都进行查询，然后求出一个并集出来作为最后的结果。</p>
<p>当然除了分片之外，还有广播表和绑定表机制，用于多种业务场景下，这里就不多做介绍了，详细请查阅官方文档。</p>


<h3 class="relative group">分布式序列算法 
    <div id="%E5%88%86%E5%B8%83%E5%BC%8F%E5%BA%8F%E5%88%97%E7%AE%97%E6%B3%95" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E5%BA%8F%E5%88%97%E7%AE%97%E6%B3%95" aria-label="锚点">#</a>
    </span>        
    
</h3>
<p>前面我们讲解了如何进行分库分表，接着我们来看看分布式序列算法。</p>
<p>在复杂分布式系统中，特别是微服构架中，往往需要对大量的数据和消息进行唯一标识。随着系统的复杂，数据的增多，分库分表成为了常见的方案，对数据分库分表后需要有一个唯一ID来标识一条数据或消息（如订单号、交易流水、事件编号等），此时一个能够生成全局唯一ID的系统是非常必要的。</p>
<p>比如我们之前创建过学生信息表、图书借阅表、图书管理表，所有的信息都会有一个ID作为主键，并且这个ID有以下要求：</p>
<ul>
<li>为了区别于其他的数据，这个ID必须是全局唯一的。</li>
<li>主键应该尽可能的保持有序，这样会大大提升索引的查询效率。</li>
</ul>
<p>那么我们在分布式系统下，如何保证ID的生成满足上面的需求呢？</p>
<ol>
<li>
<p><strong>使用UUID：</strong> UUID是由一组32位数的16进制数字随机构成的，我们可以直接使用JDK为我们提供的UUID类来创建：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">uuid</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">uuid</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>结果为<code>73d5219b-dc0f-4282-ac6e-8df17bcd5860</code>，生成速度非常快，可以看到确实是能够保证唯一性，因为每次都不一样，而且这么长一串那重复的概率真的是小的可怜。</p>
<p>但是它并不满足我们上面的第二个要求，也就是说我们需要尽可能的保证有序，而这里我们得到的都是一些无序的ID。</p>
</li>
<li>
<p><strong>雪花算法（Snowflake）：</strong></p>
<p>我们来看雪花算法，它会生成一个一个64bit大小的整型的ID，int肯定是装不下了。</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/lU9A4zjSIKvaxwh.jpg" alt="image-20220415150713707" />
    
  </figure>

</p>
<p>可以看到它主要是三个部分组成，时间+工作机器ID+序列号，时间以毫秒为单位，41个bit位能表示约70年的时间，时间纪元从2016年11月1日零点开始，可以使用到2086年，工作机器ID其实就是节点ID，每个节点的ID都不相同，那么就可以区分出来，10个bit位可以表示最多1024个节点，最后12位就是每个节点下的序列号，因此每台机器每毫秒就可以有4096个系列号。</p>
<p>这样，它就兼具了上面所说的唯一性和有序性了，但是依然是有缺点的，第一个是时间问题，如果机器时间出现倒退，那么就会导致生成重复的ID，并且节点容量只有1024个，如果是超大规模集群，也是存在隐患的。</p>
</li>
</ol>
<p>ShardingJDBC支持以上两种算法为我们自动生成ID，文档：https://shardingsphere.apache.org/document/5.1.0/cn/user-manual/shardingsphere-jdbc/builtin-algorithm/keygen/</p>
<p>这里，我们就是要ShardingJDBC来让我们的主键ID以雪花算法进行生成，首先是配置数据库，因为我们默认的id是int类型，装不下64位的，改一下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">yyds</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">test</span><span class="o">`</span><span class="w"> </span><span class="k">MODIFY</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">FIRST</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>接着我们需要修改一下Mybatis的插入语句，因为现在id是由ShardingJDBC自动生成，我们就不需要自己加了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Insert</span><span class="o">(</span><span class="s">&#34;insert into test(name, passwd) values(#{name}, #{passwd})&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">addUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>
</span></span></code></pre></div><p>接着我们在配置文件中将我们的算法写上：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">shardingsphere</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">datasource</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">sharding</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tables</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">test</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">actual-data-nodes</span><span class="p">:</span><span class="w"> </span><span class="l">db0.test,db1.test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c">#这里还是使用分库策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">database-strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">standard</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">sharding-column</span><span class="p">:</span><span class="w"> </span><span class="l">id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">sharding-algorithm-name</span><span class="p">:</span><span class="w"> </span><span class="l">my-alg</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c">#这里使用自定义的主键生成策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">key-generate-strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">column</span><span class="p">:</span><span class="w"> </span><span class="l">id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">key-generator-name</span><span class="p">:</span><span class="w"> </span><span class="l">my-gen</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">key-generators</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        	</span><span class="c">#这里写我们自定义的主键生成算法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">my-gen</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          	</span><span class="c">#使用雪花算法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">SNOWFLAKE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">props</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            	</span><span class="c">#工作机器ID，保证唯一就行</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">worker-id</span><span class="p">:</span><span class="w"> </span><span class="m">666</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">sharding-algorithms</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">my-alg</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">MOD</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">props</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">sharding-count</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span></code></pre></div><p>接着我们来编写一下测试用例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootTest</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ShardingJdbcTestApplicationTests</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl">    <span class="n">UserMapper</span> <span class="n">mapper</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">contextLoads</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">mapper</span><span class="o">.</span><span class="na">addUser</span><span class="o">(</span><span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="s">&#34;aaa&#34;</span><span class="o">,</span> <span class="s">&#34;bbb&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>可以看到日志：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/2JBaqnV8k9OWYfw.jpg" alt="image-20220415154524545" />
    
  </figure>

</p>
<p>在插入的时候，将我们的SQL语句自行添加了一个id字段，并且使用的是雪花算法生成的值，并且也是根据我们的分库策略在进行插入操作。</p>


<h3 class="relative group">读写分离 
    <div id="%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB" aria-label="锚点">#</a>
    </span>        
    
</h3>
<p>最后我们来看看读写分离，我们之前实现了MySQL的主从，那么我们就可以将主库作为读，从库作为写：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/KRBbGXxhkmUHFIr.jpg" alt="image-20220415155842834" />
    
  </figure>

</p>
<p>这里我们还是将数据库变回主从状态，直接删除当前的表，我们重新来过：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">drop</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">test</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>我们需要将从库开启只读模式，在MySQL配置中进行修改：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">read-only</span>    <span class="o">=</span> <span class="s">1</span>
</span></span></code></pre></div><p>这样从库就只能读数据了（但是root账号还是可以写数据），接着我们重启服务器：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo systemctl restart mysql.service
</span></span></code></pre></div><p>然后进入主库，看看状态：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/8o4YIB5MysaUuFx.jpg" alt="image-20220415160249024" />
    
  </figure>

</p>
<p>现在我们配置一下从库：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">change</span><span class="w"> </span><span class="n">replication</span><span class="w"> </span><span class="k">source</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">SOURCE_HOST</span><span class="o">=</span><span class="s1">&#39;192.168.0.13&#39;</span><span class="p">,</span><span class="n">SOURCE_USER</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span><span class="n">SOURCE_PASSWORD</span><span class="o">=</span><span class="s1">&#39;123456&#39;</span><span class="p">,</span><span class="n">SOURCE_LOG_FILE</span><span class="o">=</span><span class="s1">&#39;binlog.000007&#39;</span><span class="p">,</span><span class="n">SOURCE_LOG_POS</span><span class="o">=</span><span class="mi">19845</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">start</span><span class="w"> </span><span class="n">replica</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>现在我们在主库创建表：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">test</span><span class="w">  </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">passwd</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>然后我们就可以配置ShardingJDBC了，打开配置文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">shardingsphere</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    	</span><span class="c">#配置读写分离</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">readwrite-splitting</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">data-sources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        	</span><span class="c">#名称随便写</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">user-db</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          	</span><span class="c">#使用静态类型，动态Dynamic类型可以自动发现auto-aware-data-source-name，这里不演示</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Static</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">props</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            	</span><span class="c">#配置写库（只能一个）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">write-data-source-name</span><span class="p">:</span><span class="w"> </span><span class="l">db0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="c">#配置从库（多个，逗号隔开）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">read-data-source-names</span><span class="p">:</span><span class="w"> </span><span class="l">db1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="c">#负载均衡策略，可以自定义</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">load-balancer-name</span><span class="p">:</span><span class="w"> </span><span class="l">my-load</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">load-balancers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        	</span><span class="c">#自定义的负载均衡策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">my-load</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ROUND_ROBIN</span><span class="w">
</span></span></span></code></pre></div><p>注意把之前改的用户实体类和Mapper改回去，这里我们就不用自动生成ID的了。所有的负载均衡算法地址：https://shardingsphere.apache.org/document/5.1.0/cn/user-manual/shardingsphere-jdbc/builtin-algorithm/load-balance/</p>
<p>现在我们就来测试一下吧：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootTest</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ShardingJdbcTestApplicationTests</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl">    <span class="n">UserMapper</span> <span class="n">mapper</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">contextLoads</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">mapper</span><span class="o">.</span><span class="na">addUser</span><span class="o">(</span><span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="s">&#34;aaa&#34;</span><span class="o">,</span> <span class="s">&#34;bbb&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">mapper</span><span class="o">.</span><span class="na">getUserById</span><span class="o">(</span><span class="mi">10</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>运行看看SQL日志：</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/07/zJvqKmfyhVMFLtZ.jpg" alt="image-20220415162741466" />
    
  </figure>

</p>
<p>可以看到，当我们执行插入操作时，会直接向db0进行操作，而读取操作是会根据我们的配置，选择db1进行操作。</p>
<p>至此，微服务应用章节到此结束。</p>
<p>————————————————
版权声明：本文为柏码知识库版权所有，禁止一切未经授权的转载、发布、出售等行为，违者将被追究法律责任。
原文链接：https://www.itbaima.cn/document/35v1hbsfcdgagdnw</p>

        </div>
        
        

        
<details style="margin-left:0px" class="mt-2 mb-5 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5">
    
    <summary
        class="py-1 text-lg font-semibold cursor-pointer bg-primary-200 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-primary-800 dark:text-neutral-100">
        cloud - 这是系列文章之一.
    </summary>
    
    
    
    <div
        class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
        <a href="/doc/cloud/%E4%B8%80/">
            部分 1: SpringCloud 1
        </a>
    </div>
    
    
    
    <div
        class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
        <a href="/doc/cloud/%E4%B8%89/">
            部分 2: SpringCloud 2
        </a>
    </div>
    
    
    
    <div
        class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
        部分 3: 本文
    </div>
    
    


</details>

        
  
  <section class="flex flex-row flex-wrap justify-center pt-4 text-xl">
    
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://twitter.com/intent/tweet/?url=/doc/cloud/%E4%BA%8C/&amp;text=SpringCloud%203"
      title="分享到 Twitter"
      aria-label="分享到 Twitter"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://t.me/share/url?url=/doc/cloud/%E4%BA%8C/&amp;resubmit=true&amp;title=SpringCloud%203"
      title=""
      aria-label=""
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M248,8C111.033,8,0,119.033,0,256S111.033,504,248,504,496,392.967,496,256,384.967,8,248,8ZM362.952,176.66c-3.732,39.215-19.881,134.378-28.1,178.3-3.476,18.584-10.322,24.816-16.948,25.425-14.4,1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25,5.342-39.5,3.652-3.793,67.107-61.51,68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608,69.142-14.845,10.194-26.894,9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7,18.45-13.7,108.446-47.248,144.628-62.3c68.872-28.647,83.183-33.623,92.511-33.789,2.052-.034,6.639.474,9.61,2.885a10.452,10.452,0,0,1,3.53,6.716A43.765,43.765,0,0,1,362.952,176.66Z"/></svg>

  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="mailto:?body=/doc/cloud/%E4%BA%8C/&amp;subject=SpringCloud%203"
      title="通过电子邮件发送"
      aria-label="通过电子邮件发送"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1c-27.64 140.9 68.65 266.2 199.1 285.1c19.01 2.888 36.17-12.26 36.17-31.49l.0001-.6631c0-15.74-11.44-28.88-26.84-31.24c-84.35-12.98-149.2-86.13-149.2-174.2c0-102.9 88.61-185.5 193.4-175.4c91.54 8.869 158.6 91.25 158.6 183.2l0 16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98 .0036c-7.299 0-13.2 4.992-15.12 11.68c-24.85-12.15-54.24-16.38-86.06-5.106c-38.75 13.73-68.12 48.91-73.72 89.64c-9.483 69.01 43.81 128 110.9 128c26.44 0 50.43-9.544 69.59-24.88c24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3C495.1 107.1 361.2-9.332 207.8 20.73zM239.1 304.3c-26.47 0-48-21.56-48-48.05s21.53-48.05 48-48.05s48 21.56 48 48.05S266.5 304.3 239.1 304.3z"/></svg>

  </span>


    </a>
      
    
  </section>


        


<h2 class="mt-8 text-2xl font-extrabold mb-10">相关文章</h2>
<section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3">
  
  

  <a href="/doc/cloud/%E4%B8%80/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/doc/cloud/%E4%B8%80/featured_hu7abcaa5e0ae44b563635c1e97a6d7c3c_740393_600x0_resize_q75_box.jpeg);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/doc/cloud/%E4%B8%80/">SpringCloud 1</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  







  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="0001-01-01 00:00:00 &#43;0000 UTC">1 January 0001</time><span class="px-2 text-primary-500">&middot;</span><span title="预计阅读">9 分钟</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
  
  
</div>



        </div>

        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>
  
  

  <a href="/doc/cloud/%E4%B8%89/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/doc/cloud/%E4%B8%89/featured_hu7abcaa5e0ae44b563635c1e97a6d7c3c_740393_600x0_resize_q75_box.jpeg);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/doc/cloud/%E4%B8%89/">SpringCloud 2</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  







  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="0001-01-01 00:00:00 &#43;0000 UTC">1 January 0001</time><span class="px-2 text-primary-500">&middot;</span><span title="预计阅读">11 分钟</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
  
  
</div>



        </div>

        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>
  
  

  <a href="/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/%E7%BC%93%E5%AD%98/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/%E7%BC%93%E5%AD%98/featured_hua0ceea336368c2b5da8818142adc90bd_8145_600x0_resize_box_3.png);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/%E7%BC%93%E5%AD%98/">Redis</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  







  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2023-10-03 20:31:04 &#43;0800 CST">3 October 2023</time><span class="px-2 text-primary-500">&middot;</span><span title="预计阅读">2 分钟</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/%E7%BC%93%E5%AD%98/&#34;,'_self');">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    缓存
  </span>
</span>
  </span>
  
  
  
  
</div>



        </div>

        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>
  
</section>

  
      </div>
     
      
      
        
        
      <script>
        var oid = "views_doc\\cloud\\二\\index.md"
        var oid_likes = "likes_doc\\cloud\\二\\index.md"
      </script>
      
      
      
      <script type="text/javascript" src="/js/page.min.b06a29d42a4ed16787978e2eee1e8c797b7698db2bc14ccee78f5c80ac566fc996190a73ad80a5e987558474b20b96fa38f7d85b405f165ff72b7b163c5ad11b.js" integrity="sha512-sGop1CpO0WeHl44u7h6MeXt2mNsrwUzO549cgKxWb8mWGQpzrYCl6YdVhHSyC5b6OPfYW0BfFl/3K3sWPFrRGw=="></script>
  
    </section>
  <footer class="pt-8 max-w-prose print:hidden">

    
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="flex group mr-3" href="/doc/design/%E5%88%9B%E5%BB%BA%E5%9E%8B/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E7%B3%BB%E5%88%97-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%BA%8C%E5%88%9B%E5%BB%BA%E5%9E%8B/">
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >创建型</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="0001-01-01 00:00:00 &#43;0000 UTC">1 January 0001</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="flex text-right group ml-3" href="/doc/cloud/%E4%B8%89/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >SpringCloud 2</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="0001-01-01 00:00:00 &#43;0000 UTC">1 January 0001</time>
                  
                </span>
              </span>
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
            </a>
          
        </span>
      </div>
    </div>
  


    
    
    <div class="pt-3">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="pt-3">
        















<br/>
<span style="color:rgba(var(--color-neutral-400),var(--tw-text-opacity));">
    <span class="post-meta-item-text" >&nbsp;&nbsp;:  </span>
    <span class="waline-pageview-count">⏳</span><div></div><br/>
</span>






<script src='/waline/waline.js'></script>
<link href='/waline/waline.css' rel='stylesheet' />
<div id="vcomments"></div>
<script>
    if (""=="zh-CN") {
        Waline.init({
            el: '#vcomments',
            serverURL: 'https://comment-eosin.vercel.app/',
            emoji: ['https://valine-emoji.bili33.top/bilibilitv','https://valine-emoji.bili33.top/bilibiliHotKey','https://valine-emoji.bili33.top/Tieba-New','https://valine-emoji.bili33.top/weibo',],
            meta:['nick', 'mail', 'link'],
            pageview: true,
            reaction: true,
            lang: "zh-CN",
            locale: {
                reactionTitle: '•畅所欲言——这里是开放区•',
                comment: '留言板',
                placeholder: '点击下方登录后再评论，会有惊喜哦~',
                gifSearchPlaceholder: '搜索表情包...',
                admin: '作者',
                sofa: '还没有人评论，快来抢沙发吧',
                anonymous: '匿名者'
            }
        });

    }
    else {
        Waline.init({
            el: '#vcomments',
            serverURL: 'https://comment-eosin.vercel.app/',
            emoji: ['https://valine-emoji.bili33.top/bilibilitv','https://valine-emoji.bili33.top/bilibiliHotKey','https://valine-emoji.bili33.top/Tieba-New','https://valine-emoji.bili33.top/weibo',],
            meta:['nick', 'mail'],
            pageview: true,
            reaction: true,
            
            lang: "zh-CN",
            locale: {
                reactionTitle: '•畅所欲言——这里是开放区•',
                comment: '留言板',
                placeholder: '点击下方登录后再评论，会有惊喜哦~',
                gifSearchPlaceholder: '搜索表情包...',
                admin: '作者',
                sofa: '还没有人评论，快来抢沙发吧',
                anonymous: '匿名者'
            }
    });

    }
    document.getElementsByClassName('wl-power')[0].style.display = 'none';
    document.querySelector(".wl-actions a").style.display = 'none'
</script>
<style type="text/css">
    :root{
        --waline-color: var(--tw-prose-quotes);
        --waline-info-color: var(--tw-prose-quotes);
        --waline-info-bgcolor: var(--tw-ring-color);
        --waline-theme-color: rgba(var(--color-primary-400));
        --waline-bgcolor: transparent;
        --waline-border-color: #747474;
    }
    .wl-editor:focus, .wl-input:focus {
        background: transparent;
    }
    .wl-editor,.wl-input{
        max-width:88%;
    }
    .wl-reaction-item.active .wl-reaction-votes {
        color: white;
    }
</style>

<script type="text/javascript">
    var pagect = document.getElementById('pagec');
    var observer = new MutationObserver(function(){
        var itl,itll;
        var element = document.getElementById("pagec");
        observer.disconnect();
        itl  = element.innerText;
        itll = Number(itl).toLocaleString();
        document.getElementById('pagec').innerHTML = itll;
    });
    var article = document.getElementById('pagec');

    var options = {
        'childList': true,
        'subtree': true
    };

    observer.observe(article, options);
</script>

      </div>
    </div>
    
    
  </footer>
</article>

      <div id="top-scroller" class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0">
  <a href="#the-top"
    class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="回到顶部" title="回到顶部">
    &uarr;
  </a>
</div>
    </main>

<div class="busuanzi-footer" style="margin-top: 40px">
  <span id="busuanzi_container_site_pv">
    本站总访问量<span id="busuanzi_value_site_pv"></span>次
  </span>
  <span id="busuanzi_container_site_uv">
    本站访客数<span id="busuanzi_value_site_uv"></span>人次
  </span>
</div><footer id="site-footer" class="py-10 print:hidden">
  
  
    
    <nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400">
      <ul class="flex flex-col list-none sm:flex-row">
        
        <li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
          <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href="/tags/"
            title="Tags">系列文章</a>
        </li>
        
        <li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
          <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href="/tasks/"
            title="学习计划">事项</a>
        </li>
        
        <li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
          <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href="/info/"
            title="应该没人来这里吧">关于我</a>
        </li>
        
        <li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
          <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href="/doc/"
            title="Docs">文档</a>
        </li>
        
      </ul>
    </nav>
    
  
  <div class="flex items-center justify-between">

    
    
    <p class="text-sm text-neutral-500 dark:text-neutral-400">
      &copy;
      2024
      春江花朝秋月夜
    </p>
    

    
    
    <p class="text-xs text-neutral-500 dark:text-neutral-400">
      
      
      由 <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://blowfish.page/" target="_blank" rel="noopener noreferrer">Blowfish</a> 强力驱动
    </p>
    

  </div>
  <script>
    
    mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
      margin: 24,
      background: 'rgba(0,0,0,0.5)',
      scrollOffset: 0,
    })
    
  </script>
  
  
  <script type="text/javascript" src="/js/process.min.62060bb247f4de2b6dde45903668fefb68d792f365587605177b1227c0cf43588701edaca0cb40e2c8e2789bd5ce67c1d2a215b9fb258c3496a7cd25e7cb5fdf.js" integrity="sha512-YgYLskf03itt3kWQNmj&#43;&#43;2jXkvNlWHYFF3sSJ8DPQ1iHAe2soMtA4sjieJvVzmfB0qIVufsljDSWp80l58tf3w=="></script>
  
  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]"
  data-url="/"
  style="z-index:500"
>
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"
  >
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="搜索"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="关闭 (Esc)"
      >
        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>


      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

  </div>
</body>

</html>
