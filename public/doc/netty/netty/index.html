<!DOCTYPE html>
<html lang="zh-CN" dir="ltr" class="scroll-smooth" data-default-appearance="dark"
  data-auto-appearance="true"><head>

  <meta charset="utf-8" />
  
  <meta http-equiv="content-language" content="zh-CN" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>Netty &middot; æ˜¥æ±ŸèŠ±æœç§‹æœˆå¤œ</title>
  <meta name="title" content="Netty &middot; æ˜¥æ±ŸèŠ±æœç§‹æœˆå¤œ" />
  
  <meta name="description" content="A powerful, lightweight theme for Hugo built with Tailwind CSS." />
  
  
  
  <link rel="canonical" href="/doc/netty/netty/" />
  
  
  
  
  
  
  
  
  
  
  <link type="text/css" rel="stylesheet" href="/css/main.bundle.min.ac59a1b8eaafef739c129d12787ac29f6a420bcb348c7aeec8949a8d0b7d6c2023766c169d14b9031b751504eb3c976efe786fec135b340a49868acd8caa4127.css"
    integrity="sha512-rFmhuOqv73OcEp0SeHrCn2pCC8s0jHruyJSajQt9bCAjdmwWnRS5Axt1FQTrPJdu/nhv7BNbNApJhorNjKpBJw==" />
  
  
  <script type="text/javascript" src="/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js"
    integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj&#43;e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script>
  
  
  
  
  
  
  
  
  
  
  
  
  <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.b08c533d390e8a0f23aec728c42c75cd20d5647891674e96b16374298da81849d9cc269102ec8558979f8bdae7563d3c83bce1fe3f5796d64edfb400aac4576f.js"
    integrity="sha512-sIxTPTkOig8jrscoxCx1zSDVZHiRZ06WsWN0KY2oGEnZzCaRAuyFWJefi9rnVj08g7zh/j9XltZO37QAqsRXbw==" data-copy="" data-copied=""></script>
  
  
  <script src="/js/zoom.min.js"></script>
  
  
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  <meta property="og:title" content="Netty" />
<meta property="og:description" content="Nettyæ¡†æ¶ #å‰é¢æˆ‘ä»¬å­¦ä¹ äº†Javaä¸ºæˆ‘ä»¬æä¾›çš„NIOæ¡†æ¶ï¼Œæä¾›ä½¿ç”¨NIOæä¾›çš„ä¸‰å¤§ç»„ä»¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç¼–å†™æ›´åŠ é«˜æ€§èƒ½çš„å®¢æˆ·ç«¯/æœåŠ¡ç«¯ç½‘ç»œç¨‹åºäº†ï¼Œç”šè‡³è¿˜å¯ä»¥è‡ªè¡Œè§„å®šä¸€ç§é€šä¿¡åè®®è¿›è¡Œé€šä¿¡ã€‚
NIOæ¡†æ¶å­˜åœ¨çš„é—®é¢˜ #ä½†æ˜¯ä¹‹å‰æˆ‘ä»¬åœ¨ä½¿ç”¨NIOæ¡†æ¶çš„æ—¶å€™ï¼Œè¿˜æ˜¯å‘ç°äº†ä¸€äº›é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆæ¥ç›˜ç‚¹ä¸€ä¸‹ã€‚
å®¢æˆ·ç«¯å…³é—­å¯¼è‡´æœåŠ¡ç«¯ç©ºè½®è¯¢ #å¯èƒ½åœ¨ä¹‹å‰çš„å®éªŒä¸­ï¼Œä½ å‘ç°äº†è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼š
å½“æˆ‘ä»¬çš„å®¢æˆ·ç«¯ä¸»åŠ¨ä¸æœåŠ¡ç«¯æ–­å¼€è¿æ¥æ—¶ï¼Œä¼šå¯¼è‡´READäº‹ä»¶ä¸€ç›´è¢«è§¦å‘ï¼Œä¹Ÿå°±æ˜¯è¯´selector.select()ä¼šç›´æ¥é€šè¿‡ï¼Œå¹¶ä¸”æ˜¯å¯è¯»çš„çŠ¶æ€ï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°å®é™…ä¸Šè¯»åˆ°æ˜¯æ•°æ®æ˜¯ä¸€ä¸ªç©ºçš„ï¼ˆä¸Šé¢çš„å›¾ä¸­åœ¨ç©ºè½®è¯¢ä¸¤æ¬¡åæŠ›å‡ºå¼‚å¸¸äº†ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯æ— é™çš„å¾ªç¯ä¸‹å»ï¼‰æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¾—ç¨å¾®å¤„ç†ä¸€ä¸‹ï¼š
} else if(key.isReadable()) { SocketChannel channel = (SocketChannel) key.channel(); ByteBuffer buffer = ByteBuffer.allocate(128); //è¿™é‡Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­ä¸€ä¸‹ï¼Œå¦‚æœreadæ“ä½œå¾—åˆ°çš„ç»“æœæ˜¯-1ï¼Œé‚£ä¹ˆè¯´æ˜æœåŠ¡ç«¯å·²ç»æ–­å¼€è¿æ¥äº† if(channel.read(buffer) &lt; 0) { System.out.println(&#34;å®¢æˆ·ç«¯å·²ç»æ–­å¼€è¿æ¥äº†ï¼š&#34;&#43;channel.getRemoteAddress()); channel." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/doc/netty/netty/" /><meta property="og:image" content="/doc/netty/netty/featured.jpg"/><meta property="article:section" content="doc" />


<meta property="og:see_also" content="/doc/netty/nio/" />


  <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="/doc/netty/netty/featured.jpg"/>
<meta name="twitter:title" content="Netty"/>
<meta name="twitter:description" content="Nettyæ¡†æ¶ #å‰é¢æˆ‘ä»¬å­¦ä¹ äº†Javaä¸ºæˆ‘ä»¬æä¾›çš„NIOæ¡†æ¶ï¼Œæä¾›ä½¿ç”¨NIOæä¾›çš„ä¸‰å¤§ç»„ä»¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç¼–å†™æ›´åŠ é«˜æ€§èƒ½çš„å®¢æˆ·ç«¯/æœåŠ¡ç«¯ç½‘ç»œç¨‹åºäº†ï¼Œç”šè‡³è¿˜å¯ä»¥è‡ªè¡Œè§„å®šä¸€ç§é€šä¿¡åè®®è¿›è¡Œé€šä¿¡ã€‚
NIOæ¡†æ¶å­˜åœ¨çš„é—®é¢˜ #ä½†æ˜¯ä¹‹å‰æˆ‘ä»¬åœ¨ä½¿ç”¨NIOæ¡†æ¶çš„æ—¶å€™ï¼Œè¿˜æ˜¯å‘ç°äº†ä¸€äº›é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆæ¥ç›˜ç‚¹ä¸€ä¸‹ã€‚
å®¢æˆ·ç«¯å…³é—­å¯¼è‡´æœåŠ¡ç«¯ç©ºè½®è¯¢ #å¯èƒ½åœ¨ä¹‹å‰çš„å®éªŒä¸­ï¼Œä½ å‘ç°äº†è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼š
å½“æˆ‘ä»¬çš„å®¢æˆ·ç«¯ä¸»åŠ¨ä¸æœåŠ¡ç«¯æ–­å¼€è¿æ¥æ—¶ï¼Œä¼šå¯¼è‡´READäº‹ä»¶ä¸€ç›´è¢«è§¦å‘ï¼Œä¹Ÿå°±æ˜¯è¯´selector.select()ä¼šç›´æ¥é€šè¿‡ï¼Œå¹¶ä¸”æ˜¯å¯è¯»çš„çŠ¶æ€ï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°å®é™…ä¸Šè¯»åˆ°æ˜¯æ•°æ®æ˜¯ä¸€ä¸ªç©ºçš„ï¼ˆä¸Šé¢çš„å›¾ä¸­åœ¨ç©ºè½®è¯¢ä¸¤æ¬¡åæŠ›å‡ºå¼‚å¸¸äº†ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯æ— é™çš„å¾ªç¯ä¸‹å»ï¼‰æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¾—ç¨å¾®å¤„ç†ä¸€ä¸‹ï¼š
} else if(key.isReadable()) { SocketChannel channel = (SocketChannel) key.channel(); ByteBuffer buffer = ByteBuffer.allocate(128); //è¿™é‡Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­ä¸€ä¸‹ï¼Œå¦‚æœreadæ“ä½œå¾—åˆ°çš„ç»“æœæ˜¯-1ï¼Œé‚£ä¹ˆè¯´æ˜æœåŠ¡ç«¯å·²ç»æ–­å¼€è¿æ¥äº† if(channel.read(buffer) &lt; 0) { System.out.println(&#34;å®¢æˆ·ç«¯å·²ç»æ–­å¼€è¿æ¥äº†ï¼š&#34;&#43;channel.getRemoteAddress()); channel."/>

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Docs",
    "name": "Netty",
    "headline": "Netty",
    
    "abstract": "Nettyæ¡†æ¶ #\rå‰é¢æˆ‘ä»¬å­¦ä¹ äº†Javaä¸ºæˆ‘ä»¬æä¾›çš„NIOæ¡†æ¶ï¼Œæä¾›ä½¿ç”¨NIOæä¾›çš„ä¸‰å¤§ç»„ä»¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç¼–å†™æ›´åŠ é«˜æ€§èƒ½çš„å®¢æˆ·ç«¯\/æœåŠ¡ç«¯ç½‘ç»œç¨‹åºäº†ï¼Œç”šè‡³è¿˜å¯ä»¥è‡ªè¡Œè§„å®šä¸€ç§é€šä¿¡åè®®è¿›è¡Œé€šä¿¡ã€‚\nNIOæ¡†æ¶å­˜åœ¨çš„é—®é¢˜ #\rä½†æ˜¯ä¹‹å‰æˆ‘ä»¬åœ¨ä½¿ç”¨NIOæ¡†æ¶çš„æ—¶å€™ï¼Œè¿˜æ˜¯å‘ç°äº†ä¸€äº›é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆæ¥ç›˜ç‚¹ä¸€ä¸‹ã€‚\nå®¢æˆ·ç«¯å…³é—­å¯¼è‡´æœåŠ¡ç«¯ç©ºè½®è¯¢ #\rå¯èƒ½åœ¨ä¹‹å‰çš„å®éªŒä¸­ï¼Œä½ å‘ç°äº†è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼š\nå½“æˆ‘ä»¬çš„å®¢æˆ·ç«¯ä¸»åŠ¨ä¸æœåŠ¡ç«¯æ–­å¼€è¿æ¥æ—¶ï¼Œä¼šå¯¼è‡´READäº‹ä»¶ä¸€ç›´è¢«è§¦å‘ï¼Œä¹Ÿå°±æ˜¯è¯´selector.select()ä¼šç›´æ¥é€šè¿‡ï¼Œå¹¶ä¸”æ˜¯å¯è¯»çš„çŠ¶æ€ï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°å®é™…ä¸Šè¯»åˆ°æ˜¯æ•°æ®æ˜¯ä¸€ä¸ªç©ºçš„ï¼ˆä¸Šé¢çš„å›¾ä¸­åœ¨ç©ºè½®è¯¢ä¸¤æ¬¡åæŠ›å‡ºå¼‚å¸¸äº†ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯æ— é™çš„å¾ªç¯ä¸‹å»ï¼‰æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¾—ç¨å¾®å¤„ç†ä¸€ä¸‹ï¼š\n} else if(key.isReadable()) { SocketChannel channel = (SocketChannel) key.channel(); ByteBuffer buffer = ByteBuffer.allocate(128); \/\/è¿™é‡Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­ä¸€ä¸‹ï¼Œå¦‚æœreadæ“ä½œå¾—åˆ°çš„ç»“æœæ˜¯-1ï¼Œé‚£ä¹ˆè¯´æ˜æœåŠ¡ç«¯å·²ç»æ–­å¼€è¿æ¥äº† if(channel.read(buffer) \u0026lt; 0) { System.out.println(\u0026#34;å®¢æˆ·ç«¯å·²ç»æ–­å¼€è¿æ¥äº†ï¼š\u0026#34;\u002bchannel.getRemoteAddress()); channel.",
    "inLanguage": "zh-CN",
    "url" : "\/doc\/netty\/netty\/",
    "author" : {
      "@type": "Person",
      "name": "æ˜¥æ±ŸèŠ±æœç§‹æœˆå¤œ"
    },
    
    
    
    
    
    
    
    
    "mainEntityOfPage": "true",
    "wordCount": "3550"
  }]
  </script>


  
  
  <meta name="author" content="æ˜¥æ±ŸèŠ±æœç§‹æœˆå¤œ" />
  
  
  
  <link href="https://space.bilibili.com/159283119?spm_id_from=333.1007.0.0" rel="me" />
  
  
  <link href="https://github.com/ToDreamr" rel="me" />
  
  
  <link href="https://music.163.com/#/user/home?id=568083850" rel="me" />
  
  
  <link href="https://gitee.com/rainyheights" rel="me" />
  
  
  <link href="https://www.zhihu.com/people/san-qiu-luo-yue" rel="me" />
  
  
  
  

<script src="/lib/jquery/jquery.slim.min.js" integrity=""></script>





















  
  

<script async src="https://www.googletagmanager.com/gtag/js?id=G-PEDMYR1V0K"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-PEDMYR1V0K');
</script>


  
  
  <meta name="theme-color"/>

  
  

  
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <meta name="referrer" content="no-referrer-when-downgrade"></head>


<body
  class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32">
  <div id="the-top" class="absolute flex self-center">
    <a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
      href="#main-content"><span
        class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>è·³åˆ°æ–‡ç« å¼€å¤´</a>
  </div>
  
  
  <div class="min-h-[148px]"></div>
<div class="fixed inset-x-0 pl-[24px] pr-[24px]" style="z-index:100">
  <div id="menu-blur" class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl"></div>
  <div class="relative max-w-[64rem] ml-auto mr-auto">
    <div id="top-menu" style="padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px ;height: 70px;font-family: åæ–‡ä¸­å®‹,serif;"
     class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3" >
  
  
  
  <div>
    <a href="/" class="flex">
    <span class="sr-only">æ˜¥æ±ŸèŠ±æœç§‹æœˆå¤œ</span>

    <img src="/img/author.png" width="16" height="16"
         class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt="æ˜¥æ±ŸèŠ±æœç§‹æœˆå¤œ" />

    </a>
  </div>
  

  <div class="flex flex-1 items-center justify-between">

    <nav class="flex space-x-3">

      
      <a id="title-href" href="/" class="text-base font-medium text-gray-500 hover:text-gray-900">æ˜¥æ±ŸèŠ±æœç§‹æœˆå¤œ</a>
      

    </nav>
    <nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12">

      
      
      
  <a href="/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        é¦–é¡µ
    </p>
</a>


      
      
  <a href="/all/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="å…¨éƒ¨">
        å…¨éƒ¨âœ…
    </p>
</a>


      
      
  <a href="/algorithm/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="Algorithms">
        ç®—æ³•ğŸ¾
    </p>
</a>


      
      
  <a href="/tags/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="Tags">
        å½’ç±»âœˆï¸
    </p>
</a>


      
      
  <a href="/friend/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="friend">
        å‹é“¾ğŸ§‘â€ğŸ¤â€ğŸ§‘
    </p>
</a>


      
      
  <a href="/doc/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="Docs">
        æ–‡æ¡£ğŸ˜º
    </p>
</a>


      
      

      


      
      <button id="search-button" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400 h-12"
              title="">
      

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


      </button>

      


      
      
      <div
              class="ltr:mr-14 rtl:ml-14 cursor-pointer text-sm text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400">
        <button id="appearance-switcher" aria-label="Dark mode switcher" type="button">
          <div class="flex items-center justify-center h-12 dark:hidden">
            

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


          </div>
          <div class="items-center justify-center hidden h-12 dark:flex">
            

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


          </div>
        </button>

      </div>
      

    </nav>
    <div class="flex md:hidden items-center space-x-5 md:ml-12">

      <span></span>

      


      
      <button id="search-button-mobile" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
              title="">
      

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


      </button>
      

      
      
      <button id="appearance-switcher-mobile" aria-label="Dark mode switcher" type="button" style="margin-right:5px">
        <div class="flex items-center justify-center h-12 dark:hidden">
          

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


        </div>
        <div class="items-center justify-center hidden h-12 dark:flex">
          

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


        </div>
      </button>
      

    </div>

  </div>
  <div class="-my-2 -mr-2 md:hidden">

    <label id="menu-button" for="menu-controller" class="block">
      <input type="checkbox" id="menu-controller" class="hidden" />
      
      <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>

  </span>


      </div>
      <div id="menu-wrapper" style="padding-top:5px;"
           class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50">
        <ul
                class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl">

          <li>
                        <span
                                class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>

</span>
          </li>

          

          
  <li class="mt-1">
    <a href="/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            é¦–é¡µ
        </p>
    </a>
</li>



          

          
  <li class="mt-1">
    <a href="/all/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="å…¨éƒ¨">
            å…¨éƒ¨âœ…
        </p>
    </a>
</li>



          

          
  <li class="mt-1">
    <a href="/algorithm/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="Algorithms">
            ç®—æ³•ğŸ¾
        </p>
    </a>
</li>



          

          
  <li class="mt-1">
    <a href="/tags/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="Tags">
            å½’ç±»âœˆï¸
        </p>
    </a>
</li>



          

          
  <li class="mt-1">
    <a href="/friend/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="friend">
            å‹é“¾ğŸ§‘â€ğŸ¤â€ğŸ§‘
        </p>
    </a>
</li>



          

          
  <li class="mt-1">
    <a href="/doc/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="Docs">
            æ–‡æ¡£ğŸ˜º
        </p>
    </a>
</li>



          

        </ul>
        
        

      </div>
    </label>
  </div>






  </div>
<style>
  .change-music{
    margin-top: 20px;
    width: 8%;
    height: 50%;
    font-family: åæ–‡ä¸­å®‹,serif;
     
     
     
  }
</style>
<script>
  
  var MusicLists=[];
  var musicUrl="";
  function getMusicList()
  {
    
    MusicLists.push
    (29567192,1974443814,447926067,447925058,1974444808,
            1974444807,29567187
    );
    var musicIndex=Math.floor(Math.random()*MusicLists.length+1);
    console.log(musicIndex);
    
    musicUrl="https://music.163.com/outchain/player?type=2&id="+MusicLists[musicIndex]+"&auto=1&height=66";
    var frame=document.getElementById("music");
    var player=document.getElementsByName('player');
    console.log(player);
    frame.src=musicUrl;
  }
</script>






<script>
  (function () {
    var $mainmenu = $('.main-menu');
    var path = window.location.pathname;
    $mainmenu.find('a[href="' + path + '"]').each(function (i, e) {
      $(e).children('p').addClass('active');
    });
  })();
  
  (function (){
    var title=document.getElementById('title-href');
    var music=document.getElementById('music');
    var button=document.getElementById('music-button');
    var width=window.innerWidth;
    var height=window.innerHeight;
    if (width<420||height<820){
      title.innerText='Rainy-Heights'
      button.innerText='';
      music.style.width=0;
      music.style.height=0;
      button.style.height=0;
      button.style.height=0;
      var child = document.getElementById('music-div');
      var father = document.getElementById('top-menu');
      father.removeChild(child)
      father.removeChild(button)
    }
  })();
</script>


  </div>
</div>
<script>
  window.addEventListener('scroll', function (e) {
    var scroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
    var background_blur = document.getElementById('menu-blur');
    background_blur.style.opacity = (scroll / 300);
  });
</script>

  
  <div class="relative flex flex-col grow">
    <main id="main-content" class="grow">
      


<article>
  
  
  
  
  
  


<div id="hero" class="h-[150px] md:h-[200px]"></div>



    
    <div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom"
    style="background-image:url(/doc/netty/netty/featured_hu595fcd4c65cad9178cdf0f4127e395f6_424133_1200x0_resize_q75_box.jpg);">
    


    <div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal">
    </div>
    <div
        class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal">
    </div>
</div>

<div id="background-blur" class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div>
<script>
    window.addEventListener('scroll', function (e) {
        var scroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
        var background_blur = document.getElementById('background-blur');
        background_blur.style.opacity = (scroll / 300)
    });
</script>

  
  

  <header id="single_header" class="mt-5 max-w-prose">
    
    <ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden">
  
  
    
  
    
  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/"
      ></a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline ">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/doc/"
      >Docs</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/doc/netty/netty/"
      >Netty</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

</ol>


    
    <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
      Netty
    </h1>
    <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
      





  
  







  







  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="0001-01-01 00:00:00 &#43;0000 UTC">1 January 0001</time><span class="px-2 text-primary-500">&middot;</span><span title="é¢„è®¡é˜…è¯»">17 åˆ†é’Ÿ</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
  
  
</div>



    </div>

    
    
    
    
    

    

    
      
      
        
        
<div class="flex author">
  
    
    
      
    
    
      
        
      
      <img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width="96" height="96"
      alt="æ˜¥æ±ŸèŠ±æœç§‹æœˆå¤œ" src="/img/%E4%B8%89%E5%8F%B6_huefd8a5d2e6c0b8ff3aa6580d0e50af5a_1328716_192x192_fill_box_center_3.png" />
    
  
  <div class="place-self-center">
    
    <div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">
      ä½œè€…
    </div>
    <div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">
      æ˜¥æ±ŸèŠ±æœç§‹æœˆå¤œ
    </div>
    
    
    <div class="text-sm text-neutral-700 dark:text-neutral-400">é‡æ¹–å ğª©˜æ¸…å˜‰ã€‚æœ‰ä¸‰ç§‹æ¡‚å­ï¼Œåé‡Œè·èŠ±ã€‚ç¾Œç®¡å¼„æ™´ï¼Œè±æ­Œæ³›å¤œï¼Œå¬‰å¬‰é’“åŸè²å¨ƒã€‚åƒéª‘æ‹¥é«˜ç‰™ã€‚ä¹˜é†‰å¬ç®«é¼“ï¼ŒåŸèµçƒŸéœã€‚å¼‚æ—¥å›¾å°†å¥½æ™¯ï¼Œå½’å»å‡¤æ± å¤¸ã€‚</div>
    
    <div class="text-2xl sm:text-lg">
  <div class="flex flex-wrap text-neutral-400 dark:text-neutral-500">
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://space.bilibili.com/159283119?spm_id_from=333.1007.0.0"
          target="_blank"
          aria-label="Bilibili"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1699377062375" class="icon" viewBox="0 0 1129 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4167" xmlns:xlink="http://www.w3.org/1999/xlink" width="220.5078125" height="200"><path d="M234.909 9.656a80.468 80.468 0 0 1 68.398 0 167.374 167.374 0 0 1 41.843 30.578l160.937 140.82h115.07l160.936-140.82a168.983 168.983 0 0 1 41.843-30.578A80.468 80.468 0 0 1 930.96 76.445a80.468 80.468 0 0 1-17.703 53.914 449.818 449.818 0 0 1-35.406 32.187 232.553 232.553 0 0 1-22.531 18.508h100.585a170.593 170.593 0 0 1 118.289 53.109 171.397 171.397 0 0 1 53.914 118.288v462.693a325.897 325.897 0 0 1-4.024 70.007 178.64 178.64 0 0 1-80.468 112.656 173.007 173.007 0 0 1-92.539 25.75h-738.7a341.186 341.186 0 0 1-72.421-4.024A177.835 177.835 0 0 1 28.91 939.065a172.202 172.202 0 0 1-27.36-92.539V388.662a360.498 360.498 0 0 1 0-66.789A177.03 177.03 0 0 1 162.487 178.64h105.414c-16.899-12.07-31.383-26.555-46.672-39.43a80.468 80.468 0 0 1-25.75-65.984 80.468 80.468 0 0 1 39.43-63.57M216.4 321.873a80.468 80.468 0 0 0-63.57 57.937 108.632 108.632 0 0 0 0 30.578v380.615a80.468 80.468 0 0 0 55.523 80.469 106.218 106.218 0 0 0 34.601 5.632h654.208a80.468 80.468 0 0 0 76.444-47.476 112.656 112.656 0 0 0 8.047-53.109v-354.06a135.187 135.187 0 0 0 0-38.625 80.468 80.468 0 0 0-52.304-54.719 129.554 129.554 0 0 0-49.89-7.242H254.22a268.764 268.764 0 0 0-37.82 0z m0 0" fill="#20B0E3" p-id="4168"></path><path d="M348.369 447.404a80.468 80.468 0 0 1 55.523 18.507 80.468 80.468 0 0 1 28.164 59.547v80.468a80.468 80.468 0 0 1-16.094 51.5 80.468 80.468 0 0 1-131.968-9.656 104.609 104.609 0 0 1-10.46-54.719v-80.468a80.468 80.468 0 0 1 70.007-67.593z m416.02 0a80.468 80.468 0 0 1 86.102 75.64v80.468a94.148 94.148 0 0 1-12.07 53.11 80.468 80.468 0 0 1-132.773 0 95.757 95.757 0 0 1-12.875-57.133V519.02a80.468 80.468 0 0 1 70.007-70.812z m0 0" fill="#20B0E3" p-id="4169"></path></svg>
  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://github.com/ToDreamr"
          target="_blank"
          aria-label="Github"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://music.163.com/#/user/home?id=568083850"
          target="_blank"
          aria-label="Wangyi"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1707154946293" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2586" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M0 0m184.32 0l655.36 0q184.32 0 184.32 184.32l0 655.36q0 184.32-184.32 184.32l-655.36 0q-184.32 0-184.32-184.32l0-655.36q0-184.32 184.32-184.32Z" fill="#EA3E3C" p-id="2587"></path><path d="M527.616 849.43872a373.6064 373.6064 0 0 1-162.54976-39.00416c-112.36352-55.16288-180.00896-176.29184-172.55424-308.67456 7.41376-130.34496 85.10464-237.4656 202.752-279.552a35.85024 35.85024 0 0 1 24.15616 67.51232c-107.66336 38.49216-150.81472 136.86784-155.29984 216.13568-5.86752 103.51616 46.08 197.79584 132.34176 240.13824 124.69248 60.30336 216.91392 22.35392 260.82304-5.64224 59.8016-38.16448 97.86368-100.01408 96.95232-157.55264-1.024-63.72352-24.064-120.99584-63.27296-157.14304a145.408 145.408 0 0 0-65.5872-35.28704q2.82624 9.76896 5.64224 19.32288c13.38368 45.63968 24.94464 85.05344 25.6 114.40128a134.26688 134.26688 0 0 1-37.69344 97.76128 139.1104 139.1104 0 0 1-100.6592 40.45824 140.10368 140.10368 0 0 1-100.47488-42.24 169.12384 169.12384 0 0 1-46.2848-122.76736c1.19808-85.12512 80.11776-153.28256 162.816-175.104a324.80256 324.80256 0 0 1-6.71744-67.05152 92.0576 92.0576 0 0 1 69.18144-91.81184c46.21312-12.53376 104.448 5.19168 124.66176 37.888a35.84 35.84 0 0 1-11.70432 49.31584 35.84 35.84 0 0 1-49.26464-11.65312 62.34112 62.34112 0 0 0-48.45568-5.21216c-4.32128 1.71008-12.35968 4.90496-12.76928 23.10144a270.87872 270.87872 0 0 0 6.73792 58.51136 217.4976 217.4976 0 0 1 133.56032 57.6512c53.57568 49.38752 85.0432 125.46048 86.35392 208.71168 1.29024 81.85856-49.7664 167.86432-130.048 219.136a310.14912 310.14912 0 0 1-168.2432 48.65024z m23.6544-457.55392c-56.77056 15.6672-107.4688 63.03744-108.07296 106.42432a98.304 98.304 0 0 0 25.6512 71.43424 68.0448 68.0448 0 0 0 49.36704 20.87936 67.24608 67.24608 0 0 0 49.44896-18.944 63.19104 63.19104 0 0 0 17.23392-46.08c-0.4096-19.79392-11.7248-58.368-22.67136-95.6928-3.61472-12.42112-7.35232-25.14944-10.9568-38.02112z" fill="#FFFFFF" p-id="2588"></path></svg>
  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://gitee.com/rainyheights"
          target="_blank"
          aria-label="Gitee"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1707288792446" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6333" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M512 1024C230.4 1024 0 793.6 0 512S230.4 0 512 0s512 230.4 512 512-230.4 512-512 512z m259.2-569.6H480c-12.8 0-25.6 12.8-25.6 25.6v64c0 12.8 12.8 25.6 25.6 25.6h176c12.8 0 25.6 12.8 25.6 25.6V608c0 41.6-35.2 76.8-76.8 76.8h-240c-12.8 0-25.6-12.8-25.6-25.6V416c0-41.6 35.2-76.8 76.8-76.8h355.2c12.8 0 25.6-12.8 25.6-25.6v-64c0-12.8-12.8-25.6-25.6-25.6H416c-105.6 0-188.8 86.4-188.8 188.8V768c0 12.8 12.8 25.6 25.6 25.6h374.4c92.8 0 169.6-76.8 169.6-169.6V480c0-12.8-12.8-25.6-25.6-25.6z" fill="#888888" p-id="6334"></path></svg>
  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://www.zhihu.com/people/san-qiu-luo-yue"
          target="_blank"
          aria-label="Zhihu"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1707288662942" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5244" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M564.7 230.1V803h60l25.2 71.4L756.3 803h131.5V230.1H564.7z m247.7 497h-59.9l-75.1 50.4-17.8-50.4h-18V308.3h170.7v418.8zM526.1 486.9H393.3c2.1-44.9 4.3-104.3 6.6-172.9h130.9l-0.1-8.1c0-0.6-0.2-14.7-2.3-29.1-2.1-15-6.6-34.9-21-34.9H287.8c4.4-20.6 15.7-69.7 29.4-93.8l6.4-11.2-12.9-0.7c-0.8 0-19.6-0.9-41.4 10.6-35.7 19-51.7 56.4-58.7 84.4-18.4 73.1-44.6 123.9-55.7 145.6-3.3 6.4-5.3 10.2-6.2 12.8-1.8 4.9-0.8 9.8 2.8 13 10.5 9.5 38.2-2.9 38.5-3 0.6-0.3 1.3-0.6 2.2-1 13.9-6.3 55.1-25 69.8-84.5h56.7c0.7 32.2 3.1 138.4 2.9 172.9h-141l-2.1 1.5c-23.1 16.9-30.5 63.2-30.8 65.2l-1.4 9.2h167c-12.3 78.3-26.5 113.4-34 127.4-3.7 7-7.3 14-10.7 20.8-21.3 42.2-43.4 85.8-126.3 153.6-3.6 2.8-7 8-4.8 13.7 2.4 6.3 9.3 9.1 24.6 9.1 5.4 0 11.8-0.3 19.4-1 49.9-4.4 100.8-18 135.1-87.6 17-35.1 31.7-71.7 43.9-108.9L497 850l5-12c0.8-1.9 19-46.3 5.1-95.9l-0.5-1.8-108.1-123-22 16.6c6.4-26.1 10.6-49.9 12.5-71.1h158.7v-8c0-40.1-18.5-63.9-19.2-64.9l-2.4-3z" fill="#1296DB" p-id="5245"></path></svg>
  </span>

</span></a
        >
      
    
  </div>

</div>
  </div>
</div>

      

      

      
      <div class="mb-5"></div>
      

    

  </header>
  
  <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
    
     <div
      class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8">
      <div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-[140px]">

         <details open class="toc-right mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    ç›®å½•
  </summary>
  <div
    class="min-w-[220px] py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#nettyæ¡†æ¶">Nettyæ¡†æ¶</a>
      <ul>
        <li><a href="#nioæ¡†æ¶å­˜åœ¨çš„é—®é¢˜">NIOæ¡†æ¶å­˜åœ¨çš„é—®é¢˜</a>
          <ul>
            <li><a href="#å®¢æˆ·ç«¯å…³é—­å¯¼è‡´æœåŠ¡ç«¯ç©ºè½®è¯¢">å®¢æˆ·ç«¯å…³é—­å¯¼è‡´æœåŠ¡ç«¯ç©ºè½®è¯¢</a></li>
            <li><a href="#ç²˜åŒ…æ‹†åŒ…é—®é¢˜">ç²˜åŒ…/æ‹†åŒ…é—®é¢˜</a></li>
          </ul>
        </li>
        <li><a href="#èµ°è¿›nettyæ¡†æ¶">èµ°è¿›Nettyæ¡†æ¶</a>
          <ul>
            <li><a href="#bytebufä»‹ç»">ByteBufä»‹ç»</a></li>
            <li><a href="#é›¶æ‹·è´ç®€ä»‹">é›¶æ‹·è´ç®€ä»‹</a></li>
            <li><a href="#nettyå·¥ä½œæ¨¡å‹">Nettyå·¥ä½œæ¨¡å‹</a></li>
            <li><a href="#channelè¯¦è§£">Channelè¯¦è§£</a></li>
            <li><a href="#eventloopå’Œä»»åŠ¡è°ƒåº¦">EventLoopå’Œä»»åŠ¡è°ƒåº¦</a></li>
            <li><a href="#futureå’Œpromise">Futureå’ŒPromise</a></li>
            <li><a href="#ç¼–ç å™¨å’Œè§£ç å™¨">ç¼–ç å™¨å’Œè§£ç å™¨</a></li>
            <li><a href="#å®ç°httpåè®®é€šä¿¡">å®ç°HTTPåè®®é€šä¿¡</a></li>
            <li><a href="#å…¶ä»–å†…ç½®handlerä»‹ç»">å…¶ä»–å†…ç½®Handlerä»‹ç»</a></li>
            <li><a href="#å¯åŠ¨æµç¨‹æºç è§£è¯»">å¯åŠ¨æµç¨‹æºç è§£è¯»</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</details>
<details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden">
  <summary
    class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    ç›®å½•
  </summary>
  <div
    class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#nettyæ¡†æ¶">Nettyæ¡†æ¶</a>
      <ul>
        <li><a href="#nioæ¡†æ¶å­˜åœ¨çš„é—®é¢˜">NIOæ¡†æ¶å­˜åœ¨çš„é—®é¢˜</a>
          <ul>
            <li><a href="#å®¢æˆ·ç«¯å…³é—­å¯¼è‡´æœåŠ¡ç«¯ç©ºè½®è¯¢">å®¢æˆ·ç«¯å…³é—­å¯¼è‡´æœåŠ¡ç«¯ç©ºè½®è¯¢</a></li>
            <li><a href="#ç²˜åŒ…æ‹†åŒ…é—®é¢˜">ç²˜åŒ…/æ‹†åŒ…é—®é¢˜</a></li>
          </ul>
        </li>
        <li><a href="#èµ°è¿›nettyæ¡†æ¶">èµ°è¿›Nettyæ¡†æ¶</a>
          <ul>
            <li><a href="#bytebufä»‹ç»">ByteBufä»‹ç»</a></li>
            <li><a href="#é›¶æ‹·è´ç®€ä»‹">é›¶æ‹·è´ç®€ä»‹</a></li>
            <li><a href="#nettyå·¥ä½œæ¨¡å‹">Nettyå·¥ä½œæ¨¡å‹</a></li>
            <li><a href="#channelè¯¦è§£">Channelè¯¦è§£</a></li>
            <li><a href="#eventloopå’Œä»»åŠ¡è°ƒåº¦">EventLoopå’Œä»»åŠ¡è°ƒåº¦</a></li>
            <li><a href="#futureå’Œpromise">Futureå’ŒPromise</a></li>
            <li><a href="#ç¼–ç å™¨å’Œè§£ç å™¨">ç¼–ç å™¨å’Œè§£ç å™¨</a></li>
            <li><a href="#å®ç°httpåè®®é€šä¿¡">å®ç°HTTPåè®®é€šä¿¡</a></li>
            <li><a href="#å…¶ä»–å†…ç½®handlerä»‹ç»">å…¶ä»–å†…ç½®Handlerä»‹ç»</a></li>
            <li><a href="#å¯åŠ¨æµç¨‹æºç è§£è¯»">å¯åŠ¨æµç¨‹æºç è§£è¯»</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</details>

 
<script>
  (function () {
    var $toc = $('#TableOfContents');
    if ($toc.length > 0) {
      var $window = $(window);

      function onScroll() {
        var currentScroll = $window.scrollTop();
        var h = $('.anchor');
        var id = "";
        h.each(function (i, e) {
          e = $(e);
          if (e.offset().top - $(window).height()/3 <= currentScroll) {
            id = e.attr('id');
          }
        });
        var active = $toc.find('a.active');      
        if (active.length == 1 && active.eq(0).attr('href') == '#' + id) return true;

        active.each(function (i, e) {
          
            $(e).removeClass('active');
          
        });
        $toc.find('a[href="#' + id + '"]').addClass('active')
        $toc.find('a[href="#' + id + '"]').parentsUntil('#TableOfContents').each(function (i, e) {
          $(e).children('a').parents('ul').show();          
        });
      }

      $window.on('scroll', onScroll);
      $(document).ready(function () {
        
        onScroll();
      });
    }
  })();
</script>
   </div>
      </div>
      

      <div class="min-w-0 min-h-0 max-w-fit">
        
        
<details style="margin-left:0px" class="mt-2 mb-5 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5"  open >
    
    <summary
        class="py-1 text-lg font-semibold cursor-pointer bg-primary-200 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-primary-800 dark:text-neutral-100">
        NIO&amp;Netty - è¿™æ˜¯ç³»åˆ—æ–‡ç« ä¹‹ä¸€.
    </summary>
    
    


</details>



        <div class="article-content max-w-prose mb-20">
          

<h1 class="relative group">Nettyæ¡†æ¶ 
    <div id="netty%E6%A1%86%E6%9E%B6" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#netty%E6%A1%86%E6%9E%B6" aria-label="é”šç‚¹">#</a>
    </span>        
    
</h1>
<p>å‰é¢æˆ‘ä»¬å­¦ä¹ äº†Javaä¸ºæˆ‘ä»¬æä¾›çš„NIOæ¡†æ¶ï¼Œæä¾›ä½¿ç”¨NIOæä¾›çš„ä¸‰å¤§ç»„ä»¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç¼–å†™æ›´åŠ é«˜æ€§èƒ½çš„å®¢æˆ·ç«¯/æœåŠ¡ç«¯ç½‘ç»œç¨‹åºäº†ï¼Œç”šè‡³è¿˜å¯ä»¥è‡ªè¡Œè§„å®šä¸€ç§é€šä¿¡åè®®è¿›è¡Œé€šä¿¡ã€‚</p>


<h2 class="relative group">NIOæ¡†æ¶å­˜åœ¨çš„é—®é¢˜ 
    <div id="nio%E6%A1%86%E6%9E%B6%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#nio%E6%A1%86%E6%9E%B6%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98" aria-label="é”šç‚¹">#</a>
    </span>        
    
</h2>
<p>ä½†æ˜¯ä¹‹å‰æˆ‘ä»¬åœ¨ä½¿ç”¨NIOæ¡†æ¶çš„æ—¶å€™ï¼Œè¿˜æ˜¯å‘ç°äº†ä¸€äº›é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆæ¥ç›˜ç‚¹ä¸€ä¸‹ã€‚</p>


<h3 class="relative group">å®¢æˆ·ç«¯å…³é—­å¯¼è‡´æœåŠ¡ç«¯ç©ºè½®è¯¢ 
    <div id="%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%85%B3%E9%97%AD%E5%AF%BC%E8%87%B4%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%A9%BA%E8%BD%AE%E8%AF%A2" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%85%B3%E9%97%AD%E5%AF%BC%E8%87%B4%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%A9%BA%E8%BD%AE%E8%AF%A2" aria-label="é”šç‚¹">#</a>
    </span>        
    
</h3>
<p>å¯èƒ½åœ¨ä¹‹å‰çš„å®éªŒä¸­ï¼Œä½ å‘ç°äº†è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/jCHunMSWTOsUwD6.png" alt="image-20230306173647589" />
    
  </figure>

</p>
<p>å½“æˆ‘ä»¬çš„å®¢æˆ·ç«¯ä¸»åŠ¨ä¸æœåŠ¡ç«¯æ–­å¼€è¿æ¥æ—¶ï¼Œä¼šå¯¼è‡´READäº‹ä»¶ä¸€ç›´è¢«è§¦å‘ï¼Œä¹Ÿå°±æ˜¯è¯´<code>selector.select()</code>ä¼šç›´æ¥é€šè¿‡ï¼Œå¹¶ä¸”æ˜¯å¯è¯»çš„çŠ¶æ€ï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°å®é™…ä¸Šè¯»åˆ°æ˜¯æ•°æ®æ˜¯ä¸€ä¸ªç©ºçš„ï¼ˆä¸Šé¢çš„å›¾ä¸­åœ¨ç©ºè½®è¯¢ä¸¤æ¬¡åæŠ›å‡ºå¼‚å¸¸äº†ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯æ— é™çš„å¾ªç¯ä¸‹å»ï¼‰æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¾—ç¨å¾®å¤„ç†ä¸€ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isReadable</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">SocketChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="o">(</span><span class="n">SocketChannel</span><span class="o">)</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">128</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//è¿™é‡Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­ä¸€ä¸‹ï¼Œå¦‚æœreadæ“ä½œå¾—åˆ°çš„ç»“æœæ˜¯-1ï¼Œé‚£ä¹ˆè¯´æ˜æœåŠ¡ç«¯å·²ç»æ–­å¼€è¿æ¥äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="o">(</span><span class="n">channel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;å®¢æˆ·ç«¯å·²ç»æ–­å¼€è¿æ¥äº†ï¼š&#34;</span><span class="o">+</span><span class="n">channel</span><span class="o">.</span><span class="na">getRemoteAddress</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">channel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>   <span class="c1">//ç›´æ¥å…³é—­æ­¤é€šé“
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">continue</span><span class="o">;</span>   <span class="c1">//ç»§ç»­è¿›è¡Œé€‰æ‹©
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ•°æ®ï¼š&#34;</span><span class="o">+</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">array</span><span class="o">(),</span> <span class="mi">0</span><span class="o">,</span> <span class="n">buffer</span><span class="o">.</span><span class="na">remaining</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">    <span class="n">channel</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">ByteBuffer</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="s">&#34;å·²æ”¶åˆ°ï¼&#34;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€æ—¶å…³é—­è¿æ¥äº†ï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/rKndw4u9P6Es1hI.png" alt="image-20230306173700652" />
    
  </figure>

</p>
<p>å½“ç„¶ï¼Œé™¤äº†è¿™ç§æƒ…å†µå¯èƒ½ä¼šå¯¼è‡´ç©ºè½®è¯¢ä¹‹å¤–ï¼Œå®é™…ä¸Šè¿˜æœ‰ä¸€ç§å¯èƒ½ï¼Œè¿™ç§æƒ…å†µæ˜¯NIOæ¡†æ¶æœ¬èº«çš„BUGï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">();</span>  <span class="c1">//ç”±äºåº•å±‚epollæœºåˆ¶çš„é—®é¢˜ï¼Œå¯¼è‡´selectæ–¹æ³•å¯èƒ½ä¼šä¸€ç›´è¿”å›0ï¼Œé€ æˆæ— é™å¾ªç¯çš„æƒ…å†µã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;ç›‘å¬åˆ° &#34;</span><span class="o">+</span><span class="n">count</span><span class="o">+</span><span class="s">&#34; ä¸ªäº‹ä»¶&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span><span class="o">&lt;</span><span class="n">SelectionKey</span><span class="o">&gt;</span> <span class="n">selectionKeys</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">SelectionKey</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">selectionKeys</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
</span></span></code></pre></div><p>è¯¦ç»†è¯·çœ‹JDKå®˜æ–¹BUGåé¦ˆï¼š</p>
<ol>
<li><a href="https://link.jianshu.com/?t=http%3A%2F%2Fbugs.java.com%2Fbugdatabase%2Fview_bug.do%3Fbug_id%3D6670302"   target="_blank">
    JDK-6670302 : (se) NIO selector wakes up with 0 selected keys infinitely</a></li>
<li><a href="https://link.jianshu.com/?t=http%3A%2F%2Fbugs.java.com%2Fbugdatabase%2Fview_bug.do%3Fbug_id%3D6403933"   target="_blank">
    JDK-6403933 : (se) Selector doesn&rsquo;t block on Selector.select(timeout) (lnx)</a></li>
</ol>
<p>æœ¬è´¨åŸå› ä¹Ÿæ˜¯å› ä¸ºå®¢æˆ·ç«¯çš„ä¸»åŠ¨æ–­å¼€å¯¼è‡´ï¼š</p>
<blockquote>
<p>This is an issue with poll (and epoll) on Linux. If a file descriptor for a connected socket is polled with a request event mask of 0, and if the connection is abruptly terminated (RST) then the poll wakes up with the POLLHUP (and maybe POLLERR) bit set in the returned event set. The implication of this behaviour is that Selector will wakeup and as the interest set for the SocketChannel is 0 it means there aren&rsquo;t any selected events and the select method returns 0.</p>
</blockquote>
<p>è¿™ä¸ªé—®é¢˜æœ¬è´¨æ˜¯ä¸æ“ä½œç³»ç»Ÿæœ‰å…³çš„ï¼Œæ‰€ä»¥JDKä¸€ç›´éƒ½è®¤ä¸ºæ˜¯æ“ä½œç³»ç»Ÿçš„é—®é¢˜ï¼Œä¸åº”è¯¥ç”±è‡ªå·±æ¥å¤„ç†ï¼Œæ‰€ä»¥è¿™ä¸ªé—®é¢˜åœ¨å½“æ—¶çš„å¥½å‡ ä¸ªJDKç‰ˆæœ¬éƒ½æ˜¯å­˜åœ¨çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆä¸¥é‡çš„ç©ºè½¬é—®é¢˜ï¼Œæ— é™åˆ¶åœ°è¿›è¡Œç©ºè½¬æ“ä½œä¼šå¯¼è‡´CPUèµ„æºè¢«ç–¯ç‹‚æ¶ˆè€—ã€‚</p>
<p>ä¸è¿‡ï¼Œè¿™ä¸ªé—®é¢˜ï¼Œå´è¢«Nettyæ¡†æ¶å·§å¦™è§£å†³äº†ï¼Œæˆ‘ä»¬åé¢å†è¯´ã€‚</p>


<h3 class="relative group">ç²˜åŒ…/æ‹†åŒ…é—®é¢˜ 
    <div id="%E7%B2%98%E5%8C%85%E6%8B%86%E5%8C%85%E9%97%AE%E9%A2%98" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E7%B2%98%E5%8C%85%E6%8B%86%E5%8C%85%E9%97%AE%E9%A2%98" aria-label="é”šç‚¹">#</a>
    </span>        
    
</h3>
<p>é™¤äº†ä¸Šé¢çš„é—®é¢˜ä¹‹å¤–ï¼Œæˆ‘ä»¬æ¥ç€æ¥çœ‹ä¸‹ä¸€ä¸ªé—®é¢˜ã€‚</p>
<p>æˆ‘ä»¬åœ¨<code>è®¡ç®—æœºç½‘ç»œ</code>è¿™é—¨è¯¾ç¨‹ä¸­å­¦ä¹ è¿‡ï¼Œæ“ä½œç³»ç»Ÿé€šè¿‡TCPåè®®å‘é€æ•°æ®çš„æ—¶å€™ï¼Œä¹Ÿä¼šå…ˆå°†æ•°æ®å­˜æ”¾åœ¨ç¼“å†²åŒºä¸­ï¼Œè€Œè‡³äºä»€ä¹ˆæ—¶å€™çœŸæ­£åœ°å‘å‡ºè¿™äº›æ•°æ®ï¼Œæ˜¯ç”±TCPåè®®æ¥å†³å®šçš„ï¼Œè¿™æ˜¯æˆ‘ä»¬æ— æ³•æ§åˆ¶çš„äº‹æƒ…ã€‚</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/ctmzGVl1BU3nAvp.png" alt="image-20230306173718414" />
    
  </figure>

</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯”å¦‚ç°åœ¨æˆ‘ä»¬è¦å‘é€ä¸¤ä¸ªæ•°æ®åŒ…ï¼ˆP1/P2ï¼‰ï¼Œç†æƒ³æƒ…å†µä¸‹ï¼Œè¿™ä¸¤ä¸ªåŒ…åº”è¯¥æ˜¯ä¾æ¬¡åˆ°è¾¾æœåŠ¡ç«¯ï¼Œå¹¶ç”±æœåŠ¡ç«¯æ­£ç¡®è¯»å–ä¸¤æ¬¡æ•°æ®å‡ºæ¥ï¼Œä½†æ˜¯ç”±äºä¸Šé¢çš„æœºåˆ¶ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸‹é¢çš„æƒ…å†µï¼š</p>
<ol>
<li>å¯èƒ½P1å’ŒP2è¢«åˆåœ¨ä¸€èµ·å‘é€ç»™äº†æœåŠ¡ç«¯ï¼ˆç²˜åŒ…ç°è±¡ï¼‰</li>
<li>å¯èƒ½P1å’ŒP2çš„å‰åŠéƒ¨åˆ†åˆåœ¨ä¸€èµ·å‘é€ç»™äº†æœåŠ¡ç«¯ï¼ˆæ‹†åŒ…ç°è±¡ï¼‰</li>
<li>å¯èƒ½P1çš„å‰åŠéƒ¨åˆ†å°±è¢«å•ç‹¬ä½œä¸ºä¸€ä¸ªéƒ¨åˆ†å‘ç»™äº†æœåŠ¡ç«¯ï¼Œåé¢çš„å’ŒP2ä¸€èµ·å‘ç»™æœåŠ¡ç«¯ï¼ˆä¹Ÿæ˜¯æ‹†åŒ…ç°è±¡ï¼‰</li>
</ol>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/qKL8hGSs5mEOdXQ.png" alt="image-20230306173728520" />
    
  </figure>

</p>
<p>å½“ç„¶ï¼Œå¯¹äºè¿™ç§é—®é¢˜ï¼Œä¹Ÿæœ‰ä¸€äº›æ¯”è¾ƒå¸¸è§çš„è§£å†³æ–¹æ¡ˆï¼š</p>
<ol>
<li>æ¶ˆæ¯å®šé•¿ï¼Œå‘é€æ–¹å’Œæ¥æ”¶æ–¹è§„å®šå›ºå®šå¤§å°çš„æ¶ˆæ¯é•¿åº¦ï¼Œä¾‹å¦‚æ¯ä¸ªæ•°æ®åŒ…å¤§å°å›ºå®šä¸º200å­—èŠ‚ï¼Œå¦‚æœä¸å¤Ÿï¼Œç©ºä½è¡¥ç©ºæ ¼ï¼Œåªæœ‰æ¥æ”¶äº†200ä¸ªå­—èŠ‚ä¹‹åï¼Œä½œä¸ºä¸€ä¸ªå®Œæ•´çš„æ•°æ®åŒ…è¿›è¡Œå¤„ç†ã€‚</li>
<li>åœ¨æ¯ä¸ªåŒ…çš„æœ«å°¾ä½¿ç”¨å›ºå®šçš„åˆ†éš”ç¬¦ï¼Œæ¯”å¦‚æ¯ä¸ªæ•°æ®åŒ…æœ«å°¾éƒ½æ˜¯<code>\r\n</code>ï¼Œè¿™æ ·å°±ä¸€å®šéœ€è¦è¯»å–åˆ°è¿™æ ·çš„åˆ†éš”ç¬¦æ‰èƒ½å°†å‰é¢æ‰€æœ‰çš„æ•°æ®ä½œä¸ºä¸€ä¸ªå®Œæ•´çš„æ•°æ®åŒ…è¿›è¡Œå¤„ç†ã€‚</li>
<li>å°†æ¶ˆæ¯åˆ†ä¸ºå¤´éƒ¨å’Œæœ¬ä½“ï¼Œåœ¨å¤´éƒ¨ä¸­ä¿å­˜æœ‰å½“å‰æ•´ä¸ªæ•°æ®åŒ…çš„é•¿åº¦ï¼Œåªæœ‰åœ¨è¯»åˆ°è¶³å¤Ÿé•¿åº¦ä¹‹åæ‰ç®—æ˜¯è¯»åˆ°äº†ä¸€ä¸ªå®Œæ•´çš„æ•°æ®åŒ…ã€‚</li>
</ol>
<p>è¿™é‡Œæˆ‘ä»¬å°±æ¥æ¼”ç¤ºä¸€ä¸‹ç¬¬ä¸€ç§è§£å†³æ–¹æ¡ˆï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">(</span><span class="n">ServerSocketChannel</span> <span class="n">serverChannel</span> <span class="o">=</span> <span class="n">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">         <span class="n">Selector</span> <span class="n">selector</span> <span class="o">=</span> <span class="n">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">()){</span>
</span></span><span class="line"><span class="cl">        <span class="n">serverChannel</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="n">InetSocketAddress</span><span class="o">(</span><span class="mi">8080</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">serverChannel</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">serverChannel</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//ä¸€ä¸ªæ•°æ®åŒ…è¦æ±‚å¿…é¡»å¡æ»¡30ä¸ªå­—èŠ‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">30</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">Set</span><span class="o">&lt;</span><span class="n">SelectionKey</span><span class="o">&gt;</span> <span class="n">selectionKeys</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">SelectionKey</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">selectionKeys</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="o">...</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">remaining</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ•°æ®ï¼š&#34;</span><span class="o">+</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">array</span><span class="o">(),</span> <span class="mi">0</span><span class="o">,</span> <span class="n">buffer</span><span class="o">.</span><span class="na">remaining</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">                        <span class="n">buffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                    <span class="n">channel</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">ByteBuffer</span><span class="o">.</span><span class="na">wrap</span><span class="o">((</span><span class="s">&#34;å·²æ”¶åˆ° &#34;</span><span class="o">+</span><span class="n">size</span><span class="o">+</span><span class="s">&#34; å­—èŠ‚çš„æ•°æ®ï¼&#34;</span><span class="o">).</span><span class="na">getBytes</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">               	<span class="o">...</span>
</span></span></code></pre></div><p>ç°åœ¨ï¼Œå½“æˆ‘ä»¬çš„å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯æ—¶ï¼Œå¦‚æœæ²¡æœ‰è¾¾åˆ°30ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆä¼šæš‚æ—¶å­˜å‚¨èµ·æ¥ï¼Œç­‰æœ‰30ä¸ªä¹‹åå†ä¸€æ¬¡æ€§å¾—åˆ°ï¼Œå½“ç„¶å¦‚æœæ•°æ®é‡è¶…è¿‡äº†30ï¼Œé‚£ä¹ˆæœ€å¤šä¹Ÿåªä¼šè¯»å–30ä¸ªå­—èŠ‚ï¼Œå…¶ä»–çš„æ”¾åœ¨ä¸‹ä¸€æ‰¹ï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/FA7gvlkx5OzYVWd.png" alt="image-20230306173746619" />
    
  </figure>

</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/cnrpeUVFGN8oRt5.png" alt="image-20230306173755459" />
    
  </figure>

</p>
<p>è¿™æ ·å°±å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šè§£å†³ç²˜åŒ…/æ‹†åŒ…é—®é¢˜äº†ã€‚</p>
<p>æ€»çš„é€šè¿‡æ¶ˆæ¯å®šé•¿</p>
<hr>


<h2 class="relative group">èµ°è¿›Nettyæ¡†æ¶ 
    <div id="%E8%B5%B0%E8%BF%9Bnetty%E6%A1%86%E6%9E%B6" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E8%B5%B0%E8%BF%9Bnetty%E6%A1%86%E6%9E%B6" aria-label="é”šç‚¹">#</a>
    </span>        
    
</h2>
<p>å‰é¢æˆ‘ä»¬ç›˜ç‚¹äº†ä¸€ä¸‹NIOå­˜åœ¨çš„ä¸€äº›é—®é¢˜ï¼Œè€Œåœ¨Nettyæ¡†æ¶ä¸­ï¼Œè¿™äº›é—®é¢˜éƒ½è¢«å·§å¦™çš„è§£å†³äº†ã€‚</p>
<p>Nettyæ˜¯ç”±JBOSSæä¾›çš„ä¸€ä¸ªå¼€æºçš„javaç½‘ç»œç¼–ç¨‹æ¡†æ¶ï¼Œä¸»è¦æ˜¯å¯¹javaçš„nioåŒ…è¿›è¡Œäº†å†æ¬¡å°è£…ã€‚Nettyæ¯”javaåŸç”Ÿçš„nioåŒ…æä¾›äº†æ›´åŠ å¼ºå¤§ã€ç¨³å®šçš„åŠŸèƒ½å’Œæ˜“äºä½¿ç”¨çš„apiã€‚ nettyçš„ä½œè€…æ˜¯Trustin Leeï¼Œè¿™æ˜¯ä¸€ä¸ªéŸ©å›½äººï¼Œä»–è¿˜å¼€å‘äº†å¦å¤–ä¸€ä¸ªè‘—åçš„ç½‘ç»œç¼–ç¨‹æ¡†æ¶ï¼Œminaã€‚äºŒè€…åœ¨å¾ˆå¤šæ–¹é¢éƒ½ååˆ†ç›¸ä¼¼ï¼Œå®ƒä»¬çš„çº¿ç¨‹æ¨¡å‹ä¹Ÿæ˜¯åŸºæœ¬ä¸€è‡´ ã€‚ä¸è¿‡nettyç¤¾åŒºçš„æ´»è·ƒç¨‹åº¦è¦minaé«˜å¾—å¤šã€‚</p>
<p>Nettyå®é™…ä¸Šåº”ç”¨åœºæ™¯éå¸¸å¤šï¼Œæ¯”å¦‚æˆ‘ä»¬çš„Minecraftæ¸¸æˆæœåŠ¡å™¨ï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/N8FJbtCaz7v2xe4.png" alt="image-20230306173806432" />
    
  </figure>

</p>
<p>Javaç‰ˆæœ¬çš„MinecraftæœåŠ¡å™¨å°±æ˜¯ä½¿ç”¨Nettyæ¡†æ¶ä½œä¸ºç½‘ç»œé€šä¿¡çš„åŸºç¡€ï¼Œæ­£æ˜¯å¾—ç›ŠäºNettyæ¡†æ¶çš„é«˜æ€§èƒ½ï¼Œæˆ‘ä»¬æ‰èƒ½æ„‰å¿«åœ°å’Œå…¶ä»–çš„å°ä¼™ä¼´ä¸€èµ·åœ¨æœåŠ¡å™¨é‡Œé¢ç‚¸æœã€‚</p>
<p>å­¦ä¹ äº†Nettyæ¡†æ¶åï¼Œè¯´ä¸å®šä½ ä¹Ÿå¯ä»¥æ‘¸ç´¢åˆ°éƒ¨åˆ†Minecraftæ’ä»¶/æ¨¡ç»„å¼€å‘çš„åº•å±‚ç»†èŠ‚ï¼ˆå¤ªæŠ˜ç£¨äº†ï¼ŒUPä¸»é«˜ä¸­æäº†å¤§åŠå¹´è¿™ç©æ„ï¼‰</p>
<p>å½“ç„¶é™¤äº†æ¸¸æˆæœåŠ¡å™¨ä¹‹å¤–ï¼Œæˆ‘ä»¬å¾®æœåŠ¡ä¹‹é—´çš„è¿œç¨‹è°ƒç”¨ä¹Ÿå¯ä»¥ä½¿ç”¨Nettyæ¥å®Œæˆï¼Œæ¯”å¦‚Dubboçš„RPCæ¡†æ¶ï¼ŒåŒ…æ‹¬æœ€æ–°çš„SpringWebFluxæ¡†æ¶ï¼Œä¹ŸæŠ›å¼ƒäº†å†…åµŒTomcatè€Œä½¿ç”¨Nettyä½œä¸ºé€šä¿¡æ¡†æ¶ã€‚æ—¢ç„¶Nettyè¿™ä¹ˆå¼ºå¤§ï¼Œé‚£ä¹ˆç°åœ¨æˆ‘ä»¬å°±å¼€å§‹Nettyçš„å­¦ä¹ å§ï¼</p>
<p>å¯¼åŒ…å…ˆï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>io.netty<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>netty-all<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>4.1.76.Final<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependencies&gt;</span>
</span></span></code></pre></div>

<h3 class="relative group">ByteBufä»‹ç» 
    <div id="bytebuf%E4%BB%8B%E7%BB%8D" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#bytebuf%E4%BB%8B%E7%BB%8D" aria-label="é”šç‚¹">#</a>
    </span>        
    
</h3>
<p>Nettyå¹¶æ²¡æœ‰ä½¿ç”¨NIOä¸­æä¾›çš„ByteBufferæ¥è¿›è¡Œæ•°æ®è£…è½½ï¼Œè€Œæ˜¯è‡ªè¡Œå®šä¹‰äº†ä¸€ä¸ªByteBufç±»ã€‚</p>
<p>é‚£ä¹ˆè¿™ä¸ªç±»ç›¸æ¯”NIOä¸­çš„ByteBufferæœ‰ä»€ä¹ˆä¸åŒä¹‹å¤„å‘¢ï¼Ÿ</p>
<ul>
<li>å†™æ“ä½œå®Œæˆåæ— éœ€è¿›è¡Œ<code>flip()</code>ç¿»è½¬ã€‚</li>
<li>å…·æœ‰æ¯”ByteBufferæ›´å¿«çš„å“åº”é€Ÿåº¦ã€‚</li>
<li>åŠ¨æ€æ‰©å®¹ã€‚</li>
</ul>
<p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„å†…éƒ¨ç»“æ„ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractByteBuf</span> <span class="kd">extends</span> <span class="n">ByteBuf</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">readerIndex</span><span class="o">;</span>   <span class="c1">//indexè¢«åˆ†ä¸ºäº†è¯»å’Œå†™ï¼Œæ˜¯ä¸¤ä¸ªæŒ‡é’ˆåœ¨åŒæ—¶å·¥ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">writerIndex</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">markedReaderIndex</span><span class="o">;</span>    <span class="c1">//markæ“ä½œä¹Ÿåˆ†ä¸¤ç§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kt">int</span> <span class="n">markedWriterIndex</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">;</span>    <span class="c1">//æœ€å¤§å®¹é‡ï¼Œæ²¡é”™ï¼Œè¿™ç©æ„èƒ½åŠ¨æ€æ‰©å®¹
</span></span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œè¯»æ“ä½œå’Œå†™æ“ä½œåˆ†åˆ«ç”±ä¸¤ä¸ªæŒ‡é’ˆåœ¨è¿›è¡Œç»´æŠ¤ï¼Œæ¯å†™å…¥ä¸€æ¬¡ï¼Œ<code>writerIndex</code>å‘åç§»åŠ¨ä¸€ä½ï¼Œæ¯è¯»å–ä¸€æ¬¡ï¼Œä¹Ÿæ˜¯<code>readerIndex</code>å‘åç§»åŠ¨ä¸€ä½ï¼Œå½“ç„¶<code>readerIndex</code>ä¸èƒ½å¤§äº<code>writerIndex</code>ï¼Œè¿™æ ·å°±ä¸ä¼šåƒNIOä¸­çš„ByteBufferé‚£æ ·è¿˜éœ€è¦è¿›è¡Œç¿»è½¬äº†ã€‚</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/08/14/4Tyji6RaMlCfQtn.png" alt="image-20230814163638094" />
    
  </figure>

</p>
<p>å…¶ä¸­<code>readerIndex</code>å’Œ<code>writerIndex</code>ä¹‹é—´çš„éƒ¨åˆ†å°±æ˜¯æ˜¯å¯è¯»çš„å†…å®¹ï¼Œè€Œ<code>writerIndex</code>ä¹‹ååˆ°<code>capacity</code>éƒ½æ˜¯å¯å†™çš„éƒ¨åˆ†ã€‚</p>
<p>æˆ‘ä»¬æ¥å®é™…ä½¿ç”¨ä¸€ä¸‹çœ‹çœ‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//åˆ›å»ºä¸€ä¸ªåˆå§‹å®¹é‡ä¸º10çš„ByteBufç¼“å†²åŒºï¼Œè¿™é‡Œçš„Unpooledæ˜¯ç”¨äºå¿«é€Ÿç”ŸæˆByteBufçš„å·¥å…·ç±»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//è‡³äºä¸ºå•¥å«Unpooledæ˜¯æ± åŒ–çš„æ„æ€ï¼ŒByteBufæœ‰æ± åŒ–å’Œéæ± åŒ–ä¸¤ç§ï¼ŒåŒºåˆ«åœ¨äºå¯¹å†…å­˜çš„å¤ç”¨ï¼Œæˆ‘ä»¬ä¹‹åå†è®¨è®º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">Unpooled</span><span class="o">.</span><span class="na">buffer</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;åˆå§‹çŠ¶æ€ï¼š&#34;</span><span class="o">+</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">array</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(-</span><span class="mi">888888888</span><span class="o">);</span>   <span class="c1">//å†™å…¥ä¸€ä¸ªIntæ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;å†™å…¥Intåï¼š&#34;</span><span class="o">+</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">array</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span><span class="o">.</span><span class="na">readShort</span><span class="o">();</span>   <span class="c1">//æ— éœ€ç¿»è½¬ï¼Œç›´æ¥è¯»å–ä¸€ä¸ªshortæ•°æ®å‡ºæ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;è¯»å–Shortåï¼š&#34;</span><span class="o">+</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">array</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span><span class="o">.</span><span class="na">discardReadBytes</span><span class="o">();</span>   <span class="c1">//ä¸¢å¼ƒæ“ä½œï¼Œä¼šå°†å½“å‰çš„å¯è¯»éƒ¨åˆ†å†…å®¹ä¸¢åˆ°æœ€å‰é¢ï¼Œå¹¶ä¸”è¯»å†™æŒ‡é’ˆå‘å‰ç§»åŠ¨ä¸¢å¼ƒçš„è·ç¦»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;ä¸¢å¼ƒä¹‹åï¼š&#34;</span><span class="o">+</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">array</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>    <span class="c1">//æ¸…ç©ºæ“ä½œï¼Œæ¸…ç©ºä¹‹åè¯»å†™æŒ‡é’ˆéƒ½å½’é›¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æ¸…ç©ºä¹‹åï¼š&#34;</span><span class="o">+</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">array</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>é€šè¿‡ç»“åˆæ–­ç‚¹è°ƒè¯•ï¼Œæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿè¯»å†™æŒ‡é’ˆçš„ç§»åŠ¨æƒ…å†µï¼Œæ›´åŠ æ¸…æ¥šçš„è®¤è¯†ä¸€ä¸‹ByteBufçš„åº•å±‚æ“ä½œã€‚</p>
<p>æˆ‘ä»¬å†æ¥çœ‹çœ‹åˆ’åˆ†æ“ä½œæ˜¯ä¸æ˜¯å’Œä¹‹å‰ä¸€æ ·çš„ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  	<span class="c1">//æˆ‘ä»¬ä¹Ÿå¯ä»¥å°†ä¸€ä¸ªbyte[]ç›´æ¥åŒ…è£…è¿›ç¼“å†²åŒºï¼ˆå’ŒNIOæ˜¯ä¸€æ ·çš„ï¼‰ä¸è¿‡å†™æŒ‡é’ˆçš„å€¼ä¸€å¼€å§‹å°±è·‘åˆ°æœ€åå»äº†ï¼Œä½†æ˜¯è¿™ç©æ„æ˜¯ä¸æ˜¯åªè¯»çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">Unpooled</span><span class="o">.</span><span class="na">wrappedBuffer</span><span class="o">(</span><span class="s">&#34;abcdefg&#34;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">  	<span class="c1">//é™¤äº†åŒ…è£…ï¼Œä¹Ÿå¯ä»¥å¤åˆ¶æ•°æ®ï¼ŒcopiedBuffer()ä¼šå®Œå®Œæ•´æ•´å°†æ•°æ®æ‹·è´åˆ°ä¸€ä¸ªæ–°çš„ç¼“å†²åŒºä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">buf</span><span class="o">.</span><span class="na">readByte</span><span class="o">();</span>   <span class="c1">//è¯»å–ä¸€ä¸ªå­—èŠ‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ByteBuf</span> <span class="n">slice</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="na">slice</span><span class="o">();</span>   <span class="c1">//ç°åœ¨è¯»æŒ‡é’ˆä½äº1ï¼Œç„¶åè¿›è¡Œåˆ’åˆ†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">slice</span><span class="o">.</span><span class="na">arrayOffset</span><span class="o">());</span>   <span class="c1">//å¾—åˆ°åˆ’åˆ†å‡ºæ¥çš„ByteBufçš„åç§»åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">slice</span><span class="o">.</span><span class="na">array</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œåˆ’åˆ†ä¹Ÿæ˜¯æ ¹æ®å½“å‰è¯»å–çš„ä½ç½®æ¥è¿›è¡Œçš„ã€‚</p>
<p>æˆ‘ä»¬ç»§ç»­æ¥çœ‹çœ‹å®ƒçš„å¦ä¸€ä¸ªç‰¹æ€§ï¼ŒåŠ¨æ€æ‰©å®¹ï¼Œæ¯”å¦‚æˆ‘ä»¬ç”³è¯·ä¸€ä¸ªå®¹é‡ä¸º10çš„ç¼“å†²åŒºï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">Unpooled</span><span class="o">.</span><span class="na">buffer</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>    <span class="c1">//å®¹é‡åªæœ‰10å­—èŠ‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">capacity</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">  	<span class="c1">//ç›´æ¥å†™ä¸€ä¸ªå­—ç¬¦ä¸²
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">buf</span><span class="o">.</span><span class="na">writeCharSequence</span><span class="o">(</span><span class="s">&#34;å¢æœ¬ä¼Ÿç‰›é€¼ï¼&#34;</span><span class="o">,</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>   <span class="c1">//å¾ˆæ˜æ˜¾è¿™ä¹ˆå¤šå­—å·²ç»è¶…è¿‡10å­—èŠ‚äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">capacity</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>é€šè¿‡ç»“æœæˆ‘ä»¬å‘ç°ï¼Œåœ¨å†™å…¥ä¸€ä¸ªè¶…å‡ºå½“å‰å®¹é‡çš„æ•°æ®æ—¶ï¼Œä¼šè¿›è¡ŒåŠ¨æ€æ‰©å®¹ï¼Œæ‰©å®¹ä¼šä»64å¼€å§‹ï¼Œä¹‹åæ¯æ¬¡è§¦å‘æ‰©å®¹éƒ½ä¼šx2ï¼Œå½“ç„¶å¦‚æœæˆ‘ä»¬ä¸å¸Œæœ›å®ƒæ‰©å®¹ï¼Œå¯ä»¥æŒ‡å®šæœ€å¤§å®¹é‡ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//åœ¨ç”Ÿæˆæ—¶æŒ‡å®šmaxCapacityä¹Ÿä¸º10
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">Unpooled</span><span class="o">.</span><span class="na">buffer</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="mi">10</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">capacity</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span><span class="o">.</span><span class="na">writeCharSequence</span><span class="o">(</span><span class="s">&#34;å¢æœ¬ä¼Ÿç‰›é€¼ï¼&#34;</span><span class="o">,</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">capacity</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ç°åœ¨æ— æ³•å†åŠ¨æ€æ‰©å®¹äº†ï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/MyE5vbO1Vhpoxzj.png" alt="image-20230306173824953" />
    
  </figure>

</p>
<p>æˆ‘ä»¬æ¥ç€æ¥çœ‹ä¸€ä¸‹ç¼“å†²åŒºçš„ä¸‰ç§å®ç°æ¨¡å¼ï¼šå †ç¼“å†²åŒºæ¨¡å¼ã€ç›´æ¥ç¼“å†²åŒºæ¨¡å¼ã€å¤åˆç¼“å†²åŒºæ¨¡å¼ã€‚</p>
<p>å †ç¼“å†²åŒºï¼ˆæ•°ç»„å®ç°ï¼‰å’Œç›´æ¥ç¼“å†²åŒºï¼ˆå †å¤–å†…å­˜å®ç°ï¼‰ä¸ç”¨å¤šè¯´ï¼Œå‰é¢æˆ‘ä»¬åœ¨NIOä¸­å·²ç»äº†è§£è¿‡äº†ï¼Œæˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªç›´æ¥ç¼“å†²åŒºä¹Ÿå¾ˆç®€å•ï¼Œç›´æ¥è°ƒç”¨ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">Unpooled</span><span class="o">.</span><span class="na">directBuffer</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">array</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>åŒæ ·çš„ä¸èƒ½ç›´æ¥æ‹¿åˆ°æ•°ç»„ï¼Œå› ä¸ºåº•å±‚å‹æ ¹ä¸æ˜¯æ•°ç»„å®ç°çš„ï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/MraXOnlvekWNYfu.png" alt="image-20230306174001430" />
    
  </figure>

</p>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹å¤åˆæ¨¡å¼ï¼Œå¤åˆæ¨¡å¼å¯ä»¥ä»»æ„åœ°æ‹¼å‡‘ç»„åˆå…¶ä»–ç¼“å†²åŒºï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥ï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/OmoL7vZDizgM9KT.png" alt="image-20230306174009890" />
    
  </figure>

</p>
<p>è¿™æ ·ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦å¯¹ä¸¤ä¸ªç¼“å†²åŒºç»„åˆçš„å†…å®¹è¿›è¡Œæ“ä½œï¼Œæˆ‘ä»¬å°±ä¸ç”¨å†å•ç‹¬åˆ›å»ºä¸€ä¸ªæ–°çš„ç¼“å†²åŒºäº†ï¼Œè€Œæ˜¯ç›´æ¥å°†å…¶è¿›è¡Œæ‹¼æ¥æ“ä½œï¼Œç›¸å½“äºæ˜¯ä½œä¸ºå¤šä¸ªç¼“å†²åŒºç»„åˆçš„è§†å›¾ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//åˆ›å»ºä¸€ä¸ªå¤åˆç¼“å†²åŒº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">CompositeByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">Unpooled</span><span class="o">.</span><span class="na">compositeBuffer</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">buf</span><span class="o">.</span><span class="na">addComponent</span><span class="o">(</span><span class="n">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">(</span><span class="s">&#34;abc&#34;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl"><span class="n">buf</span><span class="o">.</span><span class="na">addComponent</span><span class="o">(</span><span class="n">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">(</span><span class="s">&#34;def&#34;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buf</span><span class="o">.</span><span class="na">capacity</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">((</span><span class="kt">char</span><span class="o">)</span> <span class="n">buf</span><span class="o">.</span><span class="na">getByte</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¹Ÿå¯ä»¥æ­£å¸¸æ“ä½œç»„åˆåçš„ç¼“å†²åŒºã€‚</p>
<p>æœ€åæˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œæ± åŒ–ç¼“å†²åŒºå’Œéæ± åŒ–ç¼“å†²åŒºçš„åŒºåˆ«ã€‚</p>
<p>æˆ‘ä»¬ç ”ç©¶ä¸€ä¸‹Unpooledå·¥å…·ç±»ä¸­å…·ä½“æ˜¯å¦‚ä½•åˆ›å»ºbufferçš„ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Unpooled</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ByteBufAllocator</span> <span class="n">ALLOC</span><span class="o">;</span>  <span class="c1">//å®é™…ä¸Šå†…éƒ¨æ˜¯æœ‰ä¸€ä¸ªByteBufAllocatorå¯¹è±¡çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ByteOrder</span> <span class="n">BIG_ENDIAN</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ByteOrder</span> <span class="n">LITTLE_ENDIAN</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ByteBuf</span> <span class="n">EMPTY_BUFFER</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">ByteBuf</span> <span class="nf">buffer</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ALLOC</span><span class="o">.</span><span class="na">heapBuffer</span><span class="o">();</span>   <span class="c1">//ç¼“å†²åŒºçš„åˆ›å»ºæ“ä½œå®é™…ä¸Šæ˜¯ä¾é ByteBufAllocatoræ¥è¿›è¡Œçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  	<span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="o">{</span>   <span class="c1">//ALLOCåœ¨é™æ€ä»£ç å—ä¸­è¿›è¡ŒæŒ‡å®šï¼Œå®é™…ä¸ŠçœŸæ­£çš„å®ç°ç±»æ˜¯UnpooledByteBufAllocator
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ALLOC</span> <span class="o">=</span> <span class="n">UnpooledByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">BIG_ENDIAN</span> <span class="o">=</span> <span class="n">ByteOrder</span><span class="o">.</span><span class="na">BIG_ENDIAN</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">LITTLE_ENDIAN</span> <span class="o">=</span> <span class="n">ByteOrder</span><span class="o">.</span><span class="na">LITTLE_ENDIAN</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">EMPTY_BUFFER</span> <span class="o">=</span> <span class="n">ALLOC</span><span class="o">.</span><span class="na">buffer</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>   <span class="c1">//ç©ºç¼“å†²åŒºå®¹é‡å’Œæœ€å¤§å®¹é‡éƒ½æ˜¯0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">EMPTY_BUFFER</span> <span class="k">instanceof</span> <span class="n">EmptyByteBuf</span> <span class="o">:</span> <span class="s">&#34;EMPTY_BUFFER must be an EmptyByteBuf.&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>é‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œè¿™ä¸ªByteBufAllocatoråˆæ˜¯ä¸ªå•¥ï¼Œé¡¾åæ€ä¹‰ï¼Œå…¶å®å°±æ˜¯è´Ÿè´£åˆ†é…ç¼“å†²åŒºçš„ã€‚</p>
<p>å®ƒæœ‰ä¸¤ä¸ªå…·ä½“å®ç°ç±»ï¼š<code>UnpooledByteBufAllocator</code>å’Œ<code>PooledByteBufAllocator</code>ï¼Œä¸€ä¸ªæ˜¯éæ± åŒ–ç¼“å†²åŒºç”Ÿæˆå™¨ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯æ± åŒ–ç¼“å†²åŒºç”Ÿæˆå™¨ï¼Œé‚£ä¹ˆæ± åŒ–å’Œéæ± åŒ–æœ‰å•¥åŒºåˆ«å‘¢ï¼Ÿ</p>
<p>å®é™…ä¸Šæ± åŒ–ç¼“å†²åŒºåˆ©ç”¨äº†æ± åŒ–æ€æƒ³ï¼Œå°†ç¼“å†²åŒºé€šè¿‡è®¾ç½®å†…å­˜æ± æ¥è¿›è¡Œå†…å­˜å—å¤ç”¨ï¼Œè¿™æ ·å°±ä¸ç”¨é¢‘ç¹åœ°è¿›è¡Œå†…å­˜çš„ç”³è¯·ï¼Œå°¤å…¶æ˜¯åœ¨ä½¿ç”¨å †å¤–å†…å­˜çš„æ—¶å€™ï¼Œé¿å…å¤šæ¬¡é‡å¤é€šè¿‡åº•å±‚<code>malloc()</code>å‡½æ•°ç³»ç»Ÿè°ƒç”¨ç”³è¯·å†…å­˜é€ æˆçš„æ€§èƒ½æŸå¤±ã€‚Nettyçš„å†…å­˜ç®¡ç†æœºåˆ¶ä¸»è¦æ˜¯å€Ÿé‰´Jemallocå†…å­˜åˆ†é…ç­–ç•¥ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥æ·±å…¥äº†è§£ä¸€ä¸‹ã€‚</p>
<p>æ‰€ä»¥ï¼Œç”±äºæ˜¯å¤ç”¨å†…å­˜ç©ºé—´ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸ªä¾‹å­ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ByteBufAllocator</span> <span class="n">allocator</span> <span class="o">=</span> <span class="n">PooledByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">allocator</span><span class="o">.</span><span class="na">directBuffer</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>   <span class="c1">//ç”³è¯·ä¸€ä¸ªå®¹é‡ä¸º10çš„ç›´æ¥ç¼“å†²åŒº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">buf</span><span class="o">.</span><span class="na">writeChar</span><span class="o">(</span><span class="sc">&#39;T&#39;</span><span class="o">);</span>    <span class="c1">//éšä¾¿æ“ä½œæ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">readChar</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>    <span class="c1">//é‡Šæ”¾æ­¤ç¼“å†²åŒº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">ByteBuf</span> <span class="n">buf2</span> <span class="o">=</span> <span class="n">allocator</span><span class="o">.</span><span class="na">directBuffer</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>   <span class="c1">//é‡æ–°å†ç”³è¯·ä¸€ä¸ªåŒæ ·å¤§å°çš„ç›´æ¥ç¼“å†²åŒº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf2</span> <span class="o">==</span> <span class="n">buf</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æˆ‘ä»¬ä½¿ç”¨å®Œä¸€ä¸ªç¼“å†²åŒºä¹‹åï¼Œæˆ‘ä»¬å°†å…¶è¿›è¡Œèµ„æºé‡Šæ”¾ï¼Œå½“æˆ‘ä»¬å†æ¬¡ç”³è¯·ä¸€ä¸ªåŒæ ·å¤§å°çš„ç¼“å†²åŒºæ—¶ï¼Œä¼šç›´æ¥å¾—åˆ°ä¹‹å‰å·²ç»ç”³è¯·å¥½çš„ç¼“å†²åŒºï¼Œæ‰€ä»¥ï¼ŒPooledByteBufAllocatorå®é™…ä¸Šæ˜¯å°†ByteBufå®ä¾‹æ”¾å…¥æ± ä¸­åœ¨è¿›è¡Œå¤ç”¨ã€‚</p>
<p><strong>æ± åŒ–æŠ€æœ¯ï¼Œé¿å…åº•å±‚é‡å¤çš„mallocæ“ä½œæµªè´¹æ€§èƒ½</strong></p>


<h3 class="relative group">é›¶æ‹·è´ç®€ä»‹ 
    <div id="%E9%9B%B6%E6%8B%B7%E8%B4%9D%E7%AE%80%E4%BB%8B" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E9%9B%B6%E6%8B%B7%E8%B4%9D%E7%AE%80%E4%BB%8B" aria-label="é”šç‚¹">#</a>
    </span>        
    
</h3>
<p>**æ³¨æ„ï¼š**æ­¤å°èŠ‚ä½œä¸ºé€‰å­¦å†…å®¹ï¼Œéœ€è¦æŒæ¡<code>æ“ä½œç³»ç»Ÿ</code>å’Œ<code>è®¡ç®—æœºç»„æˆåŸç†</code>æ‰èƒ½å­¦ä¹ ã€‚</p>
<p>é›¶æ‹·è´æ˜¯ä¸€ç§I/Oæ“ä½œä¼˜åŒ–æŠ€æœ¯ï¼Œå¯ä»¥å¿«é€Ÿé«˜æ•ˆåœ°å°†æ•°æ®ä»æ–‡ä»¶ç³»ç»Ÿç§»åŠ¨åˆ°ç½‘ç»œæ¥å£ï¼Œè€Œä¸éœ€è¦å°†å…¶ä»å†…æ ¸ç©ºé—´å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ï¼Œé¦–å…ˆç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œä»€ä¹ˆæ˜¯å†…æ ¸ç©ºé—´ï¼Œä»€ä¹ˆåˆæ˜¯ç”¨æˆ·ç©ºé—´å‘¢ï¼Ÿ</p>
<p>å…¶å®æ—©æœŸæ“ä½œç³»ç»Ÿæ˜¯ä¸åŒºåˆ†å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´çš„ï¼Œä½†æ˜¯åº”ç”¨ç¨‹åºèƒ½è®¿é—®ä»»æ„å†…å­˜ç©ºé—´ï¼Œç¨‹åºå¾ˆå®¹æ˜“ä¸ç¨³å®šï¼Œå¸¸å¸¸æŠŠç³»ç»Ÿæå´©æºƒï¼Œæ¯”å¦‚æ¸…é™¤æ“ä½œç³»ç»Ÿçš„å†…å­˜æ•°æ®ã€‚å®é™…ä¸Šè®©åº”ç”¨ç¨‹åºéšä¾¿è®¿é—®å†…å­˜çœŸçš„å¤ªå±é™©äº†ï¼Œäºæ˜¯å°±æŒ‰ç…§CPU æŒ‡ä»¤çš„é‡è¦ç¨‹åº¦å¯¹æŒ‡ä»¤è¿›è¡Œäº†åˆ†çº§ï¼ŒæŒ‡ä»¤åˆ†ä¸ºå››ä¸ªçº§åˆ«ï¼šRing0 ~ Ring3ï¼ŒLinux ä¸‹åªä½¿ç”¨äº† Ring0 å’Œ Ring3 ä¸¤ä¸ªè¿è¡Œçº§åˆ«ï¼Œè¿›ç¨‹è¿è¡Œåœ¨ Ring3 çº§åˆ«æ—¶è¿è¡Œåœ¨ç”¨æˆ·æ€ï¼ŒæŒ‡ä»¤åªè®¿é—®ç”¨æˆ·ç©ºé—´ï¼Œè€Œè¿è¡Œåœ¨ Ring0 çº§åˆ«æ—¶è¢«ç§°ä¸ºè¿è¡Œåœ¨å†…æ ¸æ€ï¼Œå¯ä»¥è®¿é—®ä»»æ„å†…å­˜ç©ºé—´ã€‚</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/vFAi9dKxq72XngD.png" alt="image-20230306174025216" />
    
  </figure>

</p>
<p>æ¯”å¦‚æˆ‘ä»¬Javaä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œå®é™…ä¸Šæœ€ç»ˆæ˜¯è¦äº¤ç»™æ“ä½œç³»ç»Ÿæ¥ä¸ºæˆ‘ä»¬è¿›è¡Œåˆ†é…çš„ï¼Œè€Œéœ€è¦æ“ä½œç³»ç»Ÿå¸®åŠ©æˆ‘ä»¬å®Œæˆä»»åŠ¡åˆ™éœ€è¦è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œæ˜¯å†…æ ¸åœ¨è¿›è¡Œå¤„ç†ï¼Œä¸æ˜¯æˆ‘ä»¬è‡ªå·±çš„ç¨‹åºåœ¨å¤„ç†ï¼Œè¿™æ—¶å°±ç›¸å½“äºæˆ‘ä»¬çš„ç¨‹åºå¤„äºäº†å†…æ ¸æ€ï¼Œè€Œå½“æ“ä½œç³»ç»Ÿåº•å±‚åˆ†é…å®Œæˆï¼Œæœ€ååˆ°æˆ‘ä»¬Javaä»£ç ä¸­è¿”å›å¾—åˆ°çº¿ç¨‹å¯¹è±¡æ—¶ï¼Œåˆç»§ç»­ç”±æˆ‘ä»¬çš„ç¨‹åºè¿›è¡Œæ“ä½œï¼Œæ‰€ä»¥ä»å†…æ ¸æ€è½¬æ¢å›äº†ç”¨æˆ·æ€ã€‚</p>
<p>è€Œæˆ‘ä»¬çš„æ–‡ä»¶æ“ä½œä¹Ÿæ˜¯è¿™æ ·ï¼Œæˆ‘ä»¬å®é™…ä¸Šä¹Ÿæ˜¯éœ€è¦è®©æ“ä½œç³»ç»Ÿå¸®åŠ©æˆ‘ä»¬ä»ç£ç›˜ä¸Šè¯»å–æ–‡ä»¶æ•°æ®æˆ–æ˜¯å‘ç½‘ç»œå‘é€æ•°æ®ï¼Œæ¯”å¦‚ä½¿ç”¨ä¼ ç»ŸIOçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¦ä»ç£ç›˜ä¸Šè¯»å–æ–‡ä»¶ç„¶åå‘é€åˆ°ç½‘ç»œä¸Šï¼Œå°±ä¼šç»å†ä»¥ä¸‹æµç¨‹ï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/IYerlt95BLyFh7X.png" alt="image-20230306174033340" />
    
  </figure>

</p>
<p>å¯ä»¥çœ‹åˆ°æ•´ä¸ªè¿‡ç¨‹ä¸­æ˜¯ç»å†äº†2æ¬¡CPUæ‹·è´+2æ¬¡DMAæ‹·è´ï¼Œä¸€å…±å››æ¬¡æ‹·è´ï¼Œè™½ç„¶é€»è¾‘æ¯”è¾ƒæ¸…æ™°ï¼Œä½†æ˜¯æ•°æ®è€æ˜¯è¿™æ ·æ¥å›è¿›è¡Œå¤åˆ¶ï¼Œæ˜¯ä¸æ˜¯å¤ªæµªè´¹æ—¶é—´äº†ç‚¹ï¼Ÿæ‰€ä»¥æˆ‘ä»¬å°±éœ€è¦å¯»æ‰¾ä¸€ç§æ›´å¥½çš„æ–¹å¼ï¼Œæ¥å®ç°é›¶æ‹·è´ã€‚</p>
<p>å®ç°é›¶æ‹·è´æˆ‘ä»¬è¿™é‡Œæ¼”ç¤ºä¸‰ç§æ–¹æ¡ˆï¼š</p>
<ol>
<li>
<p>ä½¿ç”¨è™šæ‹Ÿå†…å­˜</p>
<p>ç°åœ¨çš„æ“ä½œç³»ç»ŸåŸºæœ¬éƒ½æ˜¯æ”¯æŒè™šæ‹Ÿå†…å­˜çš„ï¼Œæˆ‘ä»¬å¯ä»¥è®©å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´çš„è™šæ‹Ÿåœ°å€æŒ‡å‘åŒä¸€ä¸ªç‰©ç†åœ°å€ï¼Œè¿™æ ·å°±ç›¸å½“äºæ˜¯ç›´æ¥å…±ç”¨äº†è¿™ä¸€å—åŒºåŸŸï¼Œä¹Ÿå°±è°ˆä¸ä¸Šæ‹·è´æ“ä½œäº†ï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/Kfi9uo32CYTHO6e.png" alt="image-20230306174044056" />
    
  </figure>

</p>
</li>
<li>
<p>ä½¿ç”¨mmap/writeå†…å­˜æ˜ å°„</p>
<p>å®é™…ä¸Šè¿™ç§æ–¹å¼å°±æ˜¯å°†å†…æ ¸ç©ºé—´ä¸­çš„ç¼“å­˜ç›´æ¥æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ç¼“å­˜ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¹‹å‰åœ¨å­¦ä¹ NIOä¸­ä½¿ç”¨çš„MappedByteBufferï¼Œå°±æ˜¯ç›´æ¥ä½œä¸ºæ˜ å°„å­˜åœ¨ï¼Œå½“æˆ‘ä»¬éœ€è¦å°†æ•°æ®å‘é€åˆ°Socketç¼“å†²åŒºæ—¶ï¼Œç›´æ¥åœ¨å†…æ ¸ç©ºé—´ä¸­è¿›è¡Œæ“ä½œå°±è¡Œäº†ï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/3lEWLi8DsrCUSMg.png" alt="image-20230306174056380" />
    
  </figure>

</p>
<p>ä¸è¿‡è¿™æ ·è¿˜æ˜¯ä¼šå‡ºç°ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼Œæˆ‘ä»¬å¾—å†ä¼˜åŒ–ä¼˜åŒ–ã€‚</p>
</li>
<li>
<p>ä½¿ç”¨sendfileæ–¹å¼</p>
<p>åœ¨Linux2.1å¼€å§‹ï¼Œå¼•å…¥äº†sendfileæ–¹å¼æ¥ç®€åŒ–æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å‘Šè¯‰å†…æ ¸è¦æŠŠå“ªä¸ªæ–‡ä»¶æ•°æ®æ‹·è´æ‹·è´åˆ°Socketä¸Šï¼Œç›´æ¥åœ¨å†…æ ¸ç©ºé—´ä¸­ä¸€æ­¥åˆ°ä½ï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/CJraDsyKBEnie1z.png" alt="image-20230306174108253" />
    
  </figure>

</p>
<p>æ¯”å¦‚æˆ‘ä»¬ä¹‹å‰åœ¨NIOä¸­ä½¿ç”¨çš„<code>transferTo()</code>æ–¹æ³•ï¼Œå°±æ˜¯åˆ©ç”¨äº†è¿™ç§æœºåˆ¶æ¥å®ç°é›¶æ‹·è´çš„ã€‚</p>
</li>
</ol>


<h3 class="relative group">Nettyå·¥ä½œæ¨¡å‹ 
    <div id="netty%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%9E%8B" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#netty%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%9E%8B" aria-label="é”šç‚¹">#</a>
    </span>        
    
</h3>
<p>å‰é¢æˆ‘ä»¬äº†è§£äº†Nettyä¸ºæˆ‘ä»¬æä¾›çš„æ›´é«˜çº§çš„ç¼“å†²åŒºç±»ï¼Œæˆ‘ä»¬æ¥ç€æ¥çœ‹çœ‹Nettyæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä¸Šä¸€ç« æˆ‘ä»¬ä»‹ç»äº†Reactoræ¨¡å¼ï¼Œè€ŒNettyæ­£æ˜¯ä»¥ä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å‹ä¸ºåŸºç¡€ï¼Œæ„å»ºå‡ºäº†ä¸€å¥—é«˜æ•ˆçš„å·¥ä½œæ¨¡å‹ã€‚</p>
<p>å¤§è‡´å·¥ä½œæ¨¡å‹å›¾å¦‚ä¸‹ï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/7qrSNvm6ePpMd9H.png" alt="image-20230306174117322" />
    
  </figure>

</p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå’Œæˆ‘ä»¬ä¹‹å‰ä»‹ç»çš„ä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å‹éå¸¸ç±»ä¼¼ï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/pWGVdnqsmjucClJ.png" alt="image-20230306174127616" />
    
  </figure>

</p>
<p>æ‰€æœ‰çš„å®¢æˆ·ç«¯éœ€è¦è¿æ¥åˆ°ä¸»Reactorå®ŒæˆAcceptæ“ä½œåï¼Œå…¶ä»–çš„æ“ä½œç”±ä»Reactorå»å®Œæˆï¼Œè¿™é‡Œä¹Ÿæ˜¯å·®ä¸å¤šçš„æ€æƒ³ï¼Œä½†æ˜¯å®ƒè¿›è¡Œäº†ä¸€äº›æ”¹è¿›ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„è®¾è®¡ï¼š</p>
<ul>
<li>Netty æŠ½è±¡å‡ºä¸¤ç»„çº¿ç¨‹æ± BossGroupå’ŒWorkerGroupï¼ŒBossGroupä¸“é—¨è´Ÿè´£æ¥å—å®¢æˆ·ç«¯çš„è¿æ¥, WorkerGroupä¸“é—¨è´Ÿè¯»å†™ï¼Œå°±åƒæˆ‘ä»¬å‰é¢è¯´çš„ä¸»ä»Reactorä¸€æ ·ã€‚</li>
<li>æ— è®ºæ˜¯BossGroupè¿˜æ˜¯WorkerGroupï¼Œéƒ½æ˜¯ä½¿ç”¨EventLoopï¼ˆäº‹ä»¶å¾ªç¯ï¼Œå¾ˆå¤šç³»ç»Ÿéƒ½é‡‡ç”¨äº†äº‹ä»¶å¾ªç¯æœºåˆ¶ï¼Œæ¯”å¦‚å‰ç«¯æ¡†æ¶Node.jsï¼Œäº‹ä»¶å¾ªç¯é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œä¸æ–­åœ°è¿›è¡Œäº‹ä»¶é€šçŸ¥ï¼‰æ¥è¿›è¡Œäº‹ä»¶ç›‘å¬çš„ï¼Œæ•´ä¸ªNettyä¹Ÿæ˜¯ä½¿ç”¨äº‹ä»¶é©±åŠ¨æ¥è¿ä½œçš„ï¼Œæ¯”å¦‚å½“å®¢æˆ·ç«¯å·²ç»å‡†å¤‡å¥½è¯»å†™ã€è¿æ¥å»ºç«‹æ—¶ï¼Œéƒ½ä¼šè¿›è¡Œäº‹ä»¶é€šçŸ¥ï¼Œè¯´ç™½äº†å°±åƒæˆ‘ä»¬ä¹‹å‰å†™NIOå¤šè·¯å¤ç”¨é‚£æ ·ï¼Œåªä¸è¿‡è¿™é‡Œæ¢æˆEventLoopäº†è€Œå·²ï¼Œå®ƒå·²ç»å¸®åŠ©æˆ‘ä»¬å°è£…å¥½äº†ä¸€äº›å¸¸ç”¨æ“ä½œï¼Œè€Œä¸”æˆ‘ä»¬å¯ä»¥è‡ªå·±æ·»åŠ ä¸€äº›é¢å¤–çš„ä»»åŠ¡ï¼Œå¦‚æœæœ‰å¤šä¸ªEventLoopï¼Œä¼šå­˜æ”¾åœ¨EventLoopGroupä¸­ï¼ŒEventLoopGroupå°±æ˜¯BossGroupå’ŒWorkerGroupçš„å…·ä½“å®ç°ã€‚</li>
<li>åœ¨BossGroupä¹‹åï¼Œä¼šæ­£å¸¸å°†SocketChannelç»‘å®šåˆ°WorkerGroupä¸­çš„å…¶ä¸­ä¸€ä¸ªEventLoopä¸Šï¼Œè¿›è¡Œåç»­çš„è¯»å†™æ“ä½œç›‘å¬ã€‚</li>
</ul>
<p>å‰é¢æˆ‘ä»¬å¤§è‡´äº†è§£äº†ä¸€ä¸‹Nettyçš„å·¥ä½œæ¨¡å‹ï¼Œæ¥ç€æˆ‘ä»¬æ¥å°è¯•åˆ›å»ºä¸€ä¸ªNettyæœåŠ¡å™¨ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨NioEventLoopGroupå®ç°ç±»å³å¯ï¼Œåˆ›å»ºBossGroupå’ŒWorkerGroup
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//å½“ç„¶è¿˜æœ‰EpollEventLoopGroupï¼Œä½†æ˜¯ä»…æ”¯æŒLinuxï¼Œè¿™æ˜¯NettyåŸºäºLinuxåº•å±‚Epollå•ç‹¬ç¼–å†™çš„ä¸€å¥—æœ¬åœ°å®ç°ï¼Œæ²¡æœ‰ä½¿ç”¨NIOé‚£å¥—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">EventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">(),</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//åˆ›å»ºæœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼ç±»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ServerBootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerBootstrap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//å¯é“¾å¼ï¼Œå°±å¾ˆæ£’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">bootstrap</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>   <span class="c1">//æŒ‡å®šäº‹ä»¶å¾ªç¯ç»„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>   <span class="c1">//æŒ‡å®šä¸ºNIOçš„ServerSocketChannel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>   <span class="c1">//æ³¨æ„ï¼Œè¿™é‡Œçš„SocketChannelä¸æ˜¯æˆ‘ä»¬NIOé‡Œé¢çš„ï¼Œæ˜¯Nettyçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">//è·å–æµæ°´çº¿ï¼Œå½“æˆ‘ä»¬éœ€è¦å¤„ç†å®¢æˆ·ç«¯çš„æ•°æ®æ—¶ï¼Œå®é™…ä¸Šæ˜¯åƒæµæ°´çº¿ä¸€æ ·åœ¨å¤„ç†ï¼Œè¿™ä¸ªæµæ°´çº¿ä¸Šå¯ä»¥æœ‰å¾ˆå¤šHandler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInboundHandlerAdapter</span><span class="o">(){</span>   <span class="c1">//æ·»åŠ ä¸€ä¸ªHandlerï¼Œè¿™é‡Œä½¿ç”¨ChannelInboundHandlerAdapter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>  <span class="c1">//ctxæ˜¯ä¸Šä¸‹æ–‡ï¼Œmsgæ˜¯æ”¶åˆ°çš„æ¶ˆæ¯ï¼Œé»˜è®¤ä»¥ByteBufå½¢å¼ï¼ˆä¹Ÿå¯ä»¥æ˜¯å…¶ä»–å½¢å¼ï¼Œåé¢å†è¯´ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>   <span class="c1">//ç±»å‹è½¬æ¢ä¸€ä¸‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">&#34; &gt;&gt; æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š&#34;</span><span class="o">+</span><span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                            <span class="c1">//é€šè¿‡ä¸Šä¸‹æ–‡å¯ä»¥ç›´æ¥å‘é€æ•°æ®å›å»ï¼Œæ³¨æ„è¦writeAndFlushæ‰èƒ½è®©å®¢æˆ·ç«¯ç«‹å³æ”¶åˆ°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">Unpooled</span><span class="o">.</span><span class="na">wrappedBuffer</span><span class="o">(</span><span class="s">&#34;å·²æ”¶åˆ°ï¼&#34;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span>
</span></span><span class="line"><span class="cl">                    <span class="o">});</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//æœ€åç»‘å®šç«¯å£ï¼Œå¯åŠ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">bootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">8080</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ä¸Šé¢å†™äº†å¾ˆå¤šä¸œè¥¿ï¼Œä½†æ˜¯ä½ ä¸€å®šä¼šæ‡µé€¼ï¼Œè¿™äº›æ–°æ¥çš„ä¸œè¥¿ï¼Œéƒ½æ˜¯ä»€ä¹ˆè·Ÿä»€ä¹ˆå•Šï¼Œæ€ä¹ˆä¸€ä¸ªä¹Ÿæ²¡çœ‹æ˜ç™½ï¼Ÿæ²¡å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥æš‚æ—¶å…ˆå°†ä»£ç å†™åœ¨è¿™é‡Œï¼Œå…·ä½“çš„å„ä¸ªéƒ¨åˆ†ï¼Œè¿˜è¯·å¬åé¢ç»†ç»†é“æ¥ã€‚</p>
<p>æˆ‘ä»¬æ¥ç€ç¼–å†™ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å¯ä»¥ç›´æ¥ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰çš„ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//åˆ›å»ºä¸€ä¸ªæ–°çš„SocketChannelï¼Œä¸€ä¼šé€šè¿‡é€šé“è¿›è¡Œé€šä¿¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">try</span> <span class="o">(</span><span class="n">SocketChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">SocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="k">new</span> <span class="n">InetSocketAddress</span><span class="o">(</span><span class="s">&#34;localhost&#34;</span><span class="o">,</span> <span class="mi">8080</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">         <span class="n">Scanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">in</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;å·²è¿æ¥åˆ°æœåŠ¡ç«¯ï¼&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>   <span class="c1">//å’±ç»™å®ƒå¥—ä¸ªæ— é™å¾ªç¯ï¼Œè¿™æ ·å°±èƒ½ä¸€ç›´å‘æ¶ˆæ¯äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;è¯·è¾“å…¥è¦å‘é€ç»™æœåŠ¡ç«¯çš„å†…å®¹ï¼š&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">text</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">text</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//ç›´æ¥å‘é€šé“ä¸­å†™å…¥æ•°æ®ï¼ŒçœŸèˆ’æœ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">channel</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">ByteBuffer</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">text</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;å·²å‘é€ï¼&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">128</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">channel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>   <span class="c1">//ç›´æ¥ä»é€šé“ä¸­è¯»å–æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æ”¶åˆ°æœåŠ¡å™¨è¿”å›ï¼š&#34;</span><span class="o">+</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">array</span><span class="o">(),</span> <span class="mi">0</span><span class="o">,</span> <span class="n">buffer</span><span class="o">.</span><span class="na">remaining</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>é€šè¿‡é€šé“æ­£å¸¸æ”¶å‘æ•°æ®å³å¯ï¼Œè¿™æ ·æˆ‘ä»¬å°±æˆåŠŸæ­å»ºå¥½äº†ä¸€ä¸ªNettyæœåŠ¡å™¨ã€‚</p>


<h3 class="relative group">Channelè¯¦è§£ 
    <div id="channel%E8%AF%A6%E8%A7%A3" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#channel%E8%AF%A6%E8%A7%A3" aria-label="é”šç‚¹">#</a>
    </span>        
    
</h3>
<p>åœ¨å­¦ä¹ NIOæ—¶ï¼Œæˆ‘ä»¬å°±å·²ç»æ¥è§¦åˆ°Channeläº†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é€šé“æ¥è¿›è¡Œæ•°æ®çš„ä¼ è¾“ï¼Œå¹¶ä¸”é€šé“æ”¯æŒåŒå‘ä¼ è¾“ã€‚</p>
<p>è€Œåœ¨Nettyä¸­ï¼Œä¹Ÿæœ‰å¯¹åº”çš„Channelç±»å‹ï¼š</p>
<p>æ¥å£çš„é™æ€å˜é‡é€šå¸¸ä¸ä¼šå†è¿è¡Œæ—¶è¢«ä½¿ç”¨ï¼Œä¸ä¼šäº§ç”Ÿæ­§ä¹‰é—®é¢˜</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Channel</span> <span class="kd">extends</span> <span class="n">AttributeMap</span><span class="o">,</span> <span class="n">ChannelOutboundInvoker</span><span class="o">,</span> <span class="n">Comparable</span><span class="o">&lt;</span><span class="n">Channel</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelId</span> <span class="nf">id</span><span class="o">();</span>   <span class="c1">//é€šé“ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">EventLoop</span> <span class="nf">eventLoop</span><span class="o">();</span>   <span class="c1">//è·å–æ­¤é€šé“æ‰€å±çš„EventLoopï¼Œå› ä¸ºä¸€ä¸ªChannelåœ¨å®ƒçš„ç”Ÿå‘½å‘¨æœŸå†…åªèƒ½æ³¨å†Œåˆ°ä¸€ä¸ªEventLoopä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Channel</span> <span class="nf">parent</span><span class="o">();</span>   <span class="c1">//Channelæ˜¯å…·æœ‰å±‚çº§å…³ç³»çš„ï¼Œè¿™é‡Œæ˜¯è¿”å›çˆ¶Channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ChannelConfig</span> <span class="nf">config</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="nf">isOpen</span><span class="o">();</span>   <span class="c1">//é€šé“å½“å‰çš„ç›¸å…³çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">boolean</span> <span class="nf">isRegistered</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="nf">isActive</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelMetadata</span> <span class="nf">metadata</span><span class="o">();</span>   <span class="c1">//é€šé“ç›¸å…³ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">SocketAddress</span> <span class="nf">localAddress</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">SocketAddress</span> <span class="nf">remoteAddress</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">closeFuture</span><span class="o">();</span>  <span class="c1">//å…³é—­é€šé“ï¼Œä½†æ˜¯ä¼šç”¨åˆ°ChannelFutureï¼Œåé¢è¯´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">boolean</span> <span class="nf">isWritable</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="nf">bytesBeforeUnwritable</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="nf">bytesBeforeWritable</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Unsafe</span> <span class="nf">unsafe</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="nf">pipeline</span><span class="o">();</span>   <span class="c1">//æµæ°´çº¿ï¼Œä¹‹åä¹Ÿä¼šè¯´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ByteBufAllocator</span> <span class="nf">alloc</span><span class="o">();</span>   <span class="c1">//å¯ä»¥ç›´æ¥ä»Channelæ‹¿åˆ°ByteBufAllocatorçš„å®ä¾‹ï¼Œæ¥åˆ†é…ByteBuf
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Channel</span> <span class="nf">read</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Channel</span> <span class="nf">flush</span><span class="o">();</span>   <span class="c1">//åˆ·æ–°ï¼ŒåŸºæ“
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼ŒNettyä¸­çš„Channelç›¸æ¯”NIOåŠŸèƒ½å°±å¤šå¾—å¤šäº†ã€‚Nettyä¸­çš„Channelä¸»è¦ç‰¹ç‚¹å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ‰€æœ‰çš„IOæ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œå¹¶ä¸æ˜¯åœ¨å½“å‰çº¿ç¨‹åŒæ­¥è¿è¡Œï¼Œæ–¹æ³•è°ƒç”¨ä¹‹åå°±ç›´æ¥è¿”å›äº†ï¼Œé‚£æ€ä¹ˆè·å–æ“ä½œçš„ç»“æœå‘¢ï¼Ÿè¿˜è®°å¾—æˆ‘ä»¬åœ¨å‰é¢JUCç¯‡æ•™ç¨‹ä¸­å­¦ä¹ çš„Futureå—ï¼Œæ²¡é”™ï¼Œè¿™é‡Œçš„ChannelFutureä¹Ÿæ˜¯å¹²è¿™äº‹çš„ã€‚</li>
</ul>
<p>å¤šçº¿ç¨‹é€šè¿‡Futureæ¥è·å–çº¿ç¨‹æ‰§è¡Œçš„ç»“æœ</p>
<p>æˆ‘ä»¬å¯ä»¥æ¥çœ‹ä¸€ä¸‹Channelæ¥å£çš„çˆ¶æ¥å£ChannelOutboundInvokeræ¥å£ï¼Œè¿™é‡Œé¢å®šä¹‰äº†å¤§é‡çš„I/Oæ“ä½œï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ChannelOutboundInvoker</span> <span class="o">{</span>   <span class="c1">//é€šé“å‡ºç«™è°ƒç”¨ï¼ˆåŒ…å«å¤§é‡çš„ç½‘ç»œå‡ºç«™æ“ä½œï¼Œæ¯”å¦‚å†™ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ChannelFuture</span> <span class="nf">bind</span><span class="o">(</span><span class="n">SocketAddress</span> <span class="n">var1</span><span class="o">);</span>  <span class="c1">//Socketç»‘å®šã€è¿æ¥ã€æ–­å¼€ã€å…³é—­ç­‰æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ChannelFuture</span> <span class="nf">connect</span><span class="o">(</span><span class="n">SocketAddress</span> <span class="n">var1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">connect</span><span class="o">(</span><span class="n">SocketAddress</span> <span class="n">var1</span><span class="o">,</span> <span class="n">SocketAddress</span> <span class="n">var2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">disconnect</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">deregister</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">bind</span><span class="o">(</span><span class="n">SocketAddress</span> <span class="n">var1</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">var2</span><span class="o">);</span>    <span class="c1">//ä¸‹é¢è¿™ä¸€ç³»åˆ—è¿˜æœ‰é™„å¸¦ChannelPromiseçš„ï¼ŒChannelPromiseæˆ‘ä»¬åé¢å†è¯´ï¼Œå…¶å®å°±æ˜¯ChannelFutureçš„å¢å¼ºç‰ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ChannelFuture</span> <span class="nf">connect</span><span class="o">(</span><span class="n">SocketAddress</span> <span class="n">var1</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">var2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">connect</span><span class="o">(</span><span class="n">SocketAddress</span> <span class="n">var1</span><span class="o">,</span> <span class="n">SocketAddress</span> <span class="n">var2</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">var3</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">disconnect</span><span class="o">(</span><span class="n">ChannelPromise</span> <span class="n">var1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">close</span><span class="o">(</span><span class="n">ChannelPromise</span> <span class="n">var1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">deregister</span><span class="o">(</span><span class="n">ChannelPromise</span> <span class="n">var1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelOutboundInvoker</span> <span class="nf">read</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">write</span><span class="o">(</span><span class="n">Object</span> <span class="n">var1</span><span class="o">);</span>    <span class="c1">//å¯ä»¥çœ‹åˆ°è¿™äº›å¸¸è§çš„å†™æ“ä½œï¼Œéƒ½æ˜¯è¿”å›çš„ChannelFutureï¼Œè€Œä¸æ˜¯ç›´æ¥ç»™ç»“æœ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ChannelFuture</span> <span class="nf">write</span><span class="o">(</span><span class="n">Object</span> <span class="n">var1</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">var2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelOutboundInvoker</span> <span class="nf">flush</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">writeAndFlush</span><span class="o">(</span><span class="n">Object</span> <span class="n">var1</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">var2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">writeAndFlush</span><span class="o">(</span><span class="n">Object</span> <span class="n">var1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPromise</span> <span class="nf">newPromise</span><span class="o">();</span>   <span class="c1">//å…¶ä»–çš„æš‚æ—¶ä¸æ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ChannelProgressivePromise</span> <span class="nf">newProgressivePromise</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">newSucceededFuture</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">newFailedFuture</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">var1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPromise</span> <span class="nf">voidPromise</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>å½“ç„¶å®ƒè¿˜å®ç°äº†AttributeMapæ¥å£ï¼Œå…¶å®æœ‰ç‚¹ç±»ä¼¼äºSessioné‚£ç§æ„Ÿè§‰ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€äº›å±æ€§ä¹‹ç±»çš„ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AttributeMap</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Attribute</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">attr</span><span class="o">(</span><span class="n">AttributeKey</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">var1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kt">boolean</span> <span class="nf">hasAttr</span><span class="o">(</span><span class="n">AttributeKey</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">var1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬äº†è§£äº†Nettyåº•å±‚çš„Channelä¹‹åï¼Œæˆ‘ä»¬æ¥ç€æ¥çœ‹ChannelHandlerï¼Œæ—¢ç„¶ç°åœ¨æœ‰äº†é€šé“ï¼Œé‚£ä¹ˆæ€ä¹ˆè¿›è¡Œæ“ä½œå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å°†éœ€è¦å¤„ç†çš„äº‹æƒ…æ”¾åœ¨ChannelHandlerä¸­ï¼ŒChannelHandlerå……å½“äº†æ‰€æœ‰å…¥ç«™å’Œå‡ºç«™æ•°æ®çš„åº”ç”¨ç¨‹åºé€»è¾‘çš„å®¹å™¨ï¼Œå®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬ä¹‹å‰Reactoræ¨¡å¼ä¸­çš„Handlerï¼Œå…¨é å®ƒæ¥å¤„ç†è¯»å†™æ“ä½œã€‚</p>
<p>ä¸è¿‡è¿™é‡Œä¸ä»…ä»…æ˜¯ä¸€ä¸ªç®€å•çš„ChannelHandleråœ¨è¿›è¡Œå¤„ç†ï¼Œè€Œæ˜¯ä¸€æ•´å¥—æµæ°´çº¿ï¼Œæˆ‘ä»¬ä¹‹åä¼šä»‹ç»ChannelPipelineã€‚</p>
<p>æ¯”å¦‚æˆ‘ä»¬ä¸Šé¢å°±æ˜¯ä½¿ç”¨äº†ChannelInboundHandlerAdapteræŠ½è±¡ç±»ï¼Œå®ƒæ˜¯ChannelInboundHandleræ¥å£çš„å®ç°ï¼Œç”¨äºå¤„ç†å…¥ç«™æ•°æ®ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬å®é™…ä¸Šå°±æ˜¯é€šè¿‡é‡å†™å¯¹åº”çš„æ–¹æ³•æ¥è¿›è¡Œå¤„ç†ï¼Œè¿™äº›æ–¹æ³•ä¼šåœ¨åˆé€‚çš„æ—¶é—´è¢«è°ƒç”¨ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      	<span class="c1">//ctxæ˜¯ä¸Šä¸‹æ–‡ï¼Œmsgæ˜¯æ”¶åˆ°çš„æ¶ˆæ¯ï¼Œä»¥ByteBufå½¢å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>   <span class="c1">//ç±»å‹è½¬æ¢ä¸€ä¸‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">&#34; &gt;&gt; æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š&#34;</span><span class="o">+</span><span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//é€šè¿‡ä¸Šä¸‹æ–‡å¯ä»¥ç›´æ¥å‘é€æ•°æ®å›å»ï¼Œæ³¨æ„è¦writeAndFlushæ‰èƒ½è®©å®¢æˆ·ç«¯ç«‹å³æ”¶åˆ°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">Unpooled</span><span class="o">.</span><span class="na">wrappedBuffer</span><span class="o">(</span><span class="s">&#34;å·²æ”¶åˆ°ï¼&#34;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">});</span>
</span></span></code></pre></div><p>æˆ‘ä»¬å…ˆä»é¡¶å±‚æ¥å£å¼€å§‹çœ‹èµ·ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ChannelHandler</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  	<span class="c1">//å½“ChannelHandlerè¢«æ·»åŠ åˆ°æµæ°´çº¿ä¸­æ—¶è°ƒç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">handlerAdded</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//å½“ChannelHandlerä»æµæ°´çº¿ä¸­ç§»é™¤æ—¶è°ƒç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">handlerRemoved</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/** @deprecated å·²è¿‡æ—¶é‚£å’±å°±ä¸ç®¡äº† */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Deprecated</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">var1</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">var2</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Inherited</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Documented</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Target</span><span class="o">({</span><span class="n">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">})</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">Sharable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>é¡¶å±‚æ¥å£çš„å®šä¹‰æ¯”è¾ƒç®€å•ï¼Œå°±åªæœ‰ä¸€äº›æµæ°´çº¿ç›¸å…³çš„å›è°ƒæ–¹æ³•ï¼Œæˆ‘ä»¬æ¥ç€æ¥çœ‹ä¸‹ä¸€çº§ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//ChannelInboundHandlerç”¨äºå¤„ç†å…¥ç«™ç›¸å…³äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ChannelInboundHandler</span> <span class="kd">extends</span> <span class="n">ChannelHandler</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  	<span class="c1">//å½“Channelå·²ç»æ³¨å†Œåˆ°è‡ªå·±çš„EventLoopä¸Šæ—¶è°ƒç”¨ï¼Œå‰é¢æˆ‘ä»¬è¯´äº†ï¼Œä¸€ä¸ªChannelåªä¼šæ³¨å†Œåˆ°ä¸€ä¸ªEventLoopä¸Šï¼Œæ³¨å†Œåˆ°EventLoopåï¼Œè¿™æ ·æ‰ä¼šåœ¨å‘ç”Ÿå¯¹åº”äº‹ä»¶æ—¶è¢«é€šçŸ¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">channelRegistered</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//ä»EventLoopä¸Šå–æ¶ˆæ³¨å†Œæ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">channelUnregistered</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//å½“Channelå·²ç»å¤„äºæ´»è·ƒçŠ¶æ€æ—¶è¢«è°ƒç”¨ï¼Œæ­¤æ—¶Channelå·²ç»è¿æ¥/ç»‘å®šï¼Œå¹¶ä¸”å·²ç»å°±ç»ª
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//è·Ÿä¸Šé¢ç›¸åï¼Œä¸å†æ´»è·ƒäº†ï¼Œå¹¶ä¸”ä¸åœ¨è¿æ¥å®ƒçš„è¿œç¨‹èŠ‚ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">channelInactive</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//å½“ä»Channelè¯»å–æ•°æ®æ—¶è¢«è°ƒç”¨ï¼Œå¯ä»¥çœ‹åˆ°æ•°æ®è¢«è‡ªåŠ¨åŒ…è£…æˆäº†ä¸€ä¸ªObjectï¼ˆé»˜è®¤æ˜¯ByteBufï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">var1</span><span class="o">,</span> <span class="n">Object</span> <span class="n">var2</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//ä¸Šä¸€ä¸ªè¯»å–æ“ä½œå®Œæˆåè°ƒç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">channelReadComplete</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//æš‚æ—¶ä¸ä»‹ç»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">userEventTriggered</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">var1</span><span class="o">,</span> <span class="n">Object</span> <span class="n">var2</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//å½“Channelçš„å¯å†™çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶è¢«è°ƒç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">channelWritabilityChanged</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//å‡ºç°å¼‚å¸¸æ—¶è¢«è°ƒç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">var1</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">var2</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>è€Œæˆ‘ä»¬ä¸Šé¢ç”¨åˆ°çš„ChannelInboundHandlerAdapterå®é™…ä¸Šå°±æ˜¯å¯¹è¿™äº›æ–¹æ³•å®ç°çš„æŠ½è±¡ç±»ï¼Œç›¸æ¯”ç›´æ¥ç”¨æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥åªé‡å†™æˆ‘ä»¬éœ€è¦çš„æ–¹æ³•ï¼Œæ²¡æœ‰é‡å†™çš„æ–¹æ³•ä¼šé»˜è®¤å‘æµæ°´çº¿ä¸‹ä¸€ä¸ªChannelHandlerå‘é€ã€‚</p>
<p>æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹å§ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestChannelHandler</span> <span class="kd">extends</span> <span class="n">ChannelInboundHandlerAdapter</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRegistered</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;channelRegistered&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelUnregistered</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;channelUnregistered&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;channelActive&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelInactive</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;channelInactive&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">&#34; &gt;&gt; æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š&#34;</span><span class="o">+</span><span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//è¿™æ¬¡æˆ‘ä»¬å°±ç›´æ¥ä½¿ç”¨ctx.alloc()æ¥ç”Ÿæˆç¼“å†²åŒº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ByteBuf</span> <span class="n">back</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">alloc</span><span class="o">().</span><span class="na">buffer</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">back</span><span class="o">.</span><span class="na">writeCharSequence</span><span class="o">(</span><span class="s">&#34;å·²æ”¶åˆ°ï¼&#34;</span><span class="o">,</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">back</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;channelRead&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelReadComplete</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;channelReadComplete&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">userEventTriggered</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">evt</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;userEventTriggered&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelWritabilityChanged</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;channelWritabilityChanged&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;exceptionCaught&#34;</span><span class="o">+</span><span class="n">cause</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">EventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">(),</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">ServerBootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerBootstrap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">bootstrap</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      			<span class="c1">//ChannelInitializeræ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ChannelHandlerï¼Œå®ƒæœ¬èº«ä¸å¤„ç†ä»»ä½•å‡ºç«™/å…¥ç«™äº‹ä»¶ï¼Œå®ƒçš„ç›®çš„ä»…ä»…æ˜¯å®ŒæˆChannelçš„åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">//å°†æˆ‘ä»¬è‡ªå®šä¹‰çš„ChannelHandleræ·»åŠ åˆ°æµæ°´çº¿
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">TestChannelHandler</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="n">bootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">8080</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>ç°åœ¨æˆ‘ä»¬å¯åŠ¨æœåŠ¡å™¨ï¼Œè®©å®¢æˆ·ç«¯æ¥è¿æ¥å¹¶å‘é€ä¸€ä¸‹æ•°æ®è¯•è¯•çœ‹ï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/Tk7PyBU5cRil89L.png" alt="image-20230306174158886" />
    
  </figure>

</p>
<p>å¯ä»¥çœ‹åˆ°ChannelInboundHandlerçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œé¦–å…ˆæ˜¯Channelæ³¨å†ŒæˆåŠŸï¼Œç„¶åæ‰ä¼šå˜æˆå¯ç”¨çŠ¶æ€ï¼Œæ¥ç€å°±å·®ä¸å¤šå¯ä»¥ç­‰å¾…å®¢æˆ·ç«¯æ¥æ•°æ®äº†ï¼Œå½“å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€è¿æ¥æ—¶ï¼Œä¼šå†æ¬¡è§¦å‘ä¸€æ¬¡<code>channelReadComplete</code>ï¼Œç„¶åä¸å¯ç”¨ï¼Œæœ€åå–æ¶ˆæ³¨å†Œã€‚</p>
<p>æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹å‡ºç°å¼‚å¸¸çš„æƒ…å†µå‘¢ï¼Ÿ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">&#34; &gt;&gt; æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š&#34;</span><span class="o">+</span><span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">ByteBuf</span> <span class="n">back</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">alloc</span><span class="o">().</span><span class="na">buffer</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">back</span><span class="o">.</span><span class="na">writeCharSequence</span><span class="o">(</span><span class="s">&#34;å·²æ”¶åˆ°ï¼&#34;</span><span class="o">,</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">back</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;channelRead&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;æˆ‘æ˜¯è‡ªå®šä¹‰å¼‚å¸¸1&#34;</span><span class="o">);</span>  <span class="c1">//å¼„ç‚¹å¼‚å¸¸ä¸Šå»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelReadComplete</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;channelReadComplete&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;æˆ‘æ˜¯è‡ªå®šä¹‰å¼‚å¸¸2&#34;</span><span class="o">);</span>   <span class="c1">//å¼„ç‚¹å¼‚å¸¸ä¸Šå»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;exceptionCaught&#34;</span><span class="o">+</span><span class="n">cause</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œä¼šæ¥ç€è°ƒç”¨<code>exceptionCaught</code>æ–¹æ³•ï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/lSAjPCskUT9miNd.png" alt="image-20230306174211952" />
    
  </figure>

</p>
<p>ä¸ChannelInboundHandlerå¯¹åº”çš„è¿˜æœ‰ChannelOutboundHandlerç”¨äºå¤„ç†å‡ºç«™ç›¸å…³çš„æ“ä½œï¼Œè¿™é‡Œå°±ä¸è¿›è¡Œæ¼”ç¤ºäº†ã€‚</p>
<p>æˆ‘ä»¬æ¥ç€æ¥çœ‹çœ‹ChannelPipelineï¼Œæ¯ä¸€ä¸ªChanneléƒ½å¯¹åº”ä¸€ä¸ªChannelPipelineï¼ˆåœ¨Channelåˆå§‹åŒ–æ—¶å°±è¢«åˆ›å»ºäº†ï¼‰</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/lSAjPCskUT9miNd.png" alt="image-20230306174211952" />
    
  </figure>

</p>
<p>å®ƒå°±åƒæ˜¯ä¸€æ¡æµæ°´çº¿ä¸€æ ·ï¼Œæ•´æ¡æµæ°´çº¿ä¸Šå¯èƒ½ä¼šæœ‰å¾ˆå¤šä¸ªHandlerï¼ˆåŒ…æ‹¬å…¥ç«™å’Œå‡ºç«™ï¼‰ï¼Œæ•´æ¡æµæ°´çº¿ä¸Šçš„ä¸¤ç«¯è¿˜æœ‰ä¸¤ä¸ªé»˜è®¤çš„å¤„ç†å™¨ï¼ˆç”¨äºä¸€äº›é¢„ç½®æ“ä½œå’Œåç»­æ“ä½œï¼Œæ¯”å¦‚é‡Šæ”¾èµ„æºç­‰ï¼‰ï¼Œæˆ‘ä»¬åªéœ€è¦å…³å¿ƒå¦‚ä½•å®‰æ’è¿™äº›è‡ªå®šä¹‰çš„Handlerå³å¯ï¼Œæ¯”å¦‚æˆ‘ä»¬ç°åœ¨å¸Œæœ›åˆ›å»ºä¸¤ä¸ªå…¥ç«™ChannelHandlerï¼Œä¸€ä¸ªç”¨äºæ¥æ”¶è¯·æ±‚å¹¶å¤„ç†ï¼Œè¿˜æœ‰ä¸€ä¸ªç”¨äºå¤„ç†å½“å‰æ¥æ”¶è¯·æ±‚è¿‡ç¨‹ä¸­å‡ºç°çš„å¼‚å¸¸ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>   <span class="c1">//æ³¨æ„ï¼Œè¿™é‡Œçš„SocketChannelä¸æ˜¯æˆ‘ä»¬NIOé‡Œé¢çš„ï¼Œæ˜¯Nettyçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">()</span>   <span class="c1">//ç›´æ¥è·å–pipelineï¼Œç„¶åæ·»åŠ ä¸¤ä¸ªHandlerï¼Œæ³¨æ„é¡ºåº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInboundHandlerAdapter</span><span class="o">(){</span>   <span class="c1">//ç¬¬ä¸€ä¸ªç”¨äºå¤„ç†æ¶ˆæ¯æ¥æ”¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š&#34;</span><span class="o">+</span><span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="n">ds</span>                        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">&#34;æˆ‘æ˜¯å¼‚å¸¸&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">})</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInboundHandlerAdapter</span><span class="o">(){</span>   <span class="c1">//ç¬¬äºŒä¸ªç”¨äºå¤„ç†å¼‚å¸¸
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æˆ‘æ˜¯å¼‚å¸¸å¤„ç†ï¼š&#34;</span><span class="o">+</span><span class="n">cause</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">});</span>
</span></span></code></pre></div><p>é‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•è¿ä½œçš„å‘¢ï¼Ÿå®é™…ä¸Šå¦‚æœæˆ‘ä»¬ä¸åœ¨ChannelInboundHandlerAdapterä¸­é‡å†™å¯¹åº”çš„æ–¹æ³•ï¼Œå®ƒä¼šé»˜è®¤ä¼ æ’­åˆ°æµæ°´çº¿çš„ä¸‹ä¸€ä¸ªChannelInboundHandlerAdapterè¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctx</span><span class="o">.</span><span class="na">fireExceptionCaught</span><span class="o">(</span><span class="n">cause</span><span class="o">);</span>   <span class="c1">//é€šè¿‡ChannelHandlerContextæ¥å‘ä¸‹ä¼ é€’ï¼ŒChannelHandlerContextæ˜¯åœ¨Handleræ·»åŠ è¿›Pipelineä¸­æ—¶å°±è¢«è‡ªåŠ¨åˆ›å»ºçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></div><p>æ¯”å¦‚æˆ‘ä»¬ç°åœ¨éœ€è¦å°†ä¸€ä¸ªæ¶ˆæ¯åœ¨ä¸¤ä¸ªHandlerä¸­è¿›è¡Œå¤„ç†ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">()</span>   <span class="c1">//ç›´æ¥è·å–pipelineï¼Œç„¶åæ·»åŠ ä¸¤ä¸ªHandler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;1æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š&#34;</span><span class="o">+</span><span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ctx</span><span class="o">.</span><span class="na">fireChannelRead</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>   <span class="c1">//é€šè¿‡ChannelHandlerContext
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">})</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;2æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š&#34;</span><span class="o">+</span><span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬æ¥ç€æ¥çœ‹çœ‹å‡ºç«™ç›¸å…³æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ChannelOutboundHandlerAdapteræ¥å®Œæˆï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelOutboundHandlerAdapter</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">              <span class="c1">//æ³¨æ„å‡ºæ ˆç«™æ“ä½œåº”è¯¥åœ¨å…¥ç«™æ“ä½œçš„å‰é¢ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ChannelHandlerContextçš„writeæ–¹æ³•æ—¶ï¼Œæ˜¯ä»æµæ°´çº¿çš„å½“å‰ä½ç½®å€’ç€å¾€å‰æ‰¾ä¸‹ä¸€ä¸ªChannelOutboundHandlerAdapterï¼Œè€Œæˆ‘ä»¬ä¹‹å‰ä½¿ç”¨çš„ChannelInboundHandlerAdapteræ˜¯ä»å‰å¾€åæ‰¾ä¸‹ä¸€ä¸ªï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯Channelçš„writeæ–¹æ³•ï¼Œé‚£ä¹ˆä¼šä»æ•´ä¸ªæµæ°´çº¿çš„æœ€åå¼€å§‹å€’ç€å¾€å‰æ‰¾ChannelOutboundHandlerAdapterï¼Œä¸€å®šè¦æ³¨æ„é¡ºåºã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>  <span class="c1">//å½“æ‰§è¡Œwriteæ“ä½œæ—¶ï¼Œä¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>   <span class="c1">//writeçš„æ˜¯å•¥ï¼Œè¿™é‡Œå°±æ˜¯æ˜¯å•¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                  	<span class="c1">//æˆ‘ä»¬å°†å…¶è½¬æ¢ä¸ºByteBufï¼Œè¿™æ ·æ‰èƒ½å‘é€å›å®¢æˆ·ç«¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">Unpooled</span><span class="o">.</span><span class="na">wrappedBuffer</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">getBytes</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">})</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;1æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š&#34;</span><span class="o">+</span><span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ctx</span><span class="o">.</span><span class="na">fireChannelRead</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">})</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;2æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š&#34;</span><span class="o">+</span><span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="s">&#34;ä¸ä¼šå§ä¸ä¼šå§ï¼Œä¸ä¼šè¿˜æœ‰äººéƒ½çœ‹åˆ°è¿™é‡Œäº†è¿˜æ²¡ä¸‰è¿å§&#34;</span><span class="o">);</span>   <span class="c1">//è¿™é‡Œå¯ä»¥writeä»»ä½•å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                  	<span class="c1">//ctx.channel().writeAndFlush(&#34;å•Šå¯¹å¯¹å¯¹&#34;); æˆ–æ˜¯é€šè¿‡Channelè¿›è¡Œwriteä¹Ÿå¯ä»¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>ç°åœ¨æˆ‘ä»¬æ¥è¯•è¯•çœ‹ï¼Œæä¸¤ä¸ªå‡ºç«™çš„Handlerï¼ŒéªŒè¯ä¸€ä¸‹æ˜¯ä¸æ˜¯ä¸Šé¢çš„æ ·å­ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">()</span>   <span class="c1">//ç›´æ¥è·å–pipelineï¼Œç„¶åæ·»åŠ ä¸¤ä¸ªHandler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;1æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š&#34;</span><span class="o">+</span><span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ctx</span><span class="o">.</span><span class="na">fireChannelRead</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">})</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;2æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š&#34;</span><span class="o">+</span><span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="s">&#34;ä¼å…µä¸€å·å¢æœ¬ä¼Ÿ&#34;</span><span class="o">);</span>  <span class="c1">//è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨channelçš„write
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">})</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelOutboundHandlerAdapter</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;1å·å‡ºç«™ï¼š&#34;</span><span class="o">+</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">})</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelOutboundHandlerAdapter</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;2å·å‡ºç«™ï¼š&#34;</span><span class="o">+</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ctx</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>  <span class="c1">//ç»§ç»­writeç»™å…¶ä»–çš„å‡ºç«™Handlerï¼Œä¸ç„¶åˆ°è¿™é‡Œå°±æ–­äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>æ‰€ä»¥ï¼Œå‡ºç«™æ“ä½œåœ¨æµæ°´çº¿ä¸Šæ˜¯åç€æ¥çš„ï¼Œæ•´ä¸ªæµæ°´çº¿æ“ä½œå¤§æ¦‚æµç¨‹å¦‚ä¸‹:</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/YZ1nIW5VTtEBFvs.png" alt="image-20230306174237906" />
    
  </figure>

</p>
<p>æœ‰å…³ChannelåŠå…¶å¤„ç†ç›¸å…³æ“ä½œï¼Œå°±å…ˆè®²åˆ°è¿™é‡Œã€‚</p>


<h3 class="relative group">EventLoopå’Œä»»åŠ¡è°ƒåº¦ 
    <div id="eventloop%E5%92%8C%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#eventloop%E5%92%8C%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6" aria-label="é”šç‚¹">#</a>
    </span>        
    
</h3>
<p>å‰é¢æˆ‘ä»¬è®²è§£äº†Channelï¼Œé‚£ä¹ˆåœ¨EventLoopä¸­å…·ä½“æ˜¯å¦‚ä½•è¿›è¡Œè°ƒåº¦çš„å‘¢ï¼Ÿå®é™…ä¸Šæˆ‘ä»¬ä¹‹å‰åœ¨ç¼–å†™NIOçš„æ—¶å€™ï¼Œå°±æ˜¯ä¸€ä¸ªwhileå¾ªç¯åœ¨æºæºä¸æ–­åœ°ç­‰å¾…æ–°çš„äº‹ä»¶ï¼Œè€ŒEventLoopä¹Ÿæ­£æ˜¯è¿™ç§æ€æƒ³ï¼Œå®ƒæœ¬è´¨å°±æ˜¯ä¸€ä¸ªäº‹ä»¶ç­‰å¾…/å¤„ç†çº¿ç¨‹ã€‚</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/6Z1evQGNayObnD5.png" alt="image-20230306174245836" />
    
  </figure>

</p>
<p>æˆ‘ä»¬ä¸Šé¢ä½¿ç”¨çš„å°±æ˜¯EventLoopGroupï¼ŒåŒ…å«å¾ˆå¤šä¸ªEventLoopï¼Œæˆ‘ä»¬æ¯åˆ›å»ºä¸€ä¸ªè¿æ¥ï¼Œå°±éœ€è¦ç»‘å®šåˆ°ä¸€ä¸ªEventLoopä¸Šï¼Œä¹‹åEventLoopå°±ä¼šå¼€å§‹ç›‘å¬è¿™ä¸ªè¿æ¥ï¼ˆåªè¦è¿æ¥ä¸å…³é—­ï¼Œä¸€ç›´éƒ½æ˜¯è¿™ä¸ªEventLoopè´Ÿè´£æ­¤Channelï¼‰ï¼Œè€Œä¸€ä¸ªEventLoopå¯ä»¥åŒæ—¶ç›‘å¬å¾ˆå¤šä¸ªChannelï¼Œå®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬ä¹‹å‰å­¦ä¹ çš„Selectorç½¢äº†ã€‚</p>
<p>å½“ç„¶ï¼ŒEventLoopå¹¶ä¸åªæ˜¯ç”¨äºç½‘ç»œæ“ä½œçš„ï¼Œæˆ‘ä»¬å‰é¢æ‰€è¯´çš„EventLoopå…¶å®éƒ½æ˜¯NioEventLoopï¼Œå®ƒæ˜¯ä¸“ç”¨äºç½‘ç»œé€šä¿¡çš„ï¼Œé™¤äº†ç½‘ç»œé€šä¿¡ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨æ™®é€šçš„EventLoopæ¥å¤„ç†ä¸€äº›å…¶ä»–çš„äº‹ä»¶ã€‚</p>
<p>æ¯”å¦‚æˆ‘ä»¬ç°åœ¨ç¼–å†™çš„æœåŠ¡ç«¯ï¼Œè™½ç„¶ç»“æ„ä¸Šå’Œä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å‹å·®ä¸å¤šï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°ï¼ŒHandlerä¼¼ä¹æ˜¯å’Œè¯»å†™æ“ä½œåœ¨ä¸€èµ·è¿›è¡Œçš„ï¼Œè€Œæˆ‘ä»¬ä¹‹å‰æ‰€è¯´çš„æ¨¡å‹ä¸­ï¼ŒHandleræ˜¯åœ¨è¯»å†™ä¹‹å¤–çš„å•ç‹¬çº¿ç¨‹ä¸­è¿›è¡Œçš„ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">EventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">(),</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>  <span class="c1">//çº¿ç¨‹æ•°å…ˆé™åˆ¶ä¸€ä¸‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ServerBootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerBootstrap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">bootstrap</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>   <span class="c1">//æŒ‡å®šäº‹ä»¶å¾ªç¯ç»„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>   <span class="c1">//æŒ‡å®šä¸ºNIOçš„ServerSocketChannel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>   <span class="c1">//æ³¨æ„ï¼Œè¿™é‡Œçš„SocketChannelä¸æ˜¯æˆ‘ä»¬NIOé‡Œé¢çš„ï¼Œæ˜¯Nettyçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                            <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">                                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š&#34;</span><span class="o">+</span><span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>   <span class="c1">//è¿™é‡Œæˆ‘ä»¬ç›´æ¥å¡10ç§’å‡è£…åœ¨å¤„ç†ä»»åŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                    <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">Unpooled</span><span class="o">.</span><span class="na">wrappedBuffer</span><span class="o">(</span><span class="s">&#34;å·²æ”¶åˆ°ï¼&#34;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">                                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                            <span class="o">});</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="n">bootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">8080</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœåœ¨è¿™é‡Œå¡ä½äº†ï¼Œé‚£ä¹ˆå°±æ²¡åŠæ³•å¤„ç†EventLoopç»‘å®šçš„å…¶ä»–Channeläº†ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå°±åˆ›å»ºä¸€ä¸ªæ™®é€šçš„EventLoopæ¥ä¸“é—¨å¤„ç†è¯»å†™ä¹‹å¤–çš„ä»»åŠ¡ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">EventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">(),</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>  <span class="c1">//çº¿ç¨‹æ•°å…ˆé™åˆ¶ä¸€ä¸‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">EventLoopGroup</span> <span class="n">handlerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultEventLoopGroup</span><span class="o">();</span>  <span class="c1">//ä½¿ç”¨DefaultEventLoopæ¥å¤„ç†å…¶ä»–ä»»åŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ServerBootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerBootstrap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">bootstrap</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                            <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">                                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                                  	<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š&#34;</span><span class="o">+</span><span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">handlerGroup</span><span class="o">.</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                                <span class="c1">//ç”±äºç»§æ‰¿è‡ªScheduledExecutorServiceï¼Œæˆ‘ä»¬ç›´æ¥æäº¤ä»»åŠ¡å°±è¡Œäº†ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰è´¼æ–¹ä¾¿
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                                            <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                                        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                                            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                                        <span class="o">}</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">Unpooled</span><span class="o">.</span><span class="na">wrappedBuffer</span><span class="o">(</span><span class="s">&#34;å·²æ”¶åˆ°ï¼&#34;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">                                    <span class="o">});</span>
</span></span><span class="line"><span class="cl">                                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                            <span class="o">});</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="n">bootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">8080</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥å†™æˆä¸€æ¡æµæ°´çº¿ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">EventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">(),</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>  <span class="c1">//çº¿ç¨‹æ•°å…ˆé™åˆ¶ä¸€ä¸‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">EventLoopGroup</span> <span class="n">handlerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultEventLoopGroup</span><span class="o">();</span>  <span class="c1">//ä½¿ç”¨DefaultEventLoopæ¥å¤„ç†å…¶ä»–ä»»åŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ServerBootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerBootstrap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">bootstrap</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                            <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">                                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š&#34;</span><span class="o">+</span><span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">ctx</span><span class="o">.</span><span class="na">fireChannelRead</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                            <span class="o">}).</span><span class="na">addLast</span><span class="o">(</span><span class="n">handlerGroup</span><span class="o">,</span> <span class="k">new</span> <span class="n">ChannelInboundHandlerAdapter</span><span class="o">(){</span>  <span class="c1">//åœ¨æ·»åŠ æ—¶ï¼Œå¯ä»¥ç›´æ¥æŒ‡å®šä½¿ç”¨å“ªä¸ªEventLoopGroup
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                                    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                                        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">Unpooled</span><span class="o">.</span><span class="na">wrappedBuffer</span><span class="o">(</span><span class="s">&#34;å·²æ”¶åˆ°ï¼&#34;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">                                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                            <span class="o">});</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="n">bootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">8080</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±è¿›ä¸€æ­¥åœ°å°†EventLoopåˆ©ç”¨èµ·æ¥äº†ã€‚</p>
<p>æŒ‰ç…§å‰é¢æœåŠ¡ç«¯çš„æ–¹å¼ï¼Œæˆ‘ä»¬æ¥æŠŠNettyç‰ˆæœ¬çš„å®¢æˆ·ç«¯ä¹Ÿç»™å†™äº†ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Bootstrap</span><span class="o">();</span>   <span class="c1">//å®¢æˆ·ç«¯ä¹Ÿæ˜¯ä½¿ç”¨Bootstrapæ¥å¯åŠ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">bootstrap</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">())</span>   <span class="c1">//å®¢æˆ·ç«¯å°±æ²¡é‚£ä¹ˆéº»çƒ¦äº†ï¼Œç›´æ¥ä¸€ä¸ªEventLoopå°±è¡Œï¼Œç”¨äºå¤„ç†å‘å›æ¥çš„æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>   <span class="c1">//å®¢æˆ·ç«¯è‚¯å®šå°±æ˜¯ä½¿ç”¨SocketChanneläº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>   <span class="c1">//è¿™é‡Œçš„æ•°æ®å¤„ç†æ–¹å¼å’ŒæœåŠ¡ç«¯æ˜¯ä¸€æ ·çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">channel</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">                        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;&gt;&gt; æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š&#34;</span><span class="o">+</span><span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span>
</span></span><span class="line"><span class="cl">                    <span class="o">});</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="n">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">&#34;localhost&#34;</span><span class="o">,</span> <span class="mi">8080</span><span class="o">).</span><span class="na">channel</span><span class="o">();</span>  <span class="c1">//è¿æ¥åæ‹¿åˆ°å¯¹åº”çš„Channelå¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  	<span class="c1">//æ³¨æ„ä¸Šé¢è¿æ¥æ“ä½œæ˜¯å¼‚æ­¥çš„ï¼Œè°ƒç”¨ä¹‹åä¼šç»§ç»­å¾€ä¸‹èµ°ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ­£å¼ç¼–å†™å®¢æˆ·ç«¯çš„æ•°æ®å‘é€ä»£ç äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">try</span><span class="o">(</span><span class="n">Scanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">in</span><span class="o">)){</span>    <span class="c1">//è¿˜æ˜¯å’Œä¹‹å‰ä¸€æ ·ï¼Œæ‰«äº†å°±å‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;&lt;&lt; è¯·è¾“å…¥è¦å‘é€ç»™æœåŠ¡ç«¯çš„å†…å®¹ï¼š&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">text</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">text</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">channel</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">Unpooled</span><span class="o">.</span><span class="na">wrappedBuffer</span><span class="o">(</span><span class="n">text</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>  <span class="c1">//é€šè¿‡Channelå¯¹è±¡å‘é€æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹å§ï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/cnbxqteVo62da8p.png" alt="image-20230306174303352" />
    
  </figure>

</p>


<h3 class="relative group">Futureå’ŒPromise 
    <div id="future%E5%92%8Cpromise" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#future%E5%92%8Cpromise" aria-label="é”šç‚¹">#</a>
    </span>        
    
</h3>
<p>æˆ‘ä»¬æ¥ç€æ¥çœ‹ChannelFutureï¼Œå‰é¢æˆ‘ä»¬æåˆ°ï¼ŒNettyä¸­Channelçš„ç›¸å…³æ“ä½œéƒ½æ˜¯å¼‚æ­¥è¿›è¡Œçš„ï¼Œå¹¶ä¸æ˜¯åœ¨å½“å‰çº¿ç¨‹åŒæ­¥æ‰§è¡Œï¼Œæˆ‘ä»¬ä¸èƒ½ç«‹å³å¾—åˆ°æ‰§è¡Œç»“æœï¼Œå¦‚æœéœ€è¦å¾—åˆ°ç»“æœï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¿…é¡»è¦åˆ©ç”¨åˆ°Futureã€‚</p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ChannelFutueræ¥å£æ€ä¹ˆå®šä¹‰çš„ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ChannelFuture</span> <span class="kd">extends</span> <span class="n">Future</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Channel</span> <span class="nf">channel</span><span class="o">();</span>    <span class="c1">//æˆ‘ä»¬å¯ä»¥ç›´æ¥è·å–æ­¤ä»»åŠ¡çš„Channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ChannelFuture</span> <span class="nf">addListener</span><span class="o">(</span><span class="n">GenericFutureListener</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Future</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">Void</span><span class="o">&gt;&gt;</span> <span class="n">var1</span><span class="o">);</span>  <span class="c1">//å½“ä»»åŠ¡å®Œæˆæ—¶ï¼Œä¼šç›´æ¥æ‰§è¡ŒGenericFutureListenerçš„ä»»åŠ¡ï¼Œæ³¨æ„æ‰§è¡Œçš„ä½ç½®ä¹Ÿæ˜¯åœ¨EventLoopä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ChannelFuture</span> <span class="nf">addListeners</span><span class="o">(</span><span class="n">GenericFutureListener</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Future</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">Void</span><span class="o">&gt;&gt;...</span> <span class="n">var1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">removeListener</span><span class="o">(</span><span class="n">GenericFutureListener</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Future</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">Void</span><span class="o">&gt;&gt;</span> <span class="n">var1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">removeListeners</span><span class="o">(</span><span class="n">GenericFutureListener</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Future</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">Void</span><span class="o">&gt;&gt;...</span> <span class="n">var1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="nf">sync</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">;</span>   <span class="c1">//åœ¨å½“å‰çº¿ç¨‹åŒæ­¥ç­‰å¾…å¼‚æ­¥ä»»åŠ¡å®Œæˆï¼Œä»»åŠ¡å¤±è´¥ä¼šæŠ›å‡ºå¼‚å¸¸
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ChannelFuture</span> <span class="nf">syncUninterruptibly</span><span class="o">();</span>   <span class="c1">//åŒä¸Šï¼Œä½†æ˜¯æ— æ³•å“åº”ä¸­æ–­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ChannelFuture</span> <span class="nf">await</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">;</span>  <span class="c1">//åŒä¸Šï¼Œä½†æ˜¯ä»»åŠ¡ä¸­æ–­ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œéœ€è¦æ‰‹åŠ¨åˆ¤æ–­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ChannelFuture</span> <span class="nf">awaitUninterruptibly</span><span class="o">();</span>    <span class="c1">//ä¸ç”¨æˆ‘è¯´äº†å§ï¼Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">boolean</span> <span class="nf">isVoid</span><span class="o">();</span>   <span class="c1">//è¿”å›ç±»å‹æ˜¯å¦ä¸ºvoid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></div><p>æ­¤æ¥å£æ˜¯ç»§æ‰¿è‡ªNettyä¸­çš„Futureæ¥å£çš„ï¼ˆä¸æ˜¯JDKçš„é‚£ä¸ªï¼‰ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Future</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">Future</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="o">{</span>   <span class="c1">//å†å¾€ä¸Šæ‰æ˜¯JDKçš„Future
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">boolean</span> <span class="nf">isSuccess</span><span class="o">();</span>    <span class="c1">//ç”¨äºåˆ¤æ–­ä»»åŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">boolean</span> <span class="nf">isCancellable</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Throwable</span> <span class="nf">cause</span><span class="o">();</span>    <span class="c1">//è·å–å¯¼è‡´ä»»åŠ¡å¤±è´¥çš„å¼‚å¸¸
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  	<span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">V</span> <span class="nf">getNow</span><span class="o">();</span>  <span class="c1">//ç«‹å³è·å–ç»“æœï¼Œå¦‚æœè¿˜æœªäº§ç”Ÿç»“æœï¼Œå¾—åˆ°nullï¼Œä¸è¿‡ChannelFutureå®šä¹‰Vä¸ºVoidï¼Œå°±ç®—å®Œæˆäº†è·å–ä¹Ÿæ˜¯null
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">boolean</span> <span class="nf">cancel</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">var1</span><span class="o">);</span>    <span class="c1">//å–æ¶ˆä»»åŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></div><p>Channelçš„å¾ˆå¤šæ“ä½œéƒ½æ˜¯å¼‚æ­¥å®Œæˆçš„ï¼Œç›´æ¥è¿”å›ä¸€ä¸ªChannelFutureï¼Œæ¯”å¦‚Channelçš„writeæ“ä½œï¼Œè¿”å›çš„å°±æ˜¯ä¸€ä¸ªChannelFutureå¯¹è±¡ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š&#34;</span><span class="o">+</span><span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">ChannelFuture</span> <span class="n">future</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">Unpooled</span><span class="o">.</span><span class="na">wrappedBuffer</span><span class="o">(</span><span class="s">&#34;å·²æ”¶åˆ°ï¼&#34;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;ä»»åŠ¡å®ŒæˆçŠ¶æ€ï¼š&#34;</span><span class="o">+</span><span class="n">future</span><span class="o">.</span><span class="na">isDone</span><span class="o">());</span>   <span class="c1">//é€šè¿‡ChannelFutureæ¥è·å–ç›¸å…³ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">});</span>
</span></span></code></pre></div><p>åŒ…æ‹¬æˆ‘ä»¬çš„æœåŠ¡ç«¯å¯åŠ¨ä¹Ÿæ˜¯è¿”å›çš„ChannelFutureï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl">								<span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="n">future</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">8080</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æœåŠ¡ç«¯å¯åŠ¨çŠ¶æ€ï¼š&#34;</span><span class="o">+</span><span class="n">future</span><span class="o">.</span><span class="na">isDone</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æˆ‘æ˜¯æœåŠ¡ç«¯å¯åŠ¨å®Œæˆä¹‹åè¦åšçš„äº‹æƒ…ï¼&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼ŒæœåŠ¡ç«¯çš„å¯åŠ¨å°±æ¯”è¾ƒæ…¢äº†ï¼Œæ‰€ä»¥åœ¨ä¸€å¼€å§‹ç›´æ¥è·å–çŠ¶æ€ä¼šè¿”å›<code>false</code>ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åˆéœ€è¦ç­‰åˆ°æœåŠ¡ç«¯å¯åŠ¨å®Œæˆä¹‹ååšä¸€äº›äº‹æƒ…ï¼Œè¿™ä¸ªæ—¶å€™è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿç°åœ¨æˆ‘ä»¬å°±æœ‰ä¸¤ç§æ–¹æ¡ˆäº†ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="n">future</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">8080</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">future</span><span class="o">.</span><span class="na">sync</span><span class="o">();</span>   <span class="c1">//è®©å½“å‰çº¿ç¨‹åŒæ­¥ç­‰å¾…ä»»åŠ¡å®Œæˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æœåŠ¡ç«¯å¯åŠ¨çŠ¶æ€ï¼š&#34;</span><span class="o">+</span><span class="n">future</span><span class="o">.</span><span class="na">isDone</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æˆ‘æ˜¯æœåŠ¡ç«¯å¯åŠ¨å®Œæˆä¹‹åè¦åšçš„äº‹æƒ…ï¼&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>ç¬¬ä¸€ç§æ–¹æ¡ˆæ˜¯ç›´æ¥è®©å½“å‰çº¿ç¨‹åŒæ­¥ç­‰å¾…å¼‚æ­¥ä»»åŠ¡å®Œæˆï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>sync()</code>æ–¹æ³•ï¼Œè¿™æ ·å½“å‰çº¿ç¨‹ä¼šä¸€ç›´é˜»å¡ç›´åˆ°ä»»åŠ¡ç»“æŸã€‚ç¬¬äºŒç§æ–¹æ¡ˆæ˜¯æ·»åŠ ä¸€ä¸ªç›‘å¬å™¨ï¼Œç­‰å¾…ä»»åŠ¡å®Œæˆæ—¶é€šçŸ¥ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="n">future</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">8080</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//ç›´æ¥æ·»åŠ ç›‘å¬å™¨ï¼Œå½“ä»»åŠ¡å®Œæˆæ—¶è‡ªåŠ¨æ‰§è¡Œï¼Œä½†æ˜¯æ³¨æ„æ‰§è¡Œä¹Ÿæ˜¯å¼‚æ­¥çš„ï¼Œä¸æ˜¯åœ¨å½“å‰çº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">future</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æˆ‘æ˜¯æœåŠ¡ç«¯å¯åŠ¨å®Œæˆä¹‹åè¦åšçš„äº‹æƒ…ï¼&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>åŒ…æ‹¬å®¢æˆ·ç«¯çš„å…³é—­ï¼Œä¹Ÿæ˜¯å¼‚æ­¥è¿›è¡Œçš„ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">try</span><span class="o">(</span><span class="n">Scanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">in</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;&lt;&lt; è¯·è¾“å…¥è¦å‘é€ç»™æœåŠ¡ç«¯çš„å†…å®¹ï¼š&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">text</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">text</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">text</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;exit&#34;</span><span class="o">))</span> <span class="o">{</span>   <span class="c1">//è¾“å…¥exitå°±é€€å‡º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">ChannelFuture</span> <span class="n">future</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">future</span><span class="o">.</span><span class="na">sync</span><span class="o">();</span>    <span class="c1">//ç­‰å¾…Channelå®Œå…¨å…³é—­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">channel</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">Unpooled</span><span class="o">.</span><span class="na">wrappedBuffer</span><span class="o">(</span><span class="n">text</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">group</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>   <span class="c1">//ä¼˜é›…é€€å‡ºEventLoopï¼Œå…¶å®å°±æ˜¯æŠŠè¿˜æ²¡å‘é€çš„æ•°æ®ä¹‹ç±»çš„äº‹æƒ…åšå®Œï¼Œå½“ç„¶ä¹Ÿå¯ä»¥shutdownNowç«‹å³å…³é—­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬æ¥ç€æ¥çœ‹çœ‹Promiseæ¥å£ï¼Œå®ƒæ”¯æŒæ‰‹åŠ¨è®¾å®šæˆåŠŸå’Œå¤±è´¥çš„ç»“æœï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//æ­¤æ¥å£ä¹Ÿæ˜¯ç»§æ‰¿è‡ªNettyä¸­çš„Futureæ¥å£
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Promise</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">Future</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Promise</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">setSuccess</span><span class="o">(</span><span class="n">V</span> <span class="n">var1</span><span class="o">);</span>    <span class="c1">//æ‰‹åŠ¨è®¾å®šæˆåŠŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">boolean</span> <span class="nf">trySuccess</span><span class="o">(</span><span class="n">V</span> <span class="n">var1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Promise</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">setFailure</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">var1</span><span class="o">);</span>  <span class="c1">//æ‰‹åŠ¨è®¾å®šå¤±è´¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">boolean</span> <span class="nf">tryFailure</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">var1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="nf">setUncancellable</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//è¿™äº›å°±å’Œä¹‹å‰çš„Futureæ˜¯ä¸€æ ·çš„äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Promise</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">addListener</span><span class="o">(</span><span class="n">GenericFutureListener</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Future</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">V</span><span class="o">&gt;&gt;</span> <span class="n">var1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Promise</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">addListeners</span><span class="o">(</span><span class="n">GenericFutureListener</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Future</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">V</span><span class="o">&gt;&gt;...</span> <span class="n">var1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Promise</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">removeListener</span><span class="o">(</span><span class="n">GenericFutureListener</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Future</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">V</span><span class="o">&gt;&gt;</span> <span class="n">var1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Promise</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">removeListeners</span><span class="o">(</span><span class="n">GenericFutureListener</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Future</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">V</span><span class="o">&gt;&gt;...</span> <span class="n">var1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Promise</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">await</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Promise</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">awaitUninterruptibly</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Promise</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">sync</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Promise</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">syncUninterruptibly</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>æ¯”å¦‚æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ExecutionException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Promise</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultPromise</span><span class="o">&lt;&gt;(</span><span class="k">new</span> <span class="n">DefaultEventLoop</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">promise</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">());</span>    <span class="c1">//åœ¨ä¸€å¼€å§‹è‚¯å®šä¸æ˜¯æˆåŠŸçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">promise</span><span class="o">.</span><span class="na">setSuccess</span><span class="o">(</span><span class="s">&#34;lbwnb&#34;</span><span class="o">);</span>    <span class="c1">//è®¾å®šæˆåŠŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">promise</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">());</span>   <span class="c1">//å†æ¬¡è·å–ï¼Œå¯ä»¥å‘ç°ç¡®å®æˆåŠŸäº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">promise</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>    <span class="c1">//è·å–ç»“æœï¼Œå°±æ˜¯æˆ‘ä»¬åˆšåˆšç»™è¿›å»çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨æŒ‡å®šæˆåŠŸçŠ¶æ€ï¼ŒåŒ…æ‹¬ChannelOutboundInvokerä¸­çš„ä¸€äº›åŸºæœ¬æ“ä½œï¼Œéƒ½æ˜¯æ”¯æŒChannelPromiseçš„ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">text</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š&#34;</span><span class="o">+</span><span class="n">text</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ChannelPromise</span> <span class="n">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultChannelPromise</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">promise</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">Unpooled</span><span class="o">.</span><span class="na">wrappedBuffer</span><span class="o">(</span><span class="s">&#34;å·²æ”¶åˆ°ï¼&#34;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()),</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">promise</span><span class="o">.</span><span class="na">sync</span><span class="o">();</span>  <span class="c1">//åŒæ­¥ç­‰å¾…ä¸€ä¸‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">promise</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">});</span>
</span></span></code></pre></div><p>æœ€åç»“æœå°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„äº†ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥åƒFutureé‚£æ ·æ·»åŠ ç›‘å¬å™¨ï¼Œå½“æˆåŠŸæ—¶è‡ªåŠ¨é€šçŸ¥ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ExecutionException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Promise</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultPromise</span><span class="o">&lt;&gt;(</span><span class="k">new</span> <span class="n">DefaultEventLoop</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">promise</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">promise</span><span class="o">.</span><span class="na">get</span><span class="o">()));</span>   <span class="c1">//æ³¨æ„æ˜¯åœ¨ä¸Šé¢çš„DefaultEventLoopæ‰§è¡Œçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">promise</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">promise</span><span class="o">.</span><span class="na">setSuccess</span><span class="o">(</span><span class="s">&#34;lbwnb&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">promise</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>æœ‰å…³Futureå’ŒPromiseå°±æš‚æ—¶è®²è§£åˆ°è¿™é‡Œã€‚</p>


<h3 class="relative group">ç¼–ç å™¨å’Œè§£ç å™¨ 
    <div id="%E7%BC%96%E7%A0%81%E5%99%A8%E5%92%8C%E8%A7%A3%E7%A0%81%E5%99%A8" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E7%BC%96%E7%A0%81%E5%99%A8%E5%92%8C%E8%A7%A3%E7%A0%81%E5%99%A8" aria-label="é”šç‚¹">#</a>
    </span>        
    
</h3>
<p>å‰é¢æˆ‘ä»¬å·²ç»äº†è§£äº†Nettyçš„å¤§éƒ¨åˆ†åŸºç¡€å†…å®¹ï¼Œæˆ‘ä»¬æ¥ç€æ¥çœ‹çœ‹Nettyå†…ç½®çš„ä¸€äº›ç¼–ç å™¨å’Œè§£ç å™¨ã€‚</p>
<p>åœ¨å‰é¢çš„å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬çš„æ•°æ®å‘é€å’Œæ¥æ”¶éƒ½æ˜¯éœ€è¦ä»¥ByteBufå½¢å¼ä¼ è¾“ï¼Œä½†æ˜¯è¿™æ ·æ˜¯ä¸æ˜¯æœ‰ç‚¹å¤ªä¸æ–¹ä¾¿äº†ï¼Œå’±ä»¬èƒ½ä¸èƒ½å‚è€ƒä¸€ä¸‹JavaWebé‚£ç§æä¸ªFilterï¼Œåœ¨æˆ‘ä»¬å¼€å§‹å¤„ç†æ•°æ®ä¹‹å‰ï¼Œè¿‡è¿‡æ»¤ä¸€æ¬¡ï¼Œå¹¶åœ¨è¿‡æ»¤çš„é€”ä¸­å°†æ•°æ®è½¬æ¢æˆæˆ‘ä»¬æƒ³è¦çš„ç±»å‹ï¼Œä¹Ÿå¯ä»¥å°†å‘å‡ºçš„æ•°æ®è¿›è¡Œè½¬æ¢ï¼Œè¿™å°±è¦ç”¨åˆ°ç¼–ç è§£ç å™¨äº†ã€‚</p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æœ€ç®€çš„ï¼Œå­—ç¬¦ä¸²ï¼Œå¦‚æœæˆ‘ä»¬è¦ç›´æ¥åœ¨å®¢æˆ·ç«¯æˆ–æ˜¯æœåŠ¡ç«¯å¤„ç†å­—ç¬¦ä¸²ï¼Œå¯ä»¥ç›´æ¥æ·»åŠ ä¸€ä¸ªå­—ç¬¦ä¸²è§£ç å™¨åˆ°æˆ‘ä»¬çš„æµæ°´çº¿ä¸­ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//è§£ç å™¨æœ¬è´¨ä¸Šä¹Ÿç®—æ˜¯ä¸€ç§ChannelInboundHandlerAdapterï¼Œç”¨äºå¤„ç†å…¥ç«™è¯·æ±‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">StringDecoder</span><span class="o">())</span>   <span class="c1">//å½“å®¢æˆ·ç«¯å‘é€æ¥çš„æ•°æ®åªæ˜¯ç®€å•çš„å­—ç¬¦ä¸²è½¬æ¢çš„ByteBufæ—¶ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨å†…ç½®çš„StringDecoderå³å¯è½¬æ¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">//ç»è¿‡StringDecoderè½¬æ¢åï¼Œmsgç›´æ¥å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥æ‰“å°å°±è¡Œäº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨èµ·æ¥è¿˜æ˜¯éå¸¸æ–¹ä¾¿çš„ï¼Œæˆ‘ä»¬åªéœ€è¦å°†å…¶æ·»åŠ åˆ°æµæ°´çº¿å³å¯ï¼Œå®é™…ä¸Šå™¨æœ¬è´¨å°±æ˜¯ä¸€ä¸ªChannelInboundHandlerAdapterï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/x6Fh48G7PjZqHoW.png" alt="image-20230306174321314" />
    
  </figure>

</p>
<p>æˆ‘ä»¬çœ‹åˆ°å®ƒæ˜¯ç»§æ‰¿è‡ªMessageToMessageDecoderï¼Œç”¨äºå°†ä¼ å…¥çš„Messageè½¬æ¢ä¸ºå¦ä¸€ç§ç±»å‹ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªè¡Œç¼–å†™ä¸€ä¸ªå®ç°ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * æˆ‘ä»¬ä¹Ÿæ¥æä¸€ä¸ªè‡ªå®šä¹‰çš„
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestDecoder</span> <span class="kd">extends</span> <span class="n">MessageToMessageDecoder</span><span class="o">&lt;</span><span class="n">ByteBuf</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">decode</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">channelHandlerContext</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">buf</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æ•°æ®å·²æ”¶åˆ°ï¼Œæ­£åœ¨è¿›è¡Œè§£ç ...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">text</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>  <span class="c1">//ç›´æ¥è½¬æ¢ä¸ºUTF8å­—ç¬¦ä¸²
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">text</span><span class="o">);</span>   <span class="c1">//è§£ç åéœ€è¦å°†è§£æåçš„æ•°æ®ä¸¢è¿›Listä¸­ï¼Œå¦‚æœä¸¢è¿›å»å¤šä¸ªæ•°æ®ï¼Œç›¸å½“äºæ•°æ®è¢«åˆ†æˆäº†å¤šä¸ªï¼Œåé¢çš„Handlerå°±éœ€è¦æ¯ä¸ªéƒ½å¤„ç†ä¸€æ¬¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>è¿è¡Œï¼Œå¯ä»¥çœ‹åˆ°ï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/aM6gy1BAeLUlEui.png" alt="image-20230306174333758" />
    
  </figure>

</p>
<p>å½“ç„¶å¦‚æœæˆ‘ä»¬åœ¨Listé‡Œé¢ä¸¢å¾ˆå¤šä¸ªæ•°æ®çš„è¯ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestDecoder</span> <span class="kd">extends</span> <span class="n">MessageToMessageDecoder</span><span class="o">&lt;</span><span class="n">ByteBuf</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">decode</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">channelHandlerContext</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">buf</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æ•°æ®å·²æ”¶åˆ°ï¼Œæ­£åœ¨è¿›è¡Œè§£ç ...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">text</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>  <span class="c1">//ç›´æ¥è½¬æ¢ä¸ºUTF8å­—ç¬¦ä¸²
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">text</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">text</span><span class="o">+</span><span class="s">&#34;2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">text</span><span class="o">+</span><span class="sc">&#39;3&#39;</span><span class="o">);</span>   <span class="c1">//ä¸€æ¡æ¶ˆæ¯è¢«è§£ç æˆä¸‰æ¡æ¶ˆæ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/izRZ8t4BDXPeQbs.png" alt="image-20230306174344121" />
    
  </figure>

</p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œåé¢çš„Handlerä¼šä¾æ¬¡å¯¹ä¸‰æ¡æ•°æ®éƒ½è¿›è¡Œå¤„ç†ï¼Œå½“ç„¶ï¼Œé™¤äº†MessageToMessageDecoderä¹‹å¤–ï¼Œè¿˜æœ‰å…¶ä»–ç±»å‹çš„è§£ç å™¨ï¼Œæ¯”å¦‚ByteToMessageDecoderç­‰ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€ä»‹ç»äº†ï¼ŒNettyå†…ç½®äº†å¾ˆå¤šçš„è§£ç å™¨å®ç°æ¥æ–¹ä¾¿æˆ‘ä»¬å¼€å‘ï¼Œæ¯”å¦‚HTTPï¼ˆä¸‹ä¸€èŠ‚ä»‹ç»ï¼‰ï¼ŒSMTPã€MQTTç­‰ï¼Œä»¥åŠæˆ‘ä»¬å¸¸ç”¨çš„Redisã€Memcachedã€JSONç­‰æ•°æ®åŒ…ã€‚</p>
<p>å½“ç„¶ï¼Œæœ‰äº†è§£ç å™¨å¤„ç†å‘æ¥çš„æ•°æ®ï¼Œé‚£å‘å‡ºå»çš„æ•°æ®è‚¯å®šä¹Ÿæ˜¯éœ€è¦è¢«å¤„ç†çš„ï¼Œæ‰€ä»¥ç¼–ç å™¨å°±å‡ºç°äº†ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//è§£ç å™¨æœ¬è´¨ä¸Šä¹Ÿç®—æ˜¯ä¸€ç§ChannelInboundHandlerAdapterï¼Œç”¨äºå¤„ç†å…¥ç«™è¯·æ±‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">StringDecoder</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æ”¶åˆ°å®¢æˆ·ç«¯çš„æ•°æ®ï¼š&#34;</span><span class="o">+</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="s">&#34;å¯ä»¥ï¼Œä¸è·Ÿä½ å¤šBB&#34;</span><span class="o">);</span>  <span class="c1">//ç›´æ¥å‘å­—ç¬¦ä¸²å›å»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">})</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">StringEncoder</span><span class="o">());</span>  <span class="c1">//ä½¿ç”¨å†…ç½®çš„StringEncoderå¯ä»¥ç›´æ¥å°†å‡ºç«™çš„å­—ç¬¦ä¸²æ•°æ®ç¼–ç æˆByteBuf
</span></span></span></code></pre></div><p>å’Œä¸Šé¢çš„StringDecoderä¸€æ ·ï¼ŒStringEncoderæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªChannelOutboundHandlerAdapterï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/PruXKkgxhOf3bsJ.png" alt="image-20230306174359121" />
    
  </figure>

</p>
<p>æ˜¯ä¸æ˜¯æ„Ÿè§‰å‰é¢å­¦ä¹ çš„Handlerå’ŒPipelineçªç„¶å°±å˜å¾—æœ‰ç”¨äº†ï¼Œç›´æ¥ä¸€æ¡çº¿æŠŠæ•°æ®å¤„ç†å®‰æ’å¾—æ˜æ˜ç™½ç™½å•Šã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬æŠŠå®¢æˆ·ç«¯ä¹Ÿæ”¹æˆä½¿ç”¨ç¼–ç ã€è§£ç å™¨çš„æ ·å­ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Bootstrap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">bootstrap</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">channel</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                            <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">StringDecoder</span><span class="o">())</span>  <span class="c1">//è§£ç å™¨å®‰æ’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">                                <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">                                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;&gt;&gt; æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š&#34;</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>  <span class="c1">//ç›´æ¥æ¥æ”¶å­—ç¬¦ä¸²
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                            <span class="o">})</span>
</span></span><span class="line"><span class="cl">                            <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">StringEncoder</span><span class="o">());</span>  <span class="c1">//ç¼–ç å™¨å®‰æ’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="n">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">&#34;localhost&#34;</span><span class="o">,</span> <span class="mi">8080</span><span class="o">).</span><span class="na">channel</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="o">(</span><span class="n">Scanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">in</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;&lt;&lt; è¯·è¾“å…¥è¦å‘é€ç»™æœåŠ¡ç«¯çš„å†…å®¹ï¼š&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">text</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">text</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">channel</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">text</span><span class="o">);</span>  <span class="c1">//ç›´æ¥å‘é€å­—ç¬¦ä¸²å°±è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>è¿™æ ·æˆ‘ä»¬çš„ä»£ç é‡åˆè¹­è¹­çš„å‡å°‘äº†å¾ˆå¤šï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/Jh1VqZMD4LRi7f8.png" alt="image-20230306174410560" />
    
  </figure>

</p>
<p>å½“ç„¶ï¼Œé™¤äº†ç¼–ç å™¨å’Œè§£ç å™¨ä¹‹å¤–ï¼Œè¿˜æœ‰ç¼–è§£ç å™¨ã€‚ï¼Ÿï¼Ÿç¼åˆæ€ªï¼Ÿï¼Ÿ</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/CpcgbnRwSk6dIF5.png" alt="image-20230306174419482" />
    
  </figure>

</p>
<p>å¯ä»¥çœ‹åˆ°å®ƒæ˜¯æ—¢ç»§æ‰¿äº†ChannelInboundHandlerAdapterä¹Ÿå®ç°äº†ChannelOutboundHandleræ¥å£ï¼Œåˆèƒ½å¤„ç†å‡ºç«™ä¹Ÿèƒ½å¤„ç†å…¥ç«™è¯·æ±‚ï¼Œå®é™…ä¸Šå°±æ˜¯å°†ä¹‹å‰çš„ç»™ç»„åˆåˆ°ä¸€èµ·äº†ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¹Ÿå¯ä»¥å®ç°ä¸€ä¸ªç¼åˆåœ¨ä¸€èµ·çš„StringCodecç±»ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//éœ€è¦æŒ‡å®šä¸¤ä¸ªæ³›å‹ï¼Œç¬¬ä¸€ä¸ªæ˜¯å…¥ç«™çš„æ¶ˆæ¯ç±»å‹ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯å‡ºç«™çš„æ¶ˆæ¯ç±»å‹ï¼Œå‡ºç«™æ˜¯Stringç±»å‹ï¼Œæˆ‘ä»¬è¦è½¬æˆByteBuf
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StringCodec</span> <span class="kd">extends</span> <span class="n">MessageToMessageCodec</span><span class="o">&lt;</span><span class="n">ByteBuf</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">encode</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">channelHandlerContext</span><span class="o">,</span> <span class="n">String</span> <span class="n">buf</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æ­£åœ¨å¤„ç†å‡ºç«™æ•°æ®...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">Unpooled</span><span class="o">.</span><span class="na">wrappedBuffer</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>   <span class="c1">//åŒæ ·çš„ï¼Œæ·»åŠ çš„æ•°é‡å°±æ˜¯å‡ºç«™çš„æ¶ˆæ¯æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">decode</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">channelHandlerContext</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">buf</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æ­£åœ¨å¤„ç†å…¥ç«™æ•°æ®...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>  <span class="c1">//å’Œä¹‹å‰ä¸€æ ·ï¼Œç›´æ¥ä¸€è¡Œè§£å†³
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°å®é™…ä¸Šå°±æ˜¯éœ€è¦æˆ‘ä»¬åŒæ—¶å»å®ç°ç¼–ç å’Œè§£ç æ–¹æ³•ï¼Œç»§æ‰¿MessageToMessageCodecç±»å³å¯ã€‚</p>
<p>å½“ç„¶ï¼Œå¦‚æœæ•´æ¡æµæ°´çº¿ä¸Šæœ‰å¾ˆå¤šä¸ªè§£ç å™¨æˆ–æ˜¯ç¼–ç å™¨ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥å¤šæ¬¡è¿›è¡Œç¼–ç æˆ–æ˜¯è§£ç ï¼Œæ¯”å¦‚ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StringToStringEncoder</span> <span class="kd">extends</span> <span class="n">MessageToMessageEncoder</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">encode</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">channelHandlerContext</span><span class="o">,</span> <span class="n">String</span> <span class="n">s</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æˆ‘æ˜¯é¢„å¤„ç†ç¼–ç å™¨ï¼Œå°±è¦çš®è¿™ä¸€ä¸‹ã€‚&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;[å·²å¤„ç†] &#34;</span><span class="o">+</span><span class="n">s</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//è§£ç å™¨æœ¬è´¨ä¸Šä¹Ÿç®—æ˜¯ä¸€ç§ChannelInboundHandlerAdapterï¼Œç”¨äºå¤„ç†å…¥ç«™è¯·æ±‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">StringDecoder</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æ”¶åˆ°å®¢æˆ·ç«¯çš„æ•°æ®ï¼š&#34;</span><span class="o">+</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="s">&#34;å¯ä»¥ï¼Œä¸è·Ÿä½ å¤šBB&#34;</span><span class="o">);</span>  <span class="c1">//ç›´æ¥å‘å­—ç¬¦ä¸²å›å»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">})</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">StringEncoder</span><span class="o">())</span>    <span class="c1">//æœ€åå†è½¬æˆByteBuf
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">StringToStringEncoder</span><span class="o">());</span>  <span class="c1">//å…ˆä»æˆ‘ä»¬è‡ªå®šä¹‰çš„å¼€å§‹
</span></span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œæ•°æ®åœ¨æµæ°´çº¿ä¸Šä¸€å±‚ä¸€å±‚å¤„ç†æœ€åå†å›åˆ°çš„å®¢æˆ·ç«¯ï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/7f9LpaTQ8OcqMeN.png" alt="image-20230306174519936" />
    
  </figure>

</p>
<p>æˆ‘ä»¬åœ¨ä¸€å¼€å§‹æåˆ°çš„ç²˜åŒ…/æ‹†åŒ…é—®é¢˜ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€ä¸ªè§£ç å™¨è§£å†³ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">FixedLengthFrameDecoder</span><span class="o">(</span><span class="mi">10</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//ç¬¬ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œä½¿ç”¨å®šé•¿æ•°æ®åŒ…ï¼Œæ¯ä¸ªæ•°æ®åŒ…éƒ½è¦æ˜¯æŒ‡å®šé•¿åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  			<span class="o">...</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">DelimiterBasedFrameDecoder</span><span class="o">(</span><span class="mi">1024</span><span class="o">,</span> <span class="n">Unpooled</span><span class="o">.</span><span class="na">wrappedBuffer</span><span class="o">(</span><span class="s">&#34;!&#34;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">())))</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//ç¬¬äºŒç§ï¼Œå°±æ˜¯æŒ‡å®šä¸€ä¸ªç‰¹å®šçš„åˆ†éš”ç¬¦ï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™é‡Œä»¥æ„Ÿå¹å·ä¸ºåˆ†éš”ç¬¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  			<span class="c1">//åœ¨æ”¶åˆ°åˆ†éš”ç¬¦ä¹‹å‰çš„æ‰€æœ‰æ•°æ®ï¼Œéƒ½ä½œä¸ºåŒä¸€ä¸ªæ•°æ®åŒ…çš„å†…å®¹
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">LengthFieldBasedFrameDecoder</span><span class="o">(</span><span class="mi">1024</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">4</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//ç¬¬ä¸‰ç§æ–¹æ¡ˆï¼Œå°±æ˜¯åœ¨å¤´éƒ¨æ·»åŠ é•¿åº¦ä¿¡æ¯ï¼Œæ¥ç¡®å®šå½“å‰å‘é€çš„æ•°æ®åŒ…å…·ä½“é•¿åº¦æ˜¯å¤šå°‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//offsetæ˜¯ä»å“ªé‡Œå¼€å§‹ï¼Œlengthæ˜¯é•¿åº¦ä¿¡æ¯å å¤šå°‘å­—èŠ‚ï¼Œè¿™é‡Œæ˜¯ä»0å¼€å§‹è¯»4ä¸ªå­—èŠ‚è¡¨ç¤ºæ•°æ®åŒ…é•¿åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">StringDecoder</span><span class="o">())</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">StringDecoder</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;&gt;&gt; æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š&#34;</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">})</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">LengthFieldPrepender</span><span class="o">(</span><span class="mi">4</span><span class="o">))</span>   <span class="c1">//å®¢æˆ·ç«¯åœ¨å‘é€æ—¶ä¹Ÿéœ€è¦å°†é•¿åº¦æ‹¼åˆ°å‰é¢å»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">StringEncoder</span><span class="o">());</span>
</span></span></code></pre></div><p>æœ‰å…³ç¼–ç å™¨å’Œè§£ç å™¨çš„å†…å®¹å°±å…ˆä»‹ç»åˆ°è¿™é‡Œã€‚</p>


<h3 class="relative group">å®ç°HTTPåè®®é€šä¿¡ 
    <div id="%E5%AE%9E%E7%8E%B0http%E5%8D%8F%E8%AE%AE%E9%80%9A%E4%BF%A1" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%AE%9E%E7%8E%B0http%E5%8D%8F%E8%AE%AE%E9%80%9A%E4%BF%A1" aria-label="é”šç‚¹">#</a>
    </span>        
    
</h3>
<p>å‰é¢æˆ‘ä»¬ä»‹ç»äº†Nettyä¸ºæˆ‘ä»¬æä¾›çš„ç¼–ç å™¨å’Œè§£ç å™¨ï¼Œè¿™é‡Œæˆ‘ä»¬å°±æ¥ä½¿ç”¨ä¸€ä¸‹æ”¯æŒHTTPåè®®çš„ç¼–ç å™¨å’Œè§£ç å™¨ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpRequestDecoder</span><span class="o">())</span>   <span class="c1">//Httpè¯·æ±‚è§£ç å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æ”¶åˆ°å®¢æˆ·ç«¯çš„æ•°æ®ï¼š&#34;</span><span class="o">+</span><span class="n">msg</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>  <span class="c1">//çœ‹çœ‹æ˜¯ä¸ªå•¥ç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>              	<span class="c1">//æ”¶åˆ°æµè§ˆå™¨è¯·æ±‚åï¼Œæˆ‘ä»¬éœ€è¦ç»™ä¸€ä¸ªå“åº”å›å»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">FullHttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultFullHttpResponse</span><span class="o">(</span><span class="n">HttpVersion</span><span class="o">.</span><span class="na">HTTP_1_1</span><span class="o">,</span> <span class="n">HttpResponseStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span>  <span class="c1">//HTTPç‰ˆæœ¬ä¸º1.1ï¼ŒçŠ¶æ€ç å°±OKï¼ˆ200ï¼‰å³å¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>              	<span class="c1">//ç›´æ¥å‘å“åº”å†…å®¹ä¸­å†™å…¥æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">response</span><span class="o">.</span><span class="na">content</span><span class="o">().</span><span class="na">writeCharSequence</span><span class="o">(</span><span class="s">&#34;Hello World!&#34;</span><span class="o">,</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>   <span class="c1">//å‘é€å“åº”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>   <span class="c1">//HTTPè¯·æ±‚æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œæ‰€ä»¥è®°å¾—å…³é—­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">})</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpResponseEncoder</span><span class="o">());</span>   <span class="c1">//å“åº”è®°å¾—ä¹Ÿè¦ç¼–ç åå‘é€å“¦
</span></span></span></code></pre></div><p>ç°åœ¨æˆ‘ä»¬ç”¨æµè§ˆå™¨è®¿é—®ä¸€ä¸‹æˆ‘ä»¬çš„æœåŠ¡å™¨å§ï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/oAlpObgidLQhzE8.png" alt="image-20230306174531740" />
    
  </figure>

</p>
<p>å¯ä»¥çœ‹åˆ°æµè§ˆå™¨æˆåŠŸæ¥æ”¶åˆ°æœåŠ¡å™¨å“åº”ï¼Œç„¶åæ§åˆ¶å°æ‰“å°äº†ä»¥ä¸‹ç±»å‹ï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/WoCXiKelwzmYnQI.png" alt="image-20230306174542903" />
    
  </figure>

</p>
<p>å¯ä»¥çœ‹åˆ°ä¸€æ¬¡è¯·æ±‚æ˜¯ä¸€ä¸ªDefaultHttpRequest+LastHttpContent$1ï¼Œè¿™é‡Œæœ‰ä¸¤ç»„æ˜¯å› ä¸ºæµè§ˆå™¨è¯·æ±‚äº†ä¸€ä¸ªåœ°å€ä¹‹åç´§æ¥ç€è¯·æ±‚äº†æˆ‘ä»¬ç½‘ç«™çš„faviconå›¾æ ‡ã€‚</p>
<p>è¿™æ ·æŠŠæ•°æ®åˆ†å¼€å¤„ç†è‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œè¦æ˜¯ç›´æ¥æ•´åˆæˆä¸€ä¸ªå¤šå¥½ï¼Œå®‰æ’ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpRequestDecoder</span><span class="o">())</span>   <span class="c1">//Httpè¯·æ±‚è§£ç å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpObjectAggregator</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">))</span>  <span class="c1">//æä¸€ä¸ªèšåˆå™¨ï¼Œå°†å†…å®¹èšåˆä¸ºä¸€ä¸ªFullHttpRequestï¼Œå‚æ•°æ˜¯æœ€å¤§å†…å®¹é•¿åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">FullHttpRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="o">(</span><span class="n">FullHttpRequest</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æµè§ˆå™¨è¯·æ±‚è·¯å¾„ï¼š&#34;</span><span class="o">+</span><span class="n">request</span><span class="o">.</span><span class="na">uri</span><span class="o">());</span>  <span class="c1">//ç›´æ¥è·å–è¯·æ±‚ç›¸å…³ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">FullHttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultFullHttpResponse</span><span class="o">(</span><span class="n">HttpVersion</span><span class="o">.</span><span class="na">HTTP_1_1</span><span class="o">,</span> <span class="n">HttpResponseStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">response</span><span class="o">.</span><span class="na">content</span><span class="o">().</span><span class="na">writeCharSequence</span><span class="o">(</span><span class="s">&#34;Hello World!&#34;</span><span class="o">,</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">})</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpResponseEncoder</span><span class="o">());</span>
</span></span></code></pre></div><p>å†æ¬¡è®¿é—®ï¼Œæˆ‘ä»¬å‘ç°å¯ä»¥æ­£å¸¸è¯»å–è¯·æ±‚è·¯å¾„äº†ï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/P3QRD2kHme1Vhga.png" alt="image-20230306174557790" />
    
  </figure>

</p>
<p>æˆ‘ä»¬æ¥è¯•è¯•çœ‹æä¸ªé™æ€é¡µé¢ä»£ç†ç©ç©ï¼Œæ‹¿å‡ºæˆ‘ä»¬çš„é™ˆå¹´è€æ¨¡æ¿ï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/ITE5izhrG4ZedSO.png" alt="image-20230306174609270" />
    
  </figure>

</p>
<p>å…¨éƒ¨æ”¾è¿›Resourceæ–‡ä»¶å¤¹ï¼Œä¸€ä¼šæ ¹æ®æµè§ˆå™¨çš„è¯·æ±‚è·¯å¾„ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿”å›å¯¹åº”çš„é¡µé¢äº†ï¼Œå…ˆå®‰æ’ä¸€ä¸ªè§£æå™¨ï¼Œç”¨äºè§£æè·¯å¾„ç„¶åå°†é™æ€é¡µé¢çš„å†…å®¹è¿”å›ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PageResolver</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//ç›´æ¥å•ä¾‹æ¨¡å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">PageResolver</span> <span class="n">INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PageResolver</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="nf">PageResolver</span><span class="o">(){}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">PageResolver</span> <span class="nf">getInstance</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">INSTANCE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  	<span class="c1">//è¯·æ±‚è·¯å¾„ç»™è¿›æ¥ï¼Œæ¥ç€æˆ‘ä»¬éœ€è¦å°†é¡µé¢æ‹¿åˆ°ï¼Œç„¶åè½¬æ¢æˆå“åº”æ•°æ®åŒ…å‘å›å»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="n">FullHttpResponse</span> <span class="nf">resolveResource</span><span class="o">(</span><span class="n">String</span> <span class="n">path</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">path</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;/&#34;</span><span class="o">))</span>  <span class="o">{</span>  <span class="c1">//åˆ¤æ–­ä¸€ä¸‹æ˜¯ä¸æ˜¯æ­£å¸¸çš„è·¯å¾„è¯·æ±‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;/&#34;</span><span class="o">)</span> <span class="o">?</span> <span class="s">&#34;index.html&#34;</span> <span class="o">:</span> <span class="n">path</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>    <span class="c1">//å¦‚æœæ˜¯ç›´æ¥è¯·æ±‚æ ¹è·¯å¾„ï¼Œé‚£å°±é»˜è®¤è¿”å›indexé¡µé¢ï¼Œå¦åˆ™å°±è¯¥è¿”å›ä»€ä¹ˆè·¯å¾„çš„æ–‡ä»¶å°±è¿”å›ä»€ä¹ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">try</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">stream</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="n">path</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span><span class="o">(</span><span class="n">stream</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>   <span class="c1">//æ‹¿åˆ°æ–‡ä»¶è¾“å…¥æµä¹‹åï¼Œæ‰å¯ä»¥è¿”å›é¡µé¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">stream</span><span class="o">.</span><span class="na">available</span><span class="o">()];</span>
</span></span><span class="line"><span class="cl">                    <span class="n">stream</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">packet</span><span class="o">(</span><span class="n">HttpResponseStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span> <span class="n">bytes</span><span class="o">);</span>  <span class="c1">//æ•°æ®å…ˆè¯»å‡ºæ¥ï¼Œç„¶åäº¤ç»™ä¸‹é¢çš„æ–¹æ³•æ‰“åŒ…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">      	<span class="c1">//å…¶ä»–æƒ…å†µä¸€å¾‹è¿”å›404
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">packet</span><span class="o">(</span><span class="n">HttpResponseStatus</span><span class="o">.</span><span class="na">NOT_FOUND</span><span class="o">,</span> <span class="s">&#34;404 Not Found!&#34;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  	<span class="c1">//åŒ…è£…æˆFullHttpResponseï¼ŒæŠŠçŠ¶æ€ç å’Œæ•°æ®å†™è¿›å»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">FullHttpResponse</span> <span class="nf">packet</span><span class="o">(</span><span class="n">HttpResponseStatus</span> <span class="n">status</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">FullHttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultFullHttpResponse</span><span class="o">(</span><span class="n">HttpVersion</span><span class="o">.</span><span class="na">HTTP_1_1</span><span class="o">,</span> <span class="n">status</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span><span class="o">.</span><span class="na">content</span><span class="o">().</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>ç°åœ¨æˆ‘ä»¬çš„é™æ€èµ„æºè§£æå°±å†™å¥½äº†ï¼Œæ¥ç€ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpRequestDecoder</span><span class="o">())</span>   <span class="c1">//Httpè¯·æ±‚è§£ç å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpObjectAggregator</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">))</span>  <span class="c1">//æä¸€ä¸ªèšåˆå™¨ï¼Œå°†å†…å®¹èšåˆä¸ºä¸€ä¸ªFullHttpRequestï¼Œå‚æ•°æ˜¯æœ€å¤§å†…å®¹é•¿åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">FullHttpRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="o">(</span><span class="n">FullHttpRequest</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">              	<span class="c1">//è¯·æ±‚è¿›æ¥äº†ç›´æ¥èµ°è§£æ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">PageResolver</span> <span class="n">resolver</span> <span class="o">=</span> <span class="n">PageResolver</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">resolver</span><span class="o">.</span><span class="na">resolveResource</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">uri</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">                <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">})</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpResponseEncoder</span><span class="o">());</span>
</span></span></code></pre></div><p>ç°åœ¨æˆ‘ä»¬å¯åŠ¨æœåŠ¡å™¨æ¥è¯•è¯•çœ‹å§ï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/PpFUKSMXDi5ItjN.png" alt="image-20230306174624966" />
    
  </figure>

</p>
<p>å¯ä»¥çœ‹åˆ°é¡µé¢å¯ä»¥æ­£å¸¸å±•ç¤ºäº†ï¼Œæ˜¯ä¸æ˜¯æœ‰Tomcatå“ªå‘³äº†ã€‚</p>


<h3 class="relative group">å…¶ä»–å†…ç½®Handlerä»‹ç» 
    <div id="%E5%85%B6%E4%BB%96%E5%86%85%E7%BD%AEhandler%E4%BB%8B%E7%BB%8D" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%85%B6%E4%BB%96%E5%86%85%E7%BD%AEhandler%E4%BB%8B%E7%BB%8D" aria-label="é”šç‚¹">#</a>
    </span>        
    
</h3>
<p>Nettyä¹Ÿä¸ºæˆ‘ä»¬å†…ç½®äº†ä¸€äº›å…¶ä»–æ¯”è¾ƒå¥½ç”¨çš„Handlerï¼Œæ¯”å¦‚æˆ‘ä»¬è¦æ‰“å°æ—¥å¿—ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpRequestDecoder</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpObjectAggregator</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">LoggingHandler</span><span class="o">(</span><span class="n">LogLevel</span><span class="o">.</span><span class="na">INFO</span><span class="o">))</span>   <span class="c1">//æ·»åŠ ä¸€ä¸ªæ—¥å¿—Handlerï¼Œåœ¨è¯·æ±‚åˆ°æ¥æ—¶ä¼šè‡ªåŠ¨æ‰“å°ç›¸å…³æ—¥å¿—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">...</span>
</span></span></code></pre></div><p>æ—¥å¿—çº§åˆ«æˆ‘ä»¬é€‰æ‹©INFOï¼Œç°åœ¨æˆ‘ä»¬ç”¨æµè§ˆå™¨è®¿é—®ä¸€ä¸‹ï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/bFBDTEpi3S6U87N.png" alt="image-20230306174636233" />
    
  </figure>

</p>
<p>å¯ä»¥çœ‹åˆ°æ¯æ¬¡è¯·æ±‚çš„å†…å®¹å’Œè¯¦ç»†ä¿¡æ¯éƒ½ä¼šåœ¨æ—¥å¿—ä¸­å‡ºç°ï¼ŒåŒ…æ‹¬è¯¦ç»†çš„æ•°æ®åŒ…è§£æè¿‡ç¨‹ï¼Œè¯·æ±‚å¤´ä¿¡æ¯éƒ½æ˜¯å®Œæ•´åœ°æ‰“å°åœ¨æ§åˆ¶å°ä¸Šçš„ã€‚</p>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨Handlerå¯¹IPåœ°å€è¿›è¡Œè¿‡æ»¤ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¸å¸Œæœ›æŸäº›IPåœ°å€è¿æ¥æˆ‘ä»¬çš„æœåŠ¡å™¨ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpRequestDecoder</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpObjectAggregator</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">RuleBasedIpFilter</span><span class="o">(</span><span class="k">new</span> <span class="n">IpFilterRule</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">matches</span><span class="o">(</span><span class="n">InetSocketAddress</span> <span class="n">inetSocketAddress</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="o">!</span><span class="n">inetSocketAddress</span><span class="o">.</span><span class="na">getHostName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">              	<span class="c1">//è¿›è¡ŒåŒ¹é…ï¼Œè¿”å›falseè¡¨ç¤ºåŒ¹é…å¤±è´¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>              	<span class="c1">//å¦‚æœåŒ¹é…å¤±è´¥ï¼Œé‚£ä¹ˆä¼šæ ¹æ®ä¸‹é¢çš„ç±»å‹å†³å®šè¯¥å¹²ä»€ä¹ˆï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™é‡Œåˆ¤æ–­æ˜¯ä¸æ˜¯æœ¬åœ°è®¿é—®çš„ï¼Œå¦‚æœæ˜¯é‚£å°±æ‹’ç»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="n">IpFilterRuleType</span> <span class="nf">ruleType</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">IpFilterRuleType</span><span class="o">.</span><span class="na">REJECT</span><span class="o">;</span>   <span class="c1">//ç±»å‹ï¼ŒREJECTè¡¨ç¤ºæ‹’ç»è¿æ¥ï¼ŒACCEPTè¡¨ç¤ºå…è®¸è¿æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}))</span>
</span></span></code></pre></div><p>ç°åœ¨æˆ‘ä»¬æµè§ˆå™¨è®¿é—®ä¸€ä¸‹çœ‹çœ‹ï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/DlLTroQJdhPcyBO.png" alt="image-20230306174646897" />
    
  </figure>

</p>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹é‚£äº›é•¿æœŸå¤„äºç©ºé—²çš„è¿›è¡Œå¤„ç†ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">StringDecoder</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">IdleStateHandler</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="mi">0</span><span class="o">))</span>  <span class="c1">//IdleStateHandlerèƒ½å¤Ÿä¾¦æµ‹è¿æ¥ç©ºé—²çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºè¿æ¥å¤šå°‘ç§’æ²¡æœ‰è¯»æ“ä½œæ—¶è§¦å‘äº‹ä»¶ï¼Œç¬¬äºŒä¸ªæ˜¯å†™æ“ä½œï¼Œç¬¬ä¸‰ä¸ªæ˜¯è¯»å†™æ“ä½œéƒ½ç®—ï¼Œ0è¡¨ç¤ºç¦ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//äº‹ä»¶éœ€è¦åœ¨ChannelInboundHandlerAdapterä¸­è¿›è¡Œç›‘å¬å¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æ”¶åˆ°å®¢æˆ·ç«¯æ•°æ®ï¼š&#34;</span><span class="o">+</span><span class="n">msg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="s">&#34;å·²æ”¶åˆ°ï¼&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">userEventTriggered</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">evt</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//æ²¡æƒ³åˆ°å§ï¼Œè¿™ä¸ªæ–¹æ³•åŸæ¥æ˜¯åœ¨è¿™ä¸ªæ—¶å€™ç”¨çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span><span class="o">(</span><span class="n">evt</span> <span class="k">instanceof</span> <span class="n">IdleStateEvent</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">IdleStateEvent</span> <span class="n">event</span> <span class="o">=</span> <span class="o">(</span><span class="n">IdleStateEvent</span><span class="o">)</span> <span class="n">evt</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">state</span><span class="o">()</span> <span class="o">==</span> <span class="n">IdleState</span><span class="o">.</span><span class="na">WRITER_IDLE</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;å¥½ä¹…éƒ½æ²¡å†™äº†ï¼Œçœ‹è§†é¢‘çš„ä½ çœŸçš„æœ‰è®¤çœŸåœ¨è·Ÿç€æ•²å—&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">state</span><span class="o">()</span> <span class="o">==</span> <span class="n">IdleState</span><span class="o">.</span><span class="na">READER_IDLE</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;å·²ç»å¾ˆä¹…å¾ˆä¹…æ²¡æœ‰è¯»äº‹ä»¶å‘ç”Ÿäº†ï¼Œå¥½å¯‚å¯&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">})</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">StringEncoder</span><span class="o">());</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ä»¬è¶…è¿‡ä¸€æ®µæ—¶é—´ä¸å‘é€æ•°æ®æ—¶ï¼Œå°±ä¼šè¿™æ ·ï¼š</p>
<p>




  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://s2.loli.net/2023/03/06/T26DcV39fHULXQ4.png" alt="image-20230306174701901" />
    
  </figure>

</p>
<p>é€šè¿‡è¿™ç§æœºåˆ¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥å…³æ‰é‚£äº›å ç€èŒ…å‘ä¸æ‹‰å±çš„è¿æ¥ã€‚</p>


<h3 class="relative group">å¯åŠ¨æµç¨‹æºç è§£è¯» 
    <div id="%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB" aria-label="é”šç‚¹">#</a>
    </span>        
    
</h3>
<p>å‰é¢æˆ‘ä»¬å®Œæˆäº†å¯¹NettyåŸºæœ¬åŠŸèƒ½çš„è®²è§£ï¼Œæˆ‘ä»¬æœ€åå°±æ¥çœ‹ä¸€ä¸‹ï¼ŒNettyåˆ°åº•æ˜¯å¦‚ä½•å¯åŠ¨ä»¥åŠè¿›è¡Œæ•°æ®å¤„ç†çš„ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬çŸ¥é“ï¼Œæ•´ä¸ªæœåŠ¡ç«¯æ˜¯åœ¨bindä¹‹åå¯åŠ¨çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä»è¿™é‡Œå¼€å§‹ä¸‹æ‰‹ï¼Œä¸å¤šBBç›´æ¥ä¸Šæºç ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ChannelFuture</span> <span class="nf">bind</span><span class="o">(</span><span class="kt">int</span> <span class="n">inetPort</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="n">InetSocketAddress</span><span class="o">(</span><span class="n">inetPort</span><span class="o">));</span>   <span class="c1">//è½¬æ¢æˆInetSocketAddresså¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></div><p>è¿›æ¥ä¹‹åå‘ç°æ˜¯è°ƒç”¨çš„å…¶ä»–ç»‘å®šæ–¹æ³•ï¼Œç»§ç»­ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ChannelFuture</span> <span class="nf">bind</span><span class="o">(</span><span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">validate</span><span class="o">();</span>   <span class="c1">//å†æ¬¡éªŒè¯ä¸€ä¸‹ï¼Œçœ‹çœ‹EventLoopGroupå’ŒChannelæŒ‡å®šäº†æ²¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">doBind</span><span class="o">((</span><span class="n">SocketAddress</span><span class="o">)</span><span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">localAddress</span><span class="o">,</span> <span class="s">&#34;localAddress&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">ChannelFuture</span> <span class="nf">doBind</span><span class="o">(</span><span class="kd">final</span> <span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="n">regFuture</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">initAndRegister</span><span class="o">();</span>   <span class="c1">//ä¸Šæ¥ç¬¬ä¸€å¥åˆå§‹åŒ–ç„¶åæ³¨å†Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬çœ‹çœ‹æ˜¯æ€ä¹ˆæ³¨å†Œçš„ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="nf">initAndRegister</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">channel</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">channelFactory</span><span class="o">.</span><span class="na">newChannel</span><span class="o">();</span>    <span class="c1">//é€šè¿‡channelFactoryåˆ›å»ºæ–°çš„Channelï¼Œå®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬åœ¨ä¸€å¼€å§‹è®¾å®šçš„NioServerSocketChannel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">this</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>    <span class="c1">//æ¥ç€å¯¹åˆ›å»ºå¥½çš„NioServerSocketChannelè¿›è¡Œåˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ChannelFuture</span> <span class="n">regFuture</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">config</span><span class="o">().</span><span class="na">group</span><span class="o">().</span><span class="na">register</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span> <span class="c1">//å°†é€šé“æ³¨å†Œåˆ°bossGroupä¸­çš„ä¸€ä¸ªEventLoopä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">regFuture</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬æ¥çœ‹çœ‹æ˜¯å¦‚ä½•å¯¹åˆ›å»ºå¥½çš„ServerSocketChannelè¿›è¡Œåˆå§‹åŒ–çš„ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">Channel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">setChannelOptions</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">newOptionsArray</span><span class="o">(),</span> <span class="n">logger</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">setAttributes</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">newAttributesArray</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">ChannelPipeline</span> <span class="n">p</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//åœ¨æµæ°´çº¿ä¸Šæ·»åŠ ä¸€ä¸ªHandlerï¼Œåœ¨Handleråˆå§‹åŒ–çš„æ—¶å€™å‘EventLoopä¸­æäº¤ä¸€ä¸ªä»»åŠ¡ï¼Œå°†ServerBootstrapAcceptoræ·»åŠ åˆ°æµæ°´çº¿ä¸Š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//è¿™æ ·æˆ‘ä»¬çš„ServerSocketChannelåœ¨å®¢æˆ·ç«¯è¿æ¥æ—¶å°±èƒ½Acceptäº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">p</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelHandler</span><span class="o">[]{</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">Channel</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="kd">final</span> <span class="n">Channel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">ChannelHandler</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">ServerBootstrap</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">config</span><span class="o">.</span><span class="na">handler</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">handler</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelHandler</span><span class="o">[]{</span><span class="n">handler</span><span class="o">});</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">ch</span><span class="o">.</span><span class="na">eventLoop</span><span class="o">().</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                  	<span class="c1">//è¿™é‡Œæäº¤ä¸€ä¸ªä»»åŠ¡ï¼Œå°†ServerBootstrapAcceptoræ·»åŠ åˆ°ServerSocketChannelçš„pipelineä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelHandler</span><span class="o">[]{</span><span class="k">new</span> <span class="n">ServerBootstrapAcceptor</span><span class="o">(</span><span class="n">ch</span><span class="o">,</span> <span class="n">currentChildGroup</span><span class="o">,</span> <span class="n">currentChildHandler</span><span class="o">,</span> <span class="n">currentChildOptions</span><span class="o">,</span> <span class="n">currentChildAttrs</span><span class="o">)});</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}});</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼ŒServerBootstrapAcceptoræ€ä¹ˆå¤„ç†çš„ï¼Œç›´æ¥çœ‹åˆ°å®ƒçš„<code>channelRead</code>æ–¹æ³•ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//å½“åº•å±‚NIOçš„ServerSocketChannelçš„Selectoræœ‰OP_ACCEPTäº‹ä»¶åˆ°è¾¾æ—¶ï¼ŒNioEventLoopä¼šæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ï¼Œåˆ›å»ºSocketChannelï¼Œå¹¶è§¦å‘channelReadå›è°ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  	<span class="c1">//æ­¤æ—¶msgå°±æ˜¯Acceptè¿æ¥åˆ›å»ºä¹‹åçš„Channelå¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">final</span> <span class="n">Channel</span> <span class="n">child</span> <span class="o">=</span> <span class="o">(</span><span class="n">Channel</span><span class="o">)</span><span class="n">msg</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  	<span class="c1">//è¿™é‡Œç›´æ¥å°†æˆ‘ä»¬ä¹‹å‰ç¼–å†™çš„childHandleræ·»åŠ åˆ°æ–°åˆ›å»ºçš„å®¢æˆ·ç«¯è¿æ¥çš„æµæ°´çº¿ä¸­ï¼ˆæ˜¯ä¸æ˜¯æ„Ÿè§‰çªç„¶å°±é€šäº†ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">child</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelHandler</span><span class="o">[]{</span><span class="k">this</span><span class="o">.</span><span class="na">childHandler</span><span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbstractBootstrap</span><span class="o">.</span><span class="na">setChannelOptions</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">childOptions</span><span class="o">,</span> <span class="n">ServerBootstrap</span><span class="o">.</span><span class="na">logger</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbstractBootstrap</span><span class="o">.</span><span class="na">setAttributes</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">childAttrs</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      	<span class="c1">//ç›´æ¥å‘workGroupä¸­çš„ä¸€ä¸ªEventLoopæ³¨å†Œæ–°åˆ›å»ºå¥½çš„å®¢æˆ·ç«¯è¿æ¥Channelï¼Œç­‰å¾…è¯»å†™äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">this</span><span class="o">.</span><span class="na">childGroup</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">child</span><span class="o">).</span><span class="na">addListener</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelFutureListener</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">          	<span class="c1">//å¼‚æ­¥æ“ä½œå®Œæˆåï¼Œå¦‚æœæ²¡æœ‰æ³¨å†ŒæˆåŠŸï¼Œå°±å¼ºåˆ¶å…³é—­è¿™ä¸ªChannel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">operationComplete</span><span class="o">(</span><span class="n">ChannelFuture</span> <span class="n">future</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(!</span><span class="n">future</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ServerBootstrap</span><span class="o">.</span><span class="na">ServerBootstrapAcceptor</span><span class="o">.</span><span class="na">forceClose</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="n">future</span><span class="o">.</span><span class="na">cause</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                	<span class="o">...</span>
</span></span></code></pre></div><p>æ‰€ä»¥ï¼Œå®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬ä¹‹å‰è®²è§£çš„ä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å‹ï¼Œåªè¦å‰é¢ç†è§£äº†ï¼Œè¿™é‡Œå…¶å®å¾ˆå¥½æ¨æ–­ã€‚</p>
<p>åˆå§‹åŒ–å®Œæˆä¹‹åï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æ³¨å†Œï¼Œåœ¨ä¹‹å‰NIOé˜¶æ®µæˆ‘ä»¬ä¹Ÿæ˜¯éœ€è¦å°†Channelæ³¨å†Œåˆ°å¯¹åº”çš„Selectoræ‰å¯ä»¥å¼€å§‹é€‰æ‹©ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ChannelFuture</span> <span class="nf">register</span><span class="o">(</span><span class="n">Channel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">register</span><span class="o">((</span><span class="n">ChannelPromise</span><span class="o">)(</span><span class="k">new</span> <span class="n">DefaultChannelPromise</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="k">this</span><span class="o">)));</span>  <span class="c1">//è½¬æ¢æˆChannelPromiseç»§ç»­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ChannelFuture</span> <span class="nf">register</span><span class="o">(</span><span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">promise</span><span class="o">,</span> <span class="s">&#34;promise&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">promise</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">unsafe</span><span class="o">().</span><span class="na">register</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>   <span class="c1">//è°ƒç”¨Channelçš„Unsafeæ¥å£å®ç°è¿›è¡Œæ³¨å†Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">promise</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>ç»§ç»­å‘ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="n">EventLoop</span> <span class="n">eventLoop</span><span class="o">,</span> <span class="kd">final</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="n">AbstractChannel</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">eventLoop</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">eventLoop</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">register0</span><span class="o">(</span><span class="n">promise</span><span class="o">);</span>    <span class="c1">//è¿™é‡Œæ˜¯ç»§ç»­è°ƒç”¨register0æ–¹æ³•åœ¨è¿›è¡Œæ³¨å†Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">  	<span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>ç»§ç»­ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">register0</span><span class="o">(</span><span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">firstRegistration</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">neverRegistered</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">AbstractChannel</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">doRegister</span><span class="o">();</span>    <span class="c1">//è¿™é‡Œå¼€å§‹æ‰§è¡ŒAbstractNioChannelä¸­çš„doRegisteræ–¹æ³•è¿›è¡Œæ³¨å†Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      	<span class="n">AbstractChannel</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">registered</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">AbstractChannel</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">pipeline</span><span class="o">.</span><span class="na">invokeHandlerAddedIfNeeded</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">safeSetSuccess</span><span class="o">(</span><span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      	<span class="k">if</span> <span class="o">(</span><span class="n">AbstractChannel</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">isActive</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">firstRegistration</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">AbstractChannel</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">pipeline</span><span class="o">.</span><span class="na">fireChannelActive</span><span class="o">();</span>   <span class="c1">//è¿™é‡Œæ˜¯å…³é”®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">AbstractChannel</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">config</span><span class="o">().</span><span class="na">isAutoRead</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="o">.</span><span class="na">beginRead</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>æ¥åˆ°æœ€åä¸€çº§ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doRegister</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">selected</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">          	<span class="c1">//å¯ä»¥çœ‹åˆ°åœ¨è¿™é‡Œç»ˆäºæ˜¯çœŸæ­£çš„è¿›è¡Œäº†æ³¨å†Œï¼ŒjavaChannel()å¾—åˆ°NIOçš„Channelå¯¹è±¡ï¼Œç„¶åè°ƒç”¨registeræ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          	<span class="c1">//è¿™é‡Œå°±å’Œæˆ‘ä»¬ä¹‹å‰NIOä¸€æ ·äº†ï¼Œå°†Channelæ³¨å†Œåˆ°Selectorä¸­ï¼Œå¯ä»¥çœ‹åˆ°Selectorä¹Ÿæ˜¯EventLoopä¸­çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          	<span class="c1">//ä½†æ˜¯æ³¨æ„ï¼Œè¿™é‡Œçš„opså‚æ•°æ˜¯0ï¼Œä¹Ÿå°±æ˜¯ä¸ç›‘å¬ä»»ä½•äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">this</span><span class="o">.</span><span class="na">selectionKey</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">javaChannel</span><span class="o">().</span><span class="na">register</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">eventLoop</span><span class="o">().</span><span class="na">unwrappedSelector</span><span class="o">(),</span> <span class="mi">0</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬å›åˆ°ä¸Šä¸€çº§ï¼Œåœ¨doRegisterå®Œæˆä¹‹åï¼Œä¼šæ‹¿åˆ°selectionKeyï¼Œä½†æ˜¯æ³¨æ„è¿™æ—¶è¿˜æ²¡æœ‰ç›‘å¬ä»»ä½•äº‹ä»¶ï¼Œæˆ‘ä»¬æ¥ç€çœ‹åˆ°ä¸‹é¢çš„fireChannelActiveæ–¹æ³•ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="nf">fireChannelActive</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AbstractChannelHandlerContext</span><span class="o">.</span><span class="na">invokeChannelActive</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">head</span><span class="o">);</span>   <span class="c1">//ä¼ çš„æ˜¯æµæ°´çº¿ä¸Šçš„é»˜è®¤å¤´ç»“ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">void</span> <span class="nf">invokeChannelActive</span><span class="o">(</span><span class="kd">final</span> <span class="n">AbstractChannelHandlerContext</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">EventExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">next</span><span class="o">.</span><span class="na">executor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">executor</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">next</span><span class="o">.</span><span class="na">invokeChannelActive</span><span class="o">();</span>   <span class="c1">//ç»§ç»­å‘ä¸‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">next</span><span class="o">.</span><span class="na">invokeChannelActive</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">invokeChannelActive</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">invokeHandler</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">((</span><span class="n">ChannelInboundHandler</span><span class="o">)</span><span class="k">this</span><span class="o">.</span><span class="na">handler</span><span class="o">()).</span><span class="na">channelActive</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>   <span class="c1">//ä¾ç„¶æ˜¯è°ƒç”¨çš„å¤´ç»“ç‚¹çš„channelActiveæ–¹æ³•è¿›è¡Œå¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">var2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">invokeExceptionCaught</span><span class="o">(</span><span class="n">var2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">fireChannelActive</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>   <span class="c1">//è¿™é‡Œæ˜¯å¤´ç»“ç‚¹çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ctx</span><span class="o">.</span><span class="na">fireChannelActive</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">readIfIsAutoRead</span><span class="o">();</span>   <span class="c1">//ç»§ç»­å‘ä¸‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">readIfIsAutoRead</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">DefaultChannelPipeline</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">channel</span><span class="o">.</span><span class="na">config</span><span class="o">().</span><span class="na">isAutoRead</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">DefaultChannelPipeline</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">channel</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>    <span class="c1">//ç»§ç»­ä¸æ–­å‘ä¸‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">read</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">unsafe</span><span class="o">.</span><span class="na">beginRead</span><span class="o">();</span>   <span class="c1">//æœ€åè¿™é‡Œä¼šè°ƒç”¨beginReadæ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">beginRead</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">assertEventLoop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">AbstractChannel</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">doBeginRead</span><span class="o">();</span>    <span class="c1">//è¿™é‡Œå°±æ˜¯è°ƒç”¨AbstractNioChannelçš„doBeginReadæ–¹æ³•äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="kd">final</span> <span class="n">Exception</span> <span class="n">var2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">invokeLater</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">AbstractChannel</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">pipeline</span><span class="o">.</span><span class="na">fireExceptionCaught</span><span class="o">(</span><span class="n">var2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">close</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">voidPromise</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doBeginRead</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">SelectionKey</span> <span class="n">selectionKey</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">selectionKey</span><span class="o">;</span>    <span class="c1">//å…ˆæ‹¿åˆ°ä¹‹å‰æ³¨å†Œå¥½çš„selectionKey
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">selectionKey</span><span class="o">.</span><span class="na">isValid</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">readPending</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">interestOps</span> <span class="o">=</span> <span class="n">selectionKey</span><span class="o">.</span><span class="na">interestOps</span><span class="o">();</span>   <span class="c1">//æŠŠç›‘å¬çš„æ“ä½œå–å‡ºæ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">((</span><span class="n">interestOps</span> <span class="o">&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">readInterestOp</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>    <span class="c1">//å¦‚æœæ²¡æœ‰ç›‘å¬ä»»ä½•æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">selectionKey</span><span class="o">.</span><span class="na">interestOps</span><span class="o">(</span><span class="n">interestOps</span> <span class="o">|</span> <span class="k">this</span><span class="o">.</span><span class="na">readInterestOp</span><span class="o">);</span>   <span class="c1">//é‚£å°±æŠŠreadInterestOpäº‹ä»¶è¿›è¡Œç›‘å¬ï¼Œè¿™é‡Œçš„readInterestOpå®é™…ä¸Šå°±æ˜¯OP_ACCEPT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>è¿™æ ·ï¼ŒChannelåœ¨åˆå§‹åŒ–å®Œæˆä¹‹åä¹Ÿå®Œæˆäº†åº•å±‚çš„æ³¨å†Œï¼Œå·²ç»å¯ä»¥å¼€å§‹ç­‰å¾…äº‹ä»¶äº†ã€‚</p>
<p>æˆ‘ä»¬ç°åœ¨å›åˆ°ä¹‹å‰çš„<code>doBind</code>æ–¹æ³•çš„æ³¨å†Œä½ç½®ï¼Œç°åœ¨æ³¨å†Œå®Œæˆä¹‹åï¼ŒåŸºæœ¬ä¸Šæ•´ä¸ªä¸»ä»Reactorç»“æ„å°±å·²ç»å‡ºæ¥äº†ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿˜è¦åšäº›ä»€ä¹ˆï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">ChannelFuture</span> <span class="nf">doBind</span><span class="o">(</span><span class="kd">final</span> <span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="n">regFuture</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">initAndRegister</span><span class="o">();</span>  <span class="c1">//ç›®å‰åˆå§‹åŒ–å’Œæ³¨å†Œéƒ½å·²ç»æˆåŠŸäº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">final</span> <span class="n">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">regFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>    <span class="c1">//ç”±äºæ˜¯å¼‚æ­¥æ“ä½œï¼Œæˆ‘ä»¬é€šè¿‡ChannelFutureæ‹¿åˆ°å¯¹åº”çš„ServerSocketChannelå¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">regFuture</span><span class="o">.</span><span class="na">cause</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">regFuture</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">regFuture</span><span class="o">.</span><span class="na">isDone</span><span class="o">())</span> <span class="o">{</span>   <span class="c1">//å¦‚æœè¯´åˆå§‹åŒ–å·²ç»å®Œæˆäº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ChannelPromise</span> <span class="n">promise</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">newPromise</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">doBind0</span><span class="o">(</span><span class="n">regFuture</span><span class="o">,</span> <span class="n">channel</span><span class="o">,</span> <span class="n">localAddress</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>   <span class="c1">//ç›´æ¥å¼€å§‹è¿›è¡Œè¿›ä¸€æ­¥çš„ç»‘å®š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">promise</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      	<span class="c1">//å¦‚æœè¿˜æ²¡æå®Œï¼Œé‚£å°±åˆ›Promisç»§ç»­ç­‰å¾…ä»»åŠ¡å®Œæˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">final</span> <span class="n">PendingRegistrationPromise</span> <span class="n">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PendingRegistrationPromise</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">regFuture</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelFutureListener</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">operationComplete</span><span class="o">(</span><span class="n">ChannelFuture</span> <span class="n">future</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Throwable</span> <span class="n">cause</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="na">cause</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">cause</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">promise</span><span class="o">.</span><span class="na">setFailure</span><span class="o">(</span><span class="n">cause</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">promise</span><span class="o">.</span><span class="na">registered</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="n">AbstractBootstrap</span><span class="o">.</span><span class="na">doBind0</span><span class="o">(</span><span class="n">regFuture</span><span class="o">,</span> <span class="n">channel</span><span class="o">,</span> <span class="n">localAddress</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">promise</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°æœ€åéƒ½ä¼šèµ°åˆ°<code>doBind0</code>æ–¹æ³•ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">doBind0</span><span class="o">(</span><span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="n">regFuture</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Channel</span> <span class="n">channel</span><span class="o">,</span> <span class="kd">final</span> <span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">,</span> <span class="kd">final</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  	<span class="c1">//æœ€åä¼šå‘Channelå·²ç»æ³¨å†Œåˆ°çš„EventLoopä¸­æäº¤ä¸€ä¸ªæ–°çš„ä»»åŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">channel</span><span class="o">.</span><span class="na">eventLoop</span><span class="o">().</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">regFuture</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">              	<span class="c1">//è¿™é‡Œæ‰æ˜¯çœŸæ­£è°ƒç”¨Channelåº•å±‚è¿›è¡Œç»‘å®šæ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">channel</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">localAddress</span><span class="o">,</span> <span class="n">promise</span><span class="o">).</span><span class="na">addListener</span><span class="o">(</span><span class="n">ChannelFutureListener</span><span class="o">.</span><span class="na">CLOSE_ON_FAILURE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">promise</span><span class="o">.</span><span class="na">setFailure</span><span class="o">(</span><span class="n">regFuture</span><span class="o">.</span><span class="na">cause</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>è‡³æ­¤ï¼ŒæœåŠ¡ç«¯çš„å¯åŠ¨æµç¨‹ç»“æŸã€‚æˆ‘ä»¬å‰é¢è¿˜æåˆ°äº†NIOçš„ç©ºè½®è¯¢é—®é¢˜ï¼Œè¿™é‡Œæˆ‘ä»¬æ¥çœ‹çœ‹Nettyæ˜¯å¦‚ä½•è§£å†³çš„ï¼Œæˆ‘ä»¬ç›´æ¥å®šä½åˆ°NioEventLoopä¸­ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//ç”±äºä»£ç å¤ªå¤šï¼Œè¿™é‡Œçœç•¥å¤§éƒ¨åˆ†ä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">var34</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        	<span class="o">...</span>
</span></span><span class="line"><span class="cl">                        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">hasTasks</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                                <span class="n">strategy</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">curDeadlineNanos</span><span class="o">);</span>   <span class="c1">//é¦–å…ˆä¼šåœ¨è¿™é‡Œè¿›è¡ŒSelector.select()æ“ä½œï¼Œè·ŸNIOæ˜¯ä¸€æ ·çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="o">}</span>
</span></span><span class="line"><span class="cl">           <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="o">++</span><span class="n">selectCnt</span><span class="o">;</span>    <span class="c1">//æ¯æ¬¡å”¤é†’éƒ½ä¼šè®©selectCntè‡ªå¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">this</span><span class="o">.</span><span class="na">cancelledKeys</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          	<span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(!</span><span class="n">ranTasks</span> <span class="o">&amp;&amp;</span> <span class="n">strategy</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">unexpectedSelectorWakeup</span><span class="o">(</span><span class="n">selectCnt</span><span class="o">))</span> <span class="o">{</span>   <span class="c1">//è¿™é‡Œä¼šè¿›è¡Œåˆ¤æ–­æ˜¯å¦å‡ºç°ç©ºè½®è¯¢BUG
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>           	<span class="o">...</span>
</span></span></code></pre></div><p>æˆ‘ä»¬æ¥çœ‹çœ‹æ˜¯æ€ä¹ˆè¿›è¡Œåˆ¤æ–­çš„ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">unexpectedSelectorWakeup</span><span class="o">(</span><span class="kt">int</span> <span class="n">selectCnt</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Selector.select() returned prematurely because Thread.currentThread().interrupt() was called. Use NioEventLoop.shutdownGracefully() to shutdown the NioEventLoop.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//å¦‚æœselectCntå¤§äºç­‰äºSELECTOR_AUTO_REBUILD_THRESHOLDï¼ˆé»˜è®¤ä¸º512ï¼‰é‚£ä¹ˆä¼šç›´æ¥é‡å»ºSelector
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">SELECTOR_AUTO_REBUILD_THRESHOLD</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">selectCnt</span> <span class="o">&gt;=</span> <span class="n">SELECTOR_AUTO_REBUILD_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;Selector.select() returned prematurely {} times in a row; rebuilding Selector {}.&#34;</span><span class="o">,</span> <span class="n">selectCnt</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">selector</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">rebuildSelector</span><span class="o">();</span>   <span class="c1">//å½“å‰çš„Selectorå‡ºç°BUGäº†ï¼Œå¾—é‡å»ºä¸€ä¸ªSelector
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>å®é™…ä¸Šï¼Œå½“æ¯æ¬¡ç©ºè½®è¯¢å‘ç”Ÿæ—¶ä¼šæœ‰ä¸“é—¨çš„è®¡æ•°å™¨+1ï¼Œå¦‚æœç©ºè½®è¯¢çš„æ¬¡æ•°è¶…è¿‡äº†512æ¬¡ï¼Œå°±è®¤ä¸ºå…¶è§¦å‘äº†ç©ºè½®è¯¢bugï¼Œè§¦å‘bugåï¼ŒNettyç›´æ¥é‡å»ºä¸€ä¸ªSelectorï¼Œå°†åŸæ¥çš„Channelé‡æ–°æ³¨å†Œåˆ°æ–°çš„ Selectorä¸Šï¼Œå°†æ—§çš„ Selectorå…³æ‰ï¼Œè¿™æ ·å°±é˜²æ­¢äº†æ— é™å¾ªç¯ã€‚</p>

        </div>
        
        

        
<details style="margin-left:0px" class="mt-2 mb-5 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5">
    
    <summary
        class="py-1 text-lg font-semibold cursor-pointer bg-primary-200 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-primary-800 dark:text-neutral-100">
        NIO&amp;Netty - è¿™æ˜¯ç³»åˆ—æ–‡ç« ä¹‹ä¸€.
    </summary>
    
    


</details>

        
  
  <section class="flex flex-row flex-wrap justify-center pt-4 text-xl">
    
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://twitter.com/intent/tweet/?url=/doc/netty/netty/&amp;text=Netty"
      title="åˆ†äº«åˆ° Twitter"
      aria-label="åˆ†äº«åˆ° Twitter"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://t.me/share/url?url=/doc/netty/netty/&amp;resubmit=true&amp;title=Netty"
      title=""
      aria-label=""
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M248,8C111.033,8,0,119.033,0,256S111.033,504,248,504,496,392.967,496,256,384.967,8,248,8ZM362.952,176.66c-3.732,39.215-19.881,134.378-28.1,178.3-3.476,18.584-10.322,24.816-16.948,25.425-14.4,1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25,5.342-39.5,3.652-3.793,67.107-61.51,68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608,69.142-14.845,10.194-26.894,9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7,18.45-13.7,108.446-47.248,144.628-62.3c68.872-28.647,83.183-33.623,92.511-33.789,2.052-.034,6.639.474,9.61,2.885a10.452,10.452,0,0,1,3.53,6.716A43.765,43.765,0,0,1,362.952,176.66Z"/></svg>

  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="mailto:?body=/doc/netty/netty/&amp;subject=Netty"
      title="é€šè¿‡ç”µå­é‚®ä»¶å‘é€"
      aria-label="é€šè¿‡ç”µå­é‚®ä»¶å‘é€"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1c-27.64 140.9 68.65 266.2 199.1 285.1c19.01 2.888 36.17-12.26 36.17-31.49l.0001-.6631c0-15.74-11.44-28.88-26.84-31.24c-84.35-12.98-149.2-86.13-149.2-174.2c0-102.9 88.61-185.5 193.4-175.4c91.54 8.869 158.6 91.25 158.6 183.2l0 16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98 .0036c-7.299 0-13.2 4.992-15.12 11.68c-24.85-12.15-54.24-16.38-86.06-5.106c-38.75 13.73-68.12 48.91-73.72 89.64c-9.483 69.01 43.81 128 110.9 128c26.44 0 50.43-9.544 69.59-24.88c24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3C495.1 107.1 361.2-9.332 207.8 20.73zM239.1 304.3c-26.47 0-48-21.56-48-48.05s21.53-48.05 48-48.05s48 21.56 48 48.05S266.5 304.3 239.1 304.3z"/></svg>

  </span>


    </a>
      
    
  </section>


        


<h2 class="mt-8 text-2xl font-extrabold mb-10">ç›¸å…³æ–‡ç« </h2>
<section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3">
  
  

  <a href="/doc/netty/nio/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/doc/netty/nio/featured_hufe02f02c45095c19eeba7c67a25e744e_445437_600x0_resize_q75_box.jpg);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/doc/netty/nio/">NIO</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  







  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="0001-01-01 00:00:00 &#43;0000 UTC">1 January 0001</time><span class="px-2 text-primary-500">&middot;</span><span title="é¢„è®¡é˜…è¯»">22 åˆ†é’Ÿ</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
  
  
</div>



        </div>

        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>
  
</section>

  
      </div>
     
      
      
        
        
      <script>
        var oid = "views_doc\\netty\\Netty\\index.md"
        var oid_likes = "likes_doc\\netty\\Netty\\index.md"
      </script>
      
      
      
      <script type="text/javascript" src="/js/page.min.b06a29d42a4ed16787978e2eee1e8c797b7698db2bc14ccee78f5c80ac566fc996190a73ad80a5e987558474b20b96fa38f7d85b405f165ff72b7b163c5ad11b.js" integrity="sha512-sGop1CpO0WeHl44u7h6MeXt2mNsrwUzO549cgKxWb8mWGQpzrYCl6YdVhHSyC5b6OPfYW0BfFl/3K3sWPFrRGw=="></script>
  
    </section>
  <footer class="pt-8 max-w-prose print:hidden">

    
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="flex group mr-3" href="/doc/netty/nio/">
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >NIO</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="0001-01-01 00:00:00 &#43;0000 UTC">1 January 0001</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="flex text-right group ml-3" href="/doc/mysql/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Mysql</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="0001-01-01 00:00:00 &#43;0000 UTC">1 January 0001</time>
                  
                </span>
              </span>
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
            </a>
          
        </span>
      </div>
    </div>
  


    
    
    <div class="pt-3">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="pt-3">
        















<br/>
<span style="color:rgba(var(--color-neutral-400),var(--tw-text-opacity));">
    <span class="post-meta-item-text" >&nbsp;&nbsp;:  </span>
    <span class="waline-pageview-count">â³</span><div></div><br/>
</span>






<script src='/waline/waline.js'></script>
<link href='/waline/waline.css' rel='stylesheet' />
<div id="vcomments"></div>
<script>
    if (""=="zh-CN") {
        Waline.init({
            el: '#vcomments',
            serverURL: 'https://comment-eosin.vercel.app/',
            emoji: ['https://valine-emoji.bili33.top/bilibilitv','https://valine-emoji.bili33.top/bilibiliHotKey','https://valine-emoji.bili33.top/Tieba-New','https://valine-emoji.bili33.top/weibo',],
            meta:['nick', 'mail', 'link'],
            pageview: true,
            reaction: true,
            lang: "zh-CN",
            locale: {
                reactionTitle: 'â€¢ç•…æ‰€æ¬²è¨€â€”â€”è¿™é‡Œæ˜¯å¼€æ”¾åŒºâ€¢',
                comment: 'ç•™è¨€æ¿',
                placeholder: 'ç‚¹å‡»ä¸‹æ–¹ç™»å½•åå†è¯„è®ºï¼Œä¼šæœ‰æƒŠå–œå“¦~',
                gifSearchPlaceholder: 'æœç´¢è¡¨æƒ…åŒ…...',
                admin: 'ä½œè€…',
                sofa: 'è¿˜æ²¡æœ‰äººè¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§',
                anonymous: 'åŒ¿åè€…'
            }
        });

    }
    else {
        Waline.init({
            el: '#vcomments',
            serverURL: 'https://comment-eosin.vercel.app/',
            emoji: ['https://valine-emoji.bili33.top/bilibilitv','https://valine-emoji.bili33.top/bilibiliHotKey','https://valine-emoji.bili33.top/Tieba-New','https://valine-emoji.bili33.top/weibo',],
            meta:['nick', 'mail'],
            pageview: true,
            reaction: true,
            
            lang: "zh-CN",
            locale: {
                reactionTitle: 'â€¢ç•…æ‰€æ¬²è¨€â€”â€”è¿™é‡Œæ˜¯å¼€æ”¾åŒºâ€¢',
                comment: 'ç•™è¨€æ¿',
                placeholder: 'ç‚¹å‡»ä¸‹æ–¹ç™»å½•åå†è¯„è®ºï¼Œä¼šæœ‰æƒŠå–œå“¦~',
                gifSearchPlaceholder: 'æœç´¢è¡¨æƒ…åŒ…...',
                admin: 'ä½œè€…',
                sofa: 'è¿˜æ²¡æœ‰äººè¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§',
                anonymous: 'åŒ¿åè€…'
            }
    });

    }
    document.getElementsByClassName('wl-power')[0].style.display = 'none';
    document.querySelector(".wl-actions a").style.display = 'none'
</script>
<style type="text/css">
    :root{
        --waline-color: var(--tw-prose-quotes);
        --waline-info-color: var(--tw-prose-quotes);
        --waline-info-bgcolor: var(--tw-ring-color);
        --waline-theme-color: rgba(var(--color-primary-400));
        --waline-bgcolor: transparent;
        --waline-border-color: #747474;
    }
    .wl-editor:focus, .wl-input:focus {
        background: transparent;
    }
    .wl-editor,.wl-input{
        max-width:88%;
    }
    .wl-reaction-item.active .wl-reaction-votes {
        color: white;
    }
</style>

<script type="text/javascript">
    var pagect = document.getElementById('pagec');
    var observer = new MutationObserver(function(){
        var itl,itll;
        var element = document.getElementById("pagec");
        observer.disconnect();
        itl  = element.innerText;
        itll = Number(itl).toLocaleString();
        document.getElementById('pagec').innerHTML = itll;
    });
    var article = document.getElementById('pagec');

    var options = {
        'childList': true,
        'subtree': true
    };

    observer.observe(article, options);
</script>

      </div>
    </div>
    
    
  </footer>
</article>

      <div id="top-scroller" class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0">
  <a href="#the-top"
    class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="å›åˆ°é¡¶éƒ¨" title="å›åˆ°é¡¶éƒ¨">
    &uarr;
  </a>
</div>
    </main>

<div class="busuanzi-footer" style="margin-top: 40px">
  <span id="busuanzi_container_site_pv">
    æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
  </span>
  <span id="busuanzi_container_site_uv">
    æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡
  </span>
</div><footer id="site-footer" class="py-10 print:hidden">
  
  
    
    <nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400">
      <ul class="flex flex-col list-none sm:flex-row">
        
        <li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
          <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href="/tags/"
            title="Tags">ç³»åˆ—æ–‡ç« </a>
        </li>
        
        <li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
          <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href="/tasks/"
            title="å­¦ä¹ è®¡åˆ’">äº‹é¡¹</a>
        </li>
        
        <li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
          <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href="/info/"
            title="åº”è¯¥æ²¡äººæ¥è¿™é‡Œå§">å…³äºæˆ‘</a>
        </li>
        
        <li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
          <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href="/doc/"
            title="Docs">æ–‡æ¡£</a>
        </li>
        
      </ul>
    </nav>
    
  
  <div class="flex items-center justify-between">

    
    
    <p class="text-sm text-neutral-500 dark:text-neutral-400">
      &copy;
      2024
      æ˜¥æ±ŸèŠ±æœç§‹æœˆå¤œ
    </p>
    

    
    
    <p class="text-xs text-neutral-500 dark:text-neutral-400">
      
      
      ç”± <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://blowfish.page/" target="_blank" rel="noopener noreferrer">Blowfish</a> å¼ºåŠ›é©±åŠ¨
    </p>
    

  </div>
  <script>
    
    mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
      margin: 24,
      background: 'rgba(0,0,0,0.5)',
      scrollOffset: 0,
    })
    
  </script>
  
  
  <script type="text/javascript" src="/js/process.min.62060bb247f4de2b6dde45903668fefb68d792f365587605177b1227c0cf43588701edaca0cb40e2c8e2789bd5ce67c1d2a215b9fb258c3496a7cd25e7cb5fdf.js" integrity="sha512-YgYLskf03itt3kWQNmj&#43;&#43;2jXkvNlWHYFF3sSJ8DPQ1iHAe2soMtA4sjieJvVzmfB0qIVufsljDSWp80l58tf3w=="></script>
  
  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]"
  data-url="/"
  style="z-index:500"
>
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"
  >
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="æœç´¢"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="å…³é—­ (Esc)"
      >
        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>


      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

  </div>
</body>

</html>
